<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Staff Job Detail | MG</title>
  <style>
    :root{--bg:#0b111b;--card:rgba(255,255,255,0.04);--accent:#00b4ff;--done:#22c55e;--text:#e2e8f0}
    *{box-sizing:border-box;font-family:'Poppins',sans-serif}
    body{background:var(--bg);color:var(--text);margin:0}
    header{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;background:rgba(255,255,255,0.03)}
    .logo{color:var(--accent);font-weight:700}
    .container{max-width:820px;margin:28px auto;padding:22px;background:var(--card);border-radius:12px}
    h1{color:var(--accent);margin:0 0 8px}
    .sub{color:#b9cfe6;margin-bottom:18px}
    .timeline{position:relative;padding-left:44px;border-left:3px solid rgba(0,180,255,0.12)}
    .stage{display:flex;align-items:flex-start;gap:12px;margin-bottom:18px}
    .dot{width:16px;height:16px;border-radius:50%;background:var(--accent);box-shadow:0 0 8px rgba(0,180,255,0.06);margin-top:4px}
    .dot.done{background:var(--done);box-shadow:0 0 10px rgba(34,197,94,0.12)}
    .stage .info{flex:1}
    .stage .info .title{font-weight:700;color:var(--accent)}
    .stage .info .hint{color:#cfe9ff;font-size:0.92rem;margin-top:6px}
    .buttons{margin-top:8px;display:flex;gap:10px}
    .mark{background:var(--accent);border:none;color:#fff;padding:6px 10px;border-radius:8px;cursor:pointer}
    .unmark{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff;padding:6px 10px;border-radius:8px;cursor:pointer}
    .back{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff;padding:8px 10px;border-radius:8px;cursor:pointer}
  </style>
</head>
<body>
  <header>
    <div class="logo">MG - Job</div>
    <div>
      <button id="backBtn" class="back">‚Üê Back</button>
    </div>
  </header>

  <div class="container">
    <h1 id="jobName">Loading...</h1>
    <div class="sub" id="jobType"></div>

    <div class="timeline" id="timeline"></div>
  </div>

  <script type="module">
    // Role protection
    const role = localStorage.getItem('loggedRole');
    if (!role) location.href = 'login.html';
    if (role !== 'staff' && role !== 'owner') location.href = 'login.html';

    const firebaseConfig = {
      apiKey: "AIzaSyC6BmLTjzOHwTa2VEYa9eYkClDtS__zvTM",
      authDomain: "mg-manager-3ab66.firebaseapp.com",
      projectId: "mg-manager-3ab66",
      storageBucket: "mg-manager-3ab66.appspot.com",
      messagingSenderId: "330667005987",
      appId: "1:330667005987:web:95de27b6259ace9fc6b996",
      measurementId: "G-05HW0KSN38"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";
    import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const jobId = localStorage.getItem('selectedJob');
    const jobNameEl = document.getElementById('jobName');
    const jobTypeEl = document.getElementById('jobType');
    const timelineEl = document.getElementById('timeline');
    const backBtn = document.getElementById('backBtn');

    backBtn.onclick = () => {
      // go back to staff jobs
      if (localStorage.getItem('loggedRole') === 'owner') location.href = 'dashboard.html';
      else location.href = 'staff-jobs.html';
    };

    if (!jobId) {
      jobNameEl.textContent = 'No job selected';
    }

    async function loadJob() {
      if (!jobId) return;
      const ref = doc(db, 'jobs', jobId);
      const snap = await getDoc(ref);
      if (!snap.exists()) {
        jobNameEl.textContent = 'Job not found';
        return;
      }
      const job = snap.data();
      jobNameEl.textContent = job.name || '';
      jobTypeEl.textContent = job.type || '';

      const cats = Array.isArray(job.categories) ? job.categories : (job.categories ? job.categories.map(n => ({ name: n, done: false })) : []);
      renderCategories(cats, ref);
    }

    function renderCategories(categories, refDoc) {
      timelineEl.innerHTML = '';
      categories.forEach((c, idx) => {
        const stage = document.createElement('div');
        stage.className = 'stage';
        const dot = document.createElement('div');
        dot.className = 'dot' + (c.done ? ' done' : '');
        const info = document.createElement('div');
        info.className = 'info';
        info.innerHTML = `<div class="title">${escapeHtml(c.name)}</div>
                          <div class="hint">Stage ${idx + 1}</div>`;
        const btnRow = document.createElement('div');
        btnRow.className = 'buttons';

        const markBtn = document.createElement('button');
        markBtn.className = 'mark';
        markBtn.textContent = 'Mark Done';
        const unmarkBtn = document.createElement('button');
        unmarkBtn.className = 'unmark';
        unmarkBtn.textContent = 'Not Yet Done';

        // Mark Done
        markBtn.onclick = async () => {
          categories[idx].done = true;
          // optimistic UI
          dot.classList.add('done');
          try { await updateDoc(refDoc, { categories }); }
          catch (e) { console.error(e); alert('Failed to update.'); }
        };

        // Unmark
        unmarkBtn.onclick = async () => {
          categories[idx].done = false;
          dot.classList.remove('done');
          try { await updateDoc(refDoc, { categories }); }
          catch (e) { console.error(e); alert('Failed to update.'); }
        };

        btnRow.appendChild(markBtn);
        btnRow.appendChild(unmarkBtn);
        info.appendChild(btnRow);

        stage.appendChild(dot);
        stage.appendChild(info);
        timelineEl.appendChild(stage);
      });
    }

    function escapeHtml(s){ if (!s && s !== 0) return ''; return String(s).replace(/[&<>"']/g,(m)=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }

    await loadJob();
  </script>
</body>
</html>
