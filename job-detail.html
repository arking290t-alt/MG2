<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Job Update | MG</title>

<style>
:root {
  --bg:#0b111b;
  --card:rgba(255,255,255,0.05);
  --accent:#00b4ff;
  --text:#e2e8f0;
  --panel:#0e1724;
  --done:#22c55e;
  --processing:#ffd400;
}

*{box-sizing:border-box;font-family:'Poppins',sans-serif;}
body{background:var(--bg);color:var(--text);margin:0;}

header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:15px 25px;
  background:rgba(255,255,255,0.05);
}

.logo{color:var(--accent);font-size:1.5rem;font-weight:700;}

.btn{
  background:var(--accent);
  border:none;
  color:white;
  padding:8px 14px;
  border-radius:8px;
  text-decoration:none;
  font-weight:600;
  cursor:pointer;
}

.container{
  max-width:750px;
  margin:40px auto;
  background:var(--card);
  padding:30px;
  border-radius:14px;
  box-shadow:0 8px 30px rgba(0,180,255,0.1);
}

h1{text-align:center;color:var(--accent);}

.timeline{
  margin-top:30px;
  position:relative;
  padding-left:40px;
}
.timeline::before{
  content:"";
  position:absolute;
  left:22px;top:0;bottom:0;
  width:2px;
  background:var(--accent);
}

.stage{
  display:flex;
  align-items:flex-start;
  margin-bottom:25px;
}

.dot{
  width:16px;
  height:16px;
  border-radius:50%;
  background:var(--accent);
  margin-right:14px;
  margin-top:4px;
}
.dot.done{background:var(--done);}
.dot.processing{background:var(--processing);}

.stage-content span{font-weight:600;color:var(--accent);}

.btn-row{display:flex;gap:8px;margin-top:6px;}

.btn-small{
  padding:5px 10px;
  font-size:.8rem;
  border-radius:6px;
  cursor:pointer;
  border:1px solid var(--accent);
  background:rgba(255,255,255,.05);
  color:var(--accent);
}
.btn-small.processing{border-color:var(--processing);color:var(--processing);}

/* NOTE BOX */
.note-box{
  margin-top:10px;
}
.note-box textarea{
  width:100%;
  min-height:60px;
  padding:8px;
  background:var(--panel);
  border:1px solid rgba(255,255,255,0.1);
  border-radius:8px;
  color:white;
  resize:vertical;
  font-size:0.9rem;
}
.save-note{
  margin-top:6px;
  padding:6px 12px;
  border-radius:6px;
  background:#22c55e;
  border:none;
  color:black;
  font-size:0.8rem;
  cursor:pointer;
}

.delivery-box{
  margin-top:40px;
  padding-top:20px;
  border-top:1px solid rgba(255,255,255,.15);
  text-align:right;
}
.delivery-box input{
  padding:6px 10px;
  border-radius:6px;
  border:1px solid var(--accent);
  background:var(--panel);
  color:white;
}
.saveDateBtn{
  background:var(--accent);
  padding:6px 12px;
  border:none;
  border-radius:6px;
  color:white;
  cursor:pointer;
}
</style>
</head>

<body>

<header>
  <div class="logo">MG</div>
  <a href="jobs.html" class="btn">‚Üê Back</a>
</header>

<div class="container">
  <h1>Job Update</h1>
  <h2 id="jobName"></h2>
  <p id="jobType"></p>

  <div class="timeline" id="categoryTimeline"></div>

  <div class="delivery-box">
    <h3 style="color:#00b4ff">Expected Delivery</h3>
    <div id="deliveryContent"></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC6BmLTjzOHwTa2VEYa9eYkClDtS__zvTM",
  authDomain: "mg-manager-3ab66.firebaseapp.com",
  projectId: "mg-manager-3ab66",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const jobId = localStorage.getItem("selectedJob");

const jobNameEl = document.getElementById("jobName");
const jobTypeEl = document.getElementById("jobType");
const categoryTimeline = document.getElementById("categoryTimeline");
const deliveryContent = document.getElementById("deliveryContent");

async function loadJob(){
  if(!jobId){
    categoryTimeline.innerHTML="<p>No job selected.</p>";
    return;
  }

  const ref = doc(db,"jobs",jobId);
  const snap = await getDoc(ref);

  if(!snap.exists()){
    categoryTimeline.innerHTML="<p>Job not found.</p>";
    return;
  }

  const job = snap.data();
  jobNameEl.textContent = job.name;
  jobTypeEl.textContent = job.type || "";

  // DELIVERY
  if(job.deliveryDate){
    deliveryContent.innerHTML = `<p>${job.deliveryDate}</p>`;
  } else {
    deliveryContent.innerHTML = `
      <input type="date" id="deliveryInput">
      <button class="saveDateBtn" id="saveDate">Save</button>
    `;
    document.getElementById("saveDate").onclick = async ()=>{
      const d=document.getElementById("deliveryInput").value;
      if(!d) return alert("Select date");
      await updateDoc(ref,{deliveryDate:d});
      loadJob();
    };
  }

  const categories = job.categories || [];
  categoryTimeline.innerHTML="";

  categories.forEach((c,i)=>{
    const div=document.createElement("div");
    div.className="stage";

    let cls="";
    if(c.status==="done") cls="done";
    if(c.status==="processing") cls="processing";

    div.innerHTML=`
      <div class="dot ${cls}"></div>
      <div class="stage-content" style="width:100%">
        <span>${c.name}</span>

        <div class="btn-row">
          <button class="btn-small" data-s="done">Done</button>
          <button class="btn-small processing" data-s="processing">Processing</button>
          <button class="btn-small" data-s="pending">Pending</button>
        </div>

        <!-- NOTE BOX -->
        <div class="note-box">
          <textarea placeholder="Type notes / instructions here...">${c.note || ""}</textarea>
          <button class="save-note">Save Note</button>
        </div>
      </div>
    `;

    // STATUS BUTTONS
    div.querySelectorAll(".btn-small").forEach(b=>{
      b.onclick=async()=>{
        const s=b.dataset.s;
        categories[i].status=s;
        await updateDoc(ref,{categories});
        loadJob();
      };
    });

    // SAVE NOTE
    const saveBtn = div.querySelector(".save-note");
    const textarea = div.querySelector("textarea");

    saveBtn.onclick = async ()=>{
      categories[i].note = textarea.value.trim();
      await updateDoc(ref,{categories});
      alert("Note saved");
    };

    categoryTimeline.appendChild(div);
  });
}

loadJob();
</script>

</body>
</html>
