<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Job Detail | MG</title>
  <style>
    :root {
      --bg:#0b111b;
      --card:rgba(255,255,255,0.05);
      --accent:#00b4ff;
      --text:#e2e8f0;
      --panel:#0e1724;
      --done:#22c55e;
    }
    *{box-sizing:border-box;font-family:'Poppins',sans-serif;}
    body{background:var(--bg);color:var(--text);margin:0;}
    header{display:flex;justify-content:space-between;align-items:center;padding:15px 25px;background:rgba(255,255,255,0.05);}
    .logo{color:var(--accent);font-size:1.5rem;font-weight:700;}
    .btn{background:var(--accent);border:none;color:white;padding:8px 14px;border-radius:8px;text-decoration:none;font-weight:600;cursor:pointer;}
    .container{max-width:700px;margin:40px auto;background:var(--card);padding:30px;border-radius:14px;box-shadow:0 8px 30px rgba(0,180,255,0.1);text-align:center;position:relative;}
    h1{color:var(--accent);margin-bottom:10px;}
    h2{color:var(--accent);margin-bottom:0;}
    p{margin-top:2px;color:#ccc;}
    .timeline{margin-top:30px;position:relative;padding-left:40px;text-align:left;}
    .timeline::before{content:"";position:absolute;left:22px;top:0;bottom:0;width:2px;background:var(--accent);}
    .stage{display:flex;align-items:center;margin-bottom:20px;position:relative;}
    .dot{width:16px;height:16px;border-radius:50%;background:var(--accent);margin-right:10px;transition:0.3s;}
    .dot.done{background:var(--done);}
    .stage-content{display:flex;flex-direction:column;}
    .stage-content span{font-weight:600;color:var(--accent);}
    .btn-row{margin-top:6px;}
    .mark-btn,.unmark-btn{
      background:rgba(255,255,255,0.05);
      border:1px solid var(--accent);
      color:var(--accent);
      padding:4px 10px;
      border-radius:6px;
      cursor:pointer;
      font-size:0.8rem;
      margin-right:5px;
    }
    .mark-btn:hover{background:var(--done);color:#fff;border-color:var(--done);}
    .unmark-btn:hover{background:rgba(255,255,255,0.08);}

    /* Delivery Date Box */
    .delivery-box{
      margin-top:40px;
      text-align:right;
      padding-top:20px;
      border-top:1px solid rgba(255,255,255,0.1);
    }
    .delivery-box input{
      padding:6px 10px;
      border-radius:6px;
      border:1px solid var(--accent);
      background:var(--panel);
      color:white;
    }
    .saveDateBtn{
      background:var(--accent);
      border:none;
      padding:6px 12px;
      color:white;
      border-radius:6px;
      cursor:pointer;
      margin-left:6px;
    }

  </style>
</head>
<body>

  <!-- HEADER -->
  <header id="ownerHeader">
    <div class="logo">MG</div>
    <div>
      <a href="jobs.html" class="btn">‚Üê Back</a>
      <button id="shareBtn" class="btn" style="margin-left:10px;">Share</button>
    </div>
  </header>

  <div class="container">
    <h1>Job Detail</h1>
    <h2 id="jobName"></h2>
    <p id="jobType"></p>

    <div class="timeline" id="categoryTimeline"></div>

    <!-- Expected Delivery Section -->
    <div class="delivery-box" id="deliverySection">
      <h3 style="color:var(--accent);margin-bottom:8px;">Expected Delivery</h3>
      <div id="deliveryContent"></div>
    </div>

  </div>

  <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC6BmLTjzOHwTa2VEYa9eYkClDtS__zvTM",
  authDomain: "mg-manager-3ab66.firebaseapp.com",
  projectId: "mg-manager-3ab66",
  storageBucket: "mg-manager-3ab66.appspot.com",
  messagingSenderId: "330667005987",
  appId: "1:330667005987:web:95de27b6259ace9fc6b996",
  measurementId: "G-05HW0KSN38"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// CUSTOMER OR OWNER VIEW CHECK
const urlParams = new URLSearchParams(window.location.search);
const sharedJobId = urlParams.get("job");
const jobId = sharedJobId || localStorage.getItem("selectedJob");
const isCustomer = sharedJobId ? true : false;

const jobNameEl = document.getElementById("jobName");
const jobTypeEl = document.getElementById("jobType");
const categoryTimeline = document.getElementById("categoryTimeline");
const ownerHeader = document.getElementById("ownerHeader");

if (isCustomer) ownerHeader.style.display = "none";

async function loadJob() {
  const docRef = doc(db, "jobs", jobId);
  const snap = await getDoc(docRef);

  if (!snap.exists()) {
    categoryTimeline.innerHTML = "<p>Job not found.</p>";
    return;
  }

  const job = snap.data();
  jobNameEl.textContent = job.name;
  jobTypeEl.textContent = job.type;

  const categories = job.categories || [];

  categoryTimeline.innerHTML = "";

  categories.forEach((cat, i) => {
    // Default old format support
    if (!cat.status) cat.status = cat.done ? "done" : "pending";

    const div = document.createElement("div");
    div.className = "stage";

    let dotColor = "var(--accent)"; // blue default
    if (cat.status === "done") dotColor = "var(--done)";
    if (cat.status === "processing") dotColor = "yellow";

    div.innerHTML = `
      <div class="dot" style="background:${dotColor};"></div>
      <div class="stage-content">
        <span>${cat.name}</span>
        <small>Category</small>

        ${
          isCustomer
            ? ""
            : `
          <div class="btn-row">
            <button class="mark-btn">Mark Done</button>
            <button class="process-btn" style="border-color:yellow;color:yellow;">Processing</button>
            <button class="unmark-btn">Not Yet Done</button>
          </div>
        `
        }
      </div>
    `;

    const dot = div.querySelector(".dot");

    if (!isCustomer) {
      const markBtn = div.querySelector(".mark-btn");
      const processBtn = div.querySelector(".process-btn");
      const unmarkBtn = div.querySelector(".unmark-btn");

      markBtn.onclick = async () => {
        categories[i].status = "done";
        dot.style.background = "var(--done)";
        await updateDoc(docRef, { categories });
      };

      processBtn.onclick = async () => {
        categories[i].status = "processing";
        dot.style.background = "yellow";
        await updateDoc(docRef, { categories });
      };

      unmarkBtn.onclick = async () => {
        categories[i].status = "pending";
        dot.style.background = "var(--accent)";
        await updateDoc(docRef, { categories });
      };
    }

    categoryTimeline.appendChild(div);
  });
}

loadJob();
</script>

</body>
</html>
