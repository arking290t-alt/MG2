<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Job Detail | MG</title>

  <style>
    :root {
      --bg:#0b111b;
      --card:rgba(255,255,255,0.05);
      --accent:#00b4ff;
      --text:#e2e8f0;
      --panel:#0e1724;
      --done:#22c55e;
      --processing: #ffd400;
    }

    *{box-sizing:border-box;font-family:'Poppins',sans-serif;}
    body{background:var(--bg);color:var(--text);margin:0;}

    header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:15px 25px;
      background:rgba(255,255,255,0.05);
    }

    .logo{color:var(--accent);font-size:1.5rem;font-weight:700;}

    .btn{
      background:var(--accent);
      border:none;
      color:white;
      padding:8px 14px;
      border-radius:8px;
      text-decoration:none;
      font-weight:600;
      cursor:pointer;
    }

    .container{
      max-width:700px;
      margin:40px auto;
      background:var(--card);
      padding:30px;
      border-radius:14px;
      box-shadow:0 8px 30px rgba(0,180,255,0.1);
      text-align:center;
    }

    h1{color:var(--accent);margin-bottom:10px;}
    h2{color:var(--accent);margin-bottom:0;}
    p{margin-top:2px;color:#ccc;}

    /* TIMELINE */
    .timeline{
      margin-top:30px;
      position:relative;
      padding-left:40px;
      text-align:left;
    }
    .timeline::before{
      content:"";
      position:absolute;
      left:22px;top:0;bottom:0;
      width:2px;
      background:var(--accent);
    }

    .stage{
      display:flex;
      align-items:center;
      margin-bottom:20px;
    }

    .dot{
      width:16px;
      height:16px;
      border-radius:50%;
      background:var(--accent);
      margin-right:14px;
      transition:0.3s;
    }

    .dot.done{background:var(--done);}
    .dot.processing{background:var(--processing);}

    .stage-content{display:flex;flex-direction:column;}
    .stage-content span{font-weight:600;color:var(--accent);}

    .btn-row{
      display:flex;
      gap:8px;
      margin-top:8px;
    }

    .btn-small{
      padding:5px 10px;
      font-size:0.8rem;
      border-radius:6px;
      cursor:pointer;
      border:1px solid var(--accent);
      background:rgba(255,255,255,0.05);
      color:var(--accent);
    }

    .btn-small.processing {
      border-color: var(--processing);
      color: var(--processing);
    }

    .btn-small:hover{opacity:0.8;}

    /* DELIVERY */
    .delivery-box{
      margin-top:40px;
      padding-top:20px;
      border-top:1px solid rgba(255,255,255,0.15);
      text-align:right;
    }

    .delivery-box input{
      padding:6px 10px;
      border-radius:6px;
      border:1px solid var(--accent);
      background:var(--panel);
      color:white;
    }

    .saveDateBtn{
      background:var(--accent);
      padding:6px 12px;
      border:none;
      border-radius:6px;
      color:white;
      cursor:pointer;
    }
  </style>
</head>

<body>

  <!-- HEADER -->
  <header id="ownerHeader">
    <div class="logo">MG</div>
    <div>
      <!-- ✅ BACK NOW GOES TO JOB UPDATE -->
      <a href="job-update.html" class="btn">← Back</a>
      <button id="shareBtn" class="btn" style="margin-left:10px;">Share</button>
    </div>
  </header>

  <div class="container">
    <h1>Job Detail</h1>
    <h2 id="jobName"></h2>
    <p id="jobType"></p>

    <div class="timeline" id="categoryTimeline"></div>

    <!-- Delivery Date -->
    <div class="delivery-box" id="deliverySection">
      <h3 style="color:var(--accent);margin-bottom:8px;">Expected Delivery</h3>
      <div id="deliveryContent"></div>
    </div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC6BmLTjzOHwTa2VEYa9eYkClDtS__zvTM",
  authDomain: "mg-manager-3ab66.firebaseapp.com",
  projectId: "mg-manager-3ab66",
  storageBucket: "mg-manager-3ab66.appspot.com",
  messagingSenderId: "330667005987",
  appId: "1:330667005987:web:95de27b6259ace9fc6b996",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// URL CHECK
const urlParams = new URLSearchParams(window.location.search);
const sharedJobId = urlParams.get("job");
const jobId = sharedJobId || localStorage.getItem("selectedJob");
const isCustomer = !!sharedJobId;

const jobNameEl = document.getElementById("jobName");
const jobTypeEl = document.getElementById("jobType");
const categoryTimeline = document.getElementById("categoryTimeline");
const ownerHeader = document.getElementById("ownerHeader");
const deliveryContent = document.getElementById("deliveryContent");

if (isCustomer) ownerHeader.style.display = "none";

// LOAD JOB
async function loadJob() {
  if (!jobId) {
    categoryTimeline.innerHTML = "<p>No job selected.</p>";
    return;
  }

  const docRef = doc(db, "jobs", jobId);
  const snap = await getDoc(docRef);

  if (!snap.exists()) {
    categoryTimeline.innerHTML = "<p>Job not found.</p>";
    return;
  }

  const job = snap.data();
  jobNameEl.textContent = job.name || "—";
  jobTypeEl.textContent = job.type || "—";

  /* DELIVERY */
  if (job.deliveryDate) {
    deliveryContent.innerHTML = `<p style="color:#fff;font-size:1rem;">${job.deliveryDate}</p>`;
  } else if (!isCustomer) {
    deliveryContent.innerHTML = `
      <input type="date" id="deliveryInput">
      <button class="saveDateBtn" id="saveDate">Save</button>
    `;
    document.getElementById("saveDate").onclick = async () => {
      const d = document.getElementById("deliveryInput").value;
      if (!d) return alert("Select a date");
      await updateDoc(docRef, { deliveryDate: d });
      loadJob();
    };
  } else {
    deliveryContent.innerHTML = "<p style='color:#aaa;'>No delivery date set</p>";
  }

  /* CATEGORIES */
  const categories = job.categories || [];
  categoryTimeline.innerHTML = "";

  categories.forEach((row, i) => {
    if (!row.status) row.status = row.done ? "done" : "pending";

    const div = document.createElement("div");
    div.className = "stage";

    let dotClass = "";
    if (row.status === "done") dotClass = "done";
    if (row.status === "processing") dotClass = "processing";

    div.innerHTML = `
      <div class="dot ${dotClass}"></div>
      <div class="stage-content">
        <span>${row.name}</span>
        <small>Category</small>

        ${
          isCustomer ? "" : `
          <div class="btn-row">
            <button class="btn-small" data-action="done">Done</button>
            <button class="btn-small processing" data-action="processing">Processing</button>
            <button class="btn-small" data-action="pending">Pending</button>
          </div>`
        }
      </div>
    `;

    const dot = div.querySelector(".dot");

    if (!isCustomer) {
      div.querySelectorAll(".btn-small").forEach(btn => {
        btn.onclick = async () => {
          const action = btn.dataset.action;
          categories[i].status = action;

          dot.className = "dot";
          if (action === "done") dot.classList.add("done");
          if (action === "processing") dot.classList.add("processing");

          await updateDoc(docRef, { categories });
        };
      });
    }

    categoryTimeline.appendChild(div);
  });
}

// SHARE BTN
document.getElementById("shareBtn").onclick = () => {
  const link = `${window.location.origin}${window.location.pathname}?job=${jobId}`;
  navigator.clipboard.writeText(link);
  alert("Share link copied!");
};

loadJob();
</script>

</body>
</html>
