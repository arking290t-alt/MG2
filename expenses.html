<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Expenses | MG</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header class="top-bar">
    <div class="logo">MG</div>
    <div>
      <a href="dashboard.html" class="btn-back">← Dashboard</a>
      <button id="logoutBtn" class="btn-logout">Logout</button>
    </div>
  </header>

  <div class="container">
    <h1>Expense Tracker</h1>

    <div class="controls">
      <div class="filter-group">
        <label>Category</label>
        <select id="categoryFilter"><option value="all">All Categories</option></select>
      </div>
      <div class="filter-group">
        <label>Time</label>
        <input type="month" id="timeFilter">
        <button id="clearTime" class="btn-back">Clear</button>
      </div>
    </div>

    <div id="expenseList" class="expense-list"></div>
    <div id="summaryText" class="summary">Total: ₹0</div>

    <div class="add-row">
      <input id="expenseName" type="text" placeholder="Expense name" />
      <input id="expenseAmount" type="number" placeholder="Amount ₹" />
      <select id="expenseCategory"></select>
      <input id="expenseDate" type="date" />
      <button id="addExpenseBtn" class="add-btn">Add Expense</button>
    </div>

    <div style="margin-top:20px;text-align:center" class="muted">
      Add category:
      <input id="newCategory" type="text" placeholder="New Category name" style="min-width:180px;margin-left:8px"/>
      <button id="addCategoryBtn" class="add-btn">Add Category</button>
    </div>

    <div class="category-section">
      <h3 style="color:#00b4ff;">Manage Categories</h3>
      <div id="categoryList" class="category-list"></div>
    </div>
  </div>

  <script type="module">
    const firebaseConfig = {
      apiKey: "AIzaSyC6BmLTjzOHwTa2VEYa9eYkClDtS__zvTM",
      authDomain: "mg-manager-3ab66.firebaseapp.com",
      projectId: "mg-manager-3ab66",
      storageBucket: "mg-manager-3ab66.firebasestorage.app",
      messagingSenderId: "330667005987",
      appId: "1:330667005987:web:95de27b6259ace9fc6b996",
      measurementId: "G-05HW0KSN38"
    };
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const expensesCol = collection(db, "expenses");
    const categoriesCol = collection(db, "categories");

    const logoutBtn = document.getElementById("logoutBtn");
    const expenseListEl = document.getElementById('expenseList');
    const categoryFilter = document.getElementById('categoryFilter');
    const timeFilter = document.getElementById('timeFilter');
    const clearTime = document.getElementById('clearTime');
    const expenseCategory = document.getElementById('expenseCategory');
    const summaryText = document.getElementById('summaryText');
    const categoryListEl = document.getElementById('categoryList');

    onAuthStateChanged(auth, user => { if (!user) location.href="login.html"; });

    logoutBtn.onclick = async () => { await signOut(auth); location.href="login.html"; };

    async function loadCategories() {
      categoryFilter.innerHTML = '<option value="all">All Categories</option>';
      expenseCategory.innerHTML = '';
      categoryListEl.innerHTML = '';
      const snaps = await getDocs(categoriesCol);
      const catArr = [];
      snaps.forEach(d => catArr.push(d.data().name));
      if (catArr.length === 0) {
        // seed default categories
        const defaults = ['Food','Travel','Bills','Other'];
        for (const c of defaults) await addDoc(categoriesCol, { name: c });
        return loadCategories();
      }
      catArr.forEach(c => {
        categoryFilter.innerHTML += `<option value="${c}">${c}</option>`;
        expenseCategory.innerHTML += `<option value="${c}">${c}</option>`;
        const div = document.createElement('div'); div.className = 'category-item';
        div.innerHTML = `${c} <button onclick="deleteCategory('${c}')">❌</button>`;
        categoryListEl.appendChild(div);
      });
    }

    async function renderExpenses() {
      expenseListEl.innerHTML = '';
      const snapshots = await getDocs(expensesCol);
      const arr = [];
      snapshots.forEach(d => arr.push({ id: d.id, ...d.data() }));
      const cat = categoryFilter.value;
      const time = timeFilter.value;
      const filtered = arr.filter(e => {
        const dt = new Date(e.date);
        const matchesCat = (cat === 'all') || (e.category === cat);
        const matchesTime = (!time) || (dt.getFullYear() === parseInt(time.split('-')[0]) && (dt.getMonth()+1) === parseInt(time.split('-')[1]));
        return matchesCat && matchesTime;
      });
      if (!filtered.length) expenseListEl.innerHTML = '<p style="text-align:center;color:#888">No expenses found</p>';
      else filtered.forEach(ex => {
        const div = document.createElement('div'); div.className='expense-item';
        div.innerHTML = `<div><strong>${ex.name}</strong><br><small>${ex.category} | ${ex.date.slice(0,10)}</small></div>
          <div style="display:flex;align-items:center;gap:10px;"><span class="amt">₹${ex.amount}</span>
          <button style="background:#ef4444;border:none;color:#fff;padding:5px 8px;border-radius:6px;cursor:pointer" onclick="deleteExpense('${ex.id}')">Delete</button></div>`;
        expenseListEl.appendChild(div);
      });
      const total = filtered.reduce((s,e)=> s + (e.amount||0), 0);
      summaryText.textContent = `Total: ₹${total}`;
    }

    document.getElementById('addExpenseBtn').onclick = async () => {
      const name = document.getElementById('expenseName').value.trim();
      const amt = parseFloat(document.getElementById('expenseAmount').value);
      const cat = document.getElementById('expenseCategory').value;
      const date = document.getElementById('expenseDate').value || new Date().toISOString().slice(0,10);
      if (!name || isNaN(amt)) return alert('Enter valid details!');
      await addDoc(expensesCol, { name, amount: amt, category: cat, date });
      document.getElementById('expenseName').value = '';
      document.getElementById('expenseAmount').value = '';
      await renderExpenses();
    };

    async function deleteExpense(id) {
      if (!confirm('Delete this expense?')) return;
      await deleteDoc(doc(db, "expenses", id));
      await renderExpenses();
    }

    document.getElementById('addCategoryBtn').onclick = async () => {
      const val = document.getElementById('newCategory').value.trim();
      if (!val) return alert('Enter category');
      await addDoc(categoriesCol, { name: val });
      document.getElementById('newCategory').value = '';
      await loadCategories();
    };

    window.deleteCategory = async function(name) {
      if (!confirm(`Delete category "${name}"?`)) return;
      // find category doc by name and delete
      const snaps = await getDocs(categoriesCol);
      for (const d of snaps.docs) {
        if (d.data().name === name) await deleteDoc(doc(db, "categories", d.id));
      }
      await loadCategories();
      await renderExpenses();
    };

    categoryFilter.onchange = renderExpenses;
    timeFilter.onchange = renderExpenses;
    clearTime.onclick = () => { timeFilter.value = ''; renderExpenses(); };

    // initial
    await loadCategories();
    await renderExpenses();
  </script>
</body>
</html>
