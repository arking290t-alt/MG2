<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MG Inventory</title>

  <style>
    body { 
      background:#0b111b;
      color:white; 
      font-family:Poppins, sans-serif;
    }

    .inv-container {
      background: rgba(255,255,255,0.05);
      padding: 20px;
      border-radius: 15px;
      margin: auto;
      width: 95%;
      max-width: 1200px;
      margin-top: 20px;
    }

    .section-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: #00b4ff;
      margin-bottom: 15px;
      text-align: left;
    }

    .row { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px; }

    .input-box {
      flex: 1;
      min-width: 200px;
      display: flex;
      flex-direction: column;
    }

    .input-box label {
      font-size: 0.85rem;
      color: #9ab;
      margin-bottom: 5px;
    }

    .input-box input,
    .input-box select {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.1);
      background: rgba(255,255,255,0.08);
      color: white;
      width: 100%;
      outline: none;
    }

    #addItemBtn {
      width: 100%;
      padding: 12px;
      background:#00b4ff;
      border:none;
      border-radius:10px;
      font-size:1rem;
      font-weight:600;
      margin-top:10px;
      cursor:pointer;
    }

    .cat-box {
      background: rgba(0,0,0,0.3);
      padding:15px;
      border-radius:12px;
      margin-top:25px;
    }

    .cat-item {
      display:flex;
      justify-content:space-between;
      padding:10px;
      background:rgba(255,255,255,0.08);
      border-radius:8px;
      margin-top:5px;
    }

    .delete-btn {
      background:red;
      border:none;
      color:white;
      padding:5px 12px;
      border-radius:6px;
      cursor:pointer;
    }

    .inventory-item {
      background: rgba(255,255,255,0.06);
      padding: 15px;
      margin-top: 12px;
      border-radius: 12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    .actions { margin-top:10px; display:flex; gap:10px; }

    .btn {
      padding:7px 15px;
      border-radius:6px;
      border:none;
      cursor:pointer;
      color:white;
      font-weight:600;
    }

    .btn-view { background:#3b82f6; }
    .btn-edit { background:#facc15; color:black; }
    .btn-delete { background:#ef4444; }

    .filter-row { display:flex; gap:15px; flex-wrap:wrap; margin-top:20px; }

    /* POPUPS */
    .modal-bg {
      position:fixed;
      top:0; left:0; right:0; bottom:0;
      background:rgba(0,0,0,0.7);
      display:none;
      justify-content:center;
      align-items:flex-end;
      padding-bottom:40px;
    }

    .modal-box {
      width:90%;
      max-width:450px;
      background:#111827;
      padding:20px;
      border-radius:14px;
      animation:slideUp .25s ease-out;
    }

    @keyframes slideUp {
      from { transform:translateY(50px); opacity:0; }
      to { transform:translateY(0); opacity:1; }
    }

    .modal-box h2 {
      color:#00b4ff;
      margin-bottom:15px;
      text-align:center;
    }

    .modal-row {
      display:flex;
      flex-direction:column;
      margin-bottom:15px;
    }

    .modal-row label { 
      margin-bottom:5px; 
      font-size:0.9rem;
      color:#9ab;
    }

    .modal-row input {
      padding:10px;
      background:#1f2937;
      color:white;
      border:1px solid #333;
      border-radius:8px;
    }

    .modal-actions { display:flex; justify-content:space-between; margin-top:15px; }

    .btn-save { background:#00b4ff; }
    .btn-cancel { background:#444; }
  </style>
</head>

<body>

<h1 style="text-align:center; color:#00b4ff; margin-top:20px;">MG Inventory</h1>

<div class="inv-container">

  <!-- TITLE -->
  <div class="section-title">Inventory Management</div>

  <!-- INPUT ROWS -->
  <div class="row">
    <div class="input-box">
      <label>Item Name</label>
      <input id="itemName">
    </div>

    <div class="input-box">
      <label>Quantity</label>
      <input id="quantity" type="number">
    </div>

    <div class="input-box">
      <label>Unit</label>
      <select id="unit">
        <option value="PCS">PCS</option>
        <option value="KGS">KGS</option>
      </select>
    </div>
  </div>

  <div class="row">
    <div class="input-box">
      <label>Purchase Price (₹)</label>
      <input id="price" type="number">
    </div>

    <div class="input-box">
      <label>Invoice Number</label>
      <input id="invoice">
    </div>

    <div class="input-box">
      <label>Reel Number</label>
      <input id="reel">
    </div>
  </div>

  <div class="row">
    <div class="input-box">
      <label>Supplier</label>
      <input id="supplier">
    </div>

    <div class="input-box">
      <label>GSM</label>
      <input id="gsm" type="number">
    </div>

    <div class="input-box">
      <label>BF</label>
      <input id="bf" type="number">
    </div>
  </div>

  <div class="row">
    <div class="input-box">
      <label>Date</label>
      <input id="date" type="date">
    </div>

    <div class="input-box">
      <label>Select Category</label>
      <select id="categorySelect"></select>
    </div>
  </div>

  <button id="addItemBtn">Add Item</button>

  <!-- CATEGORY MANAGER -->
  <div class="section-title" style="margin-top:30px;">Manage Categories</div>

  <div class="cat-box">
    <div class="row">
      <div class="input-box">
        <label>New Category</label>
        <input id="newCategoryName">
      </div>
      <button class="btn" style="background:#00b4ff; height:45px; margin-top:22px;" id="addCategoryBtn">
        Add Category
      </button>
    </div>

    <div id="categoryList"></div>
  </div>

  <!-- FILTERS -->
  <div class="section-title" style="margin-top:25px;">Filter Inventory</div>

  <div class="filter-row">
    <select id="filterCategory" style="flex:1;">
      <option value="all">All Categories</option>
    </select>

    <select id="filterItemName" style="flex:1;">
      <option value="all">All Items</option>
    </select>

    <input id="filterDate" type="date" style="flex:1;">
    
    <button class="btn btn-delete" id="clearFilters">Clear</button>
  </div>

  <!-- INVENTORY LIST -->
  <div id="inventoryList" style="margin-top:20px;"></div>

</div>

<!-- USED POPUP (B STYLE) -->
<div class="modal-bg" id="usedModal">
  <div class="modal-box">
    <h2>Use Item</h2>

    <div class="modal-row">
      <label>Used Quantity</label>
      <input id="usedQty">
    </div>

    <div class="modal-row">
      <label>Used For</label>
      <input id="usedFor">
    </div>

    <div class="modal-actions">
      <button class="btn btn-save" id="confirmUse">Save</button>
      <button class="btn btn-cancel" onclick="closeUsed()">Cancel</button>
    </div>
  </div>
</div>

<script type="module">

/* FIREBASE */
import { 
  initializeApp 
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";

import {
  getFirestore, collection, addDoc, getDocs,
  deleteDoc, doc, updateDoc
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC6BmLTjzOHwTa2VEYa9eYkClDtS__zvTM",
  authDomain: "mg-manager-3ab66.firebaseapp.com",
  projectId: "mg-manager-3ab66",
  storageBucket: "mg-manager-3ab66.firebasestorage.app",
  messagingSenderId: "330667005987",
  appId: "1:330667005987:web:95de27b6259ace9fc6b996",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* DOM */
const itemName = document.getElementById("itemName");
const quantity = document.getElementById("quantity");
const unit = document.getElementById("unit");
const price = document.getElementById("price");
const invoice = document.getElementById("invoice");
const reel = document.getElementById("reel");
const supplier = document.getElementById("supplier");
const gsm = document.getElementById("gsm");
const bf = document.getElementById("bf");
const dateInput = document.getElementById("date");
const categorySelect = document.getElementById("categorySelect");

const addItemBtn = document.getElementById("addItemBtn");

const newCategoryName = document.getElementById("newCategoryName");
const addCategoryBtn = document.getElementById("addCategoryBtn");
const categoryList = document.getElementById("categoryList");

const filterCategory = document.getElementById("filterCategory");
const filterItemName = document.getElementById("filterItemName");
const filterDate = document.getElementById("filterDate");
const clearFilters = document.getElementById("clearFilters");

const inventoryList = document.getElementById("inventoryList");

/* USED POPUP */
let currentUsedItem = null;
const usedModal = document.getElementById("usedModal");
const usedQty = document.getElementById("usedQty");
const usedFor = document.getElementById("usedFor");
const confirmUse = document.getElementById("confirmUse");

function openUsed(id) {
  currentUsedItem = id;
  usedModal.style.display = "flex";
}

function closeUsed() {
  usedModal.style.display = "none";
}

/* LOAD CATEGORIES */
async function loadCategories() {
  categorySelect.innerHTML = "";
  filterCategory.innerHTML = `<option value="all">All Categories</option>`;
  categoryList.innerHTML = "";

  const snap = await getDocs(collection(db, "inventoryCategories"));
  snap.forEach(docu => {
    const cat = docu.data().name;

    categorySelect.innerHTML += `<option value="${cat}">${cat}</option>`;
    filterCategory.innerHTML += `<option value="${cat}">${cat}</option>`;

    categoryList.innerHTML += `
      <div class="cat-item">
        <span>${cat}</span>
        <button class="delete-btn" onclick="deleteCategory('${docu.id}')">Delete</button>
      </div>
    `;
  });
}

window.deleteCategory = async function (id) {
  if (!confirm("Delete this category?")) return;
  await deleteDoc(doc(db, "inventoryCategories", id));
  loadCategories();
};

/* ADD CATEGORY */
addCategoryBtn.onclick = async () => {
  const name = newCategoryName.value.trim();
  if (!name) return;

  await addDoc(collection(db, "inventoryCategories"), { name });
  newCategoryName.value = "";
  loadCategories();
};

/* ADD ITEM */
addItemBtn.onclick = async () => {
  const data = {
    name: itemName.value,
    qty: Number(quantity.value),
    unit: unit.value,
    price: Number(price.value),
    invoice: invoice.value,
    reel: reel.value,
    supplier: supplier.value,
    gsm: gsm.value,
    bf: bf.value,
    date: dateInput.value,
    category: categorySelect.value,
  };

  await addDoc(collection(db, "inventory"), data);

  itemName.value = "";
  quantity.value = "";
  price.value = "";
  invoice.value = "";
  reel.value = "";
  supplier.value = "";
  gsm.value = "";
  bf.value = "";
  dateInput.value = "";

  loadInventory();
};

/* LOAD INVENTORY */
async function loadInventory() {
  inventoryList.innerHTML = "";
  filterItemName.innerHTML = `<option value="all">All Items</option>`;

  const snap = await getDocs(collection(db, "inventory"));
  let items = [];

  snap.forEach(d => items.push({ id: d.id, ...d.data() }));

  if (filterCategory.value !== "all") {
    items = items.filter(i => i.category === filterCategory.value);
  }

  if (filterItemName.value !== "all") {
    items = items.filter(i => i.name === filterItemName.value);
  }

  if (filterDate.value) {
    items = items.filter(i => i.date === filterDate.value);
  }

  const allNames = [...new Set(items.map(i => i.name))];
  allNames.forEach(n => {
    filterItemName.innerHTML += `<option value="${n}">${n}</option>`;
  });

  if (items.length === 0) {
    inventoryList.innerHTML = `<p style="text-align:center; opacity:0.7;">No items found.</p>`;
    return;
  }

  items.forEach(item => {
    const amount = Number(item.qty) * Number(item.price);

    inventoryList.innerHTML += `
      <div class="inventory-item">

        <div>
          <h3>${item.name}</h3>
          <p>Qty: ${item.qty} ${item.unit}</p>
          <p>Date: ${item.date}</p>
          <p>Category: ${item.category}</p>

          <div class="actions">
            <button class="btn btn-view" onclick="viewItem('${item.id}')">View</button>
            <button class="btn btn-edit" onclick="editItem('${item.id}')">Edit</button>
            <button class="btn btn-delete" onclick="deleteItem('${item.id}')">Delete</button>
            <button class="btn btn-view" onclick="openUsed('${item.id}')">Used</button>
          </div>
        </div>

        <div style="
          text-align:right;
          font-size:1.2rem;
          font-weight:700;
          color:#00b4ff;
          min-width:110px;
        ">
          ₹${amount}
        </div>

      </div>
    `;
  });
}

/* DELETE ITEM */
window.deleteItem = async function (id) {
  if (!confirm("Delete this item?")) return;
  await deleteDoc(doc(db, "inventory", id));
  loadInventory();
};

/* VIEW */
window.viewItem = function (id) {
  alert("View popup coming soon (UI already ready).");
};

/* EDIT */
window.editItem = function (id) {
  alert("Edit popup coming soon.");
};

/* SAVE USED ITEM */
confirmUse.onclick = async () => {
  if (!currentUsedItem) return;

  const qtyToUse = Number(usedQty.value);
  const usedReason = usedFor.value.trim();

  const snap = await getDocs(collection(db, "inventory"));
  let itemData = null;
  let docId = null;

  snap.forEach(d => {
    if (d.id === currentUsedItem) {
      itemData = d.data();
      docId = d.id;
    }
  });

  if (!itemData) return;

  const remaining = itemData.qty - qtyToUse;

  await addDoc(collection(db, "inventoryUsed"), {
    ...itemData,
    usedQty: qtyToUse,
    usedFor: usedReason,
    usedDate: new Date().toISOString().slice(0,10)
  });

  if (remaining <= 0) {
    await deleteDoc(doc(db, "inventory", docId));
  } else {
    await updateDoc(doc(db, "inventory", docId), { qty: remaining });
  }

  closeUsed();
  usedQty.value = "";
  usedFor.value = "";
  currentUsedItem = null;

  loadInventory();
};

/* CLEAR FILTERS */
clearFilters.onclick = () => {
  filterCategory.value = "all";
  filterItemName.value = "all";
  filterDate.value = "";
  loadInventory();
};

loadCategories();
loadInventory();

</script>

</body>
</html>
