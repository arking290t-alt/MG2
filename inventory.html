<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Inventory | MG</title>
  <style>
    /* ---------- BASICS ---------- */
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');
    :root{
      --bg:#0b111b; --panel:rgba(255,255,255,0.04); --accent:#00b4ff; --muted:#9fb6d4;
      --card: rgba(255,255,255,0.05);
      --danger:#ef4444; --success:#22c55e; --yellow:#facc15;
    }
    *{box-sizing:border-box;font-family:'Poppins',sans-serif}
    body{background:radial-gradient(circle at 20% 30%, #101821, #070c12);color:#e6eef6;margin:0;padding:18px 12px;}
    h1{color:var(--accent);text-align:center;margin:6px 0 18px;}

    /* ---------- CONTAINER ---------- */
    .inv-container{max-width:1100px;margin:0 auto;background:var(--panel);padding:22px;border-radius:14px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 20px 60px rgba(0,0,0,0.6);}
    .section-title{color:var(--accent);font-weight:700;font-size:1.2rem;margin:8px 0 12px;}

    /* ---------- ROWS & INPUTS ---------- */
    .row{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px}
    .input-box{flex:1;min-width:180px;display:flex;flex-direction:column}
    .input-box label{font-size:0.85rem;color:var(--muted);margin-bottom:6px}
    .input-box input,.input-box select{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:#e6eef6;outline:none}
    .input-box input:focus,.input-box select:focus{box-shadow:0 0 10px rgba(0,180,255,0.08);border-color:var(--accent)}

    #addItemBtn{background:var(--accent);color:#022; padding:12px;border-radius:10px;border:none;font-weight:700;cursor:pointer;width:100%;margin-top:6px}

    /* ---------- CATEGORY BOX ---------- */
    .cat-box{background:rgba(0,0,0,0.25);padding:14px;border-radius:12px;margin-top:12px}
    .cat-item{display:flex;justify-content:space-between;align-items:center;padding:10px;background:rgba(255,255,255,0.03);border-radius:8px;margin-top:8px}

    .delete-btn{background:var(--danger);color:white;border:none;padding:6px 10px;border-radius:8px;cursor:pointer}

    /* ---------- FILTERS ---------- */
    .filter-row{display:flex;gap:12px;flex-wrap:wrap;margin-top:18px;align-items:center}
    .filter-row .small{flex:1;min-width:160px}

    .btn-clear{background:var(--danger);color:white;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}

    /* ---------- LIST ---------- */
    #inventoryList{margin-top:16px}
    .inventory-item{background:rgba(255,255,255,0.03);padding:16px;border-radius:12px;margin-bottom:12px}
    .inventory-item h3{margin:0 0 6px}
    .inventory-item p{margin:4px 0;color:#d7e7f6}
    .actions{display:flex;gap:10px;margin-top:10px}
    .btn{padding:8px 14px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
    .btn-view{background:#3b82f6;color:white}
    .btn-edit{background:var(--yellow);color:black}
    .btn-used{background:#10b981;color:white}
    .btn-delete{background:var(--danger);color:white}

    /* ---------- MODALS ---------- */
    .overlay{position:fixed;inset:0;background:rgba(3,7,12,0.6);display:none;align-items:center;justify-content:center;z-index:1000}
    .modal{background:linear-gradient(180deg, rgba(15,22,27,0.98), rgba(10,14,18,0.98));padding:18px;border-radius:12px;min-width:320px;max-width:780px;color:#eaf6ff;box-shadow:0 20px 60px rgba(0,0,0,0.6);border:1px solid rgba(0,180,255,0.06)}
    .modal h2{margin-top:0;color:var(--accent)}
    .modal .row{margin-bottom:10px}
    .modal .actions{justify-content:flex-end}
    .modal .btn-close{background:#444;color:white;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;margin-right:8px}

    /* small screens */
    @media (max-width:700px){
      .modal{width:92%;padding:14px}
    }
  </style>
</head>
<body>

  <h1>MG Inventory</h1>

  <div class="inv-container">

    <!-- INVENTORY FORM -->
    <div class="section-title">Inventory Management</div>

    <div class="row">
      <div class="input-box"><label>Item Name</label><input id="itemName" placeholder="Item name"></div>
      <div class="input-box"><label>Quantity</label><input id="quantity" type="number" placeholder="0"></div>
      <div class="input-box"><label>Unit</label>
        <select id="unit">
          <option value="PCS">PCS</option>
          <option value="KGS">KGS</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div class="input-box"><label>Purchase Price (₹)</label><input id="price" type="number" placeholder="0"></div>
      <div class="input-box"><label>Invoice Number</label><input id="invoice" placeholder=""></div>
      <div class="input-box"><label>Reel Number</label><input id="reel" placeholder=""></div>
    </div>

    <div class="row">
      <div class="input-box"><label>Supplier</label><input id="supplier"></div>
      <div class="input-box"><label>GSM</label><input id="gsm" type="number"></div>
      <div class="input-box"><label>BF</label><input id="bf" type="number"></div>
    </div>

    <div class="row">
      <div class="input-box"><label>Date</label><input id="date" type="date"></div>
      <div class="input-box"><label>Select Category</label><select id="categorySelect"></select></div>
    </div>

    <button id="addItemBtn">Add Item</button>

    <!-- CATEGORY MANAGER -->
    <div class="section-title" style="margin-top:20px">Manage Categories</div>
    <div class="cat-box">
      <div class="row">
        <div class="input-box"><label>New Category</label><input id="newCategoryName" placeholder="Category name"></div>
        <div style="align-self:flex-end">
          <button id="addCategoryBtn" class="btn" style="background:var(--accent);color:#022;padding:10px 14px;border-radius:10px">Add Category</button>
        </div>
      </div>

      <div id="categoryList"></div>
    </div>

    <!-- FILTERS -->
    <div class="section-title" style="margin-top:18px">Filter Inventory</div>
    <div class="filter-row">
      <select id="filterCategory" class="small"><option value="all">All Categories</option></select>
      <select id="filterItemName" class="small"><option value="all">All Items</option></select>
      <input id="filterDate" type="date" class="small">
      <button id="clearFilters" class="btn-clear">Clear</button>
    </div>

    <!-- LIST -->
    <div id="inventoryList"></div>

  </div>

  <!-- MODALS -->
  <!-- Overlay used for all modals -->
  <div id="overlay" class="overlay"></div>

  <!-- VIEW MODAL -->
  <div id="viewModal" class="modal" style="display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:1100;">
    <h2>Item Details</h2>
    <div id="viewContent"></div>
    <div style="display:flex;justify-content:flex-end;margin-top:12px">
      <button class="btn-close" onclick="closeModal('viewModal')">Close</button>
    </div>
  </div>

  <!-- EDIT MODAL -->
  <div id="editModal" class="modal" style="display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:1100;">
    <h2>Edit Item</h2>
    <div id="editForm"></div>
    <div style="display:flex;justify-content:flex-end;margin-top:12px">
      <button class="btn-close" onclick="closeModal('editModal')">Cancel</button>
      <button id="saveEditBtn" class="btn" style="background:var(--accent);color:#022;margin-left:10px">Save Changes</button>
    </div>
  </div>

  <!-- USED MODAL -->
  <div id="usedModal" class="modal" style="display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:1100;">
    <h2>Use Item — <span id="usedItemName"></span></h2>
    <div style="margin-top:8px">
      <div class="row">
        <div class="input-box"><label>Used Quantity</label><input id="usedQty" type="number" placeholder="Enter quantity used"></div>
        <div class="input-box"><label>Unit</label><select id="usedUnit"><option>PCS</option><option>KGS</option></select></div>
      </div>

      <div class="row">
        <div class="input-box" style="flex:1"><label>Used For (description)</label><input id="usedFor" placeholder="What is this used for?"></div>
        <div class="input-box" style="flex:1"><label>Used At</label><input id="usedAt" type="datetime-local"></div>
      </div>

    </div>

    <div style="display:flex;justify-content:flex-end;margin-top:12px">
      <button class="btn-close" onclick="closeModal('usedModal')">Cancel</button>
      <button id="saveUsedBtn" class="btn" style="background:#10b981;color:white;margin-left:10px">Save Used</button>
    </div>
  </div>

  <!-- FIREBASE + APP JS -->
  <script type="module">
    // ---------- FIREBASE SETUP ----------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs, deleteDoc,
      doc, updateDoc, getDoc, query, where, orderBy
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC6BmLTjzOHwTa2VEYa9eYkClDtS__zvTM",
      authDomain: "mg-manager-3ab66.firebaseapp.com",
      projectId: "mg-manager-3ab66",
      storageBucket: "mg-manager-3ab66.firebasestorage.app",
      messagingSenderId: "330667005987",
      appId: "1:330667005987:web:95de27b6259ace9fc6b996",
      measurementId: "G-05HW0KSN38"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ---------- DOM ----------
    const itemName = document.getElementById('itemName');
    const quantity = document.getElementById('quantity');
    const unit = document.getElementById('unit');
    const price = document.getElementById('price');
    const invoice = document.getElementById('invoice');
    const reel = document.getElementById('reel');
    const supplier = document.getElementById('supplier');
    const gsm = document.getElementById('gsm');
    const bf = document.getElementById('bf');
    const dateInput = document.getElementById('date');
    const categorySelect = document.getElementById('categorySelect');
    const addItemBtn = document.getElementById('addItemBtn');

    const newCategoryName = document.getElementById('newCategoryName');
    const addCategoryBtn = document.getElementById('addCategoryBtn');
    const categoryList = document.getElementById('categoryList');

    const filterCategory = document.getElementById('filterCategory');
    const filterItemName = document.getElementById('filterItemName');
    const filterDate = document.getElementById('filterDate');
    const clearFilters = document.getElementById('clearFilters');

    const inventoryList = document.getElementById('inventoryList');

    // modals
    const overlay = document.getElementById('overlay');
    const viewModal = document.getElementById('viewModal');
    const viewContent = document.getElementById('viewContent');

    const editModal = document.getElementById('editModal');
    const editForm = document.getElementById('editForm');
    const saveEditBtn = document.getElementById('saveEditBtn');

    const usedModal = document.getElementById('usedModal');
    const usedItemName = document.getElementById('usedItemName');
    const usedQty = document.getElementById('usedQty');
    const usedUnit = document.getElementById('usedUnit');
    const usedFor = document.getElementById('usedFor');
    const usedAt = document.getElementById('usedAt');
    const saveUsedBtn = document.getElementById('saveUsedBtn');

    // internal state
    let currentEditId = null;
    let currentUsedId = null;

    // ---------- UTIL ----------
    function showOverlay(){ overlay.style.display='flex'; }
    function hideOverlay(){ overlay.style.display='none'; }
    function openModal(modal){ modal.style.display='block'; showOverlay(); }
    function closeModalByEl(modal){ modal.style.display='none'; hideOverlay(); }
    function closeModal(id){
      const el = document.getElementById(id);
      if(el) el.style.display='none';
      hideOverlay();
    }

    // ---------- CATEGORIES ----------
    async function loadCategories(){
      categorySelect.innerHTML = '<option value="">Select Category</option>';
      filterCategory.innerHTML = '<option value="all">All Categories</option>';
      categoryList.innerHTML = '';

      const snap = await getDocs(collection(db, 'inventoryCategories'));
      snap.forEach(s => {
        const name = s.data().name;
        categorySelect.innerHTML += `<option value="${name}">${name}</option>`;
        filterCategory.innerHTML += `<option value="${name}">${name}</option>`;
        categoryList.innerHTML += `
          <div class="cat-item">
            <div style="font-weight:600;color:#e7f6ff">${name}</div>
            <button class="delete-btn" onclick="confirmDeleteCategory('${s.id}','${name}')">Delete</button>
          </div>
        `;
      });
    }

    window.confirmDeleteCategory = async (id,name) => {
      if(!confirm(\`Delete category "\${name}"? This will not delete items.\`)) return;
      await deleteDoc(doc(db,'inventoryCategories',id));
      await loadCategories();
      loadInventory();
    };

    addCategoryBtn.onclick = async () => {
      const name = newCategoryName.value.trim();
      if(!name) return alert('Enter category name');
      await addDoc(collection(db,'inventoryCategories'),{ name });
      newCategoryName.value='';
      loadCategories();
    };

    // ---------- ADD ITEM ----------
    addItemBtn.onclick = async () => {
      const data = {
        name: itemName.value.trim() || 'Untitled',
        qty: Number(quantity.value) || 0,
        unit: unit.value || 'PCS',
        price: Number(price.value) || 0,
        invoice: invoice.value || '',
        reel: reel.value || '',
        supplier: supplier.value || '',
        gsm: gsm.value || '',
        bf: bf.value || '',
        date: dateInput.value || new Date().toISOString().slice(0,10),
        category: categorySelect.value || ''
      };

      await addDoc(collection(db,'inventory'), data);

      // clear
      itemName.value=''; quantity.value=''; price.value=''; invoice.value=''; reel.value=''; supplier.value=''; gsm.value=''; bf.value=''; dateInput.value='';

      loadInventory();
    };

    // ---------- LOAD INVENTORY ----------
    async function loadInventory(){
      inventoryList.innerHTML = '';
      filterItemName.innerHTML = '<option value="all">All Items</option>';

      const snap = await getDocs(collection(db,'inventory'));
      let items = [];
      snap.forEach(d => items.push({ id:d.id, ...d.data() }));

      // build item name filter from ALL items (not only filtered subset)
      const allNames = [...new Set(items.map(i=>i.name))];
      allNames.forEach(n => filterItemName.innerHTML += `<option value="${n}">${n}</option>`);

      // APPLY FILTERS
      if(filterCategory.value && filterCategory.value !== 'all'){
        items = items.filter(it => it.category === filterCategory.value);
      }
      if(filterItemName.value && filterItemName.value !== 'all'){
        items = items.filter(it => it.name === filterItemName.value);
      }
      if(filterDate.value){
        items = items.filter(it => it.date === filterDate.value);
      }

      if(items.length === 0){
        inventoryList.innerHTML = '<p style="opacity:0.7;text-align:center;margin-top:12px">No items found.</p>';
        return;
      }

      // render
      items.forEach(it => {
        const html = document.createElement('div');
        html.className = 'inventory-item';
        html.innerHTML = `
          <h3>${escapeHtml(it.name)}</h3>
          <p>Qty: ${it.qty} ${escapeHtml(it.unit || '')}</p>
          <p>Date: ${escapeHtml(it.date || '')}</p>
          <p>Category: ${escapeHtml(it.category || '')}</p>
          <div class="actions">
            <button class="btn btn-view" onclick="viewItem('${it.id}')">View</button>
            <button class="btn btn-edit" onclick="openEdit('${it.id}')">Edit</button>
            <button class="btn btn-used" onclick="openUsed('${it.id}')">Used</button>
            <button class="btn btn-delete" onclick="confirmDeleteItem('${it.id}','${escapeJs(it.name)}')">Delete</button>
          </div>
        `;
        inventoryList.appendChild(html);
      });

    }

    // ---------- VIEW ITEM ----------
    window.viewItem = async function(id){
      const snap = await getDoc(doc(db,'inventory',id));
      if(!snap.exists()) return alert('Item not found');
      const d = snap.data();

      viewContent.innerHTML = `
        <div style="display:flex;gap:14px;flex-wrap:wrap">
          <div style="flex:1;min-width:220px">
            <strong>Name</strong><div style="margin-top:6px">${escapeHtml(d.name)}</div>
            <strong style="margin-top:8px">Invoice</strong><div style="margin-top:6px">${escapeHtml(d.invoice)}</div>
            <strong style="margin-top:8px">Reel</strong><div style="margin-top:6px">${escapeHtml(d.reel)}</div>
            <strong style="margin-top:8px">Supplier</strong><div style="margin-top:6px">${escapeHtml(d.supplier)}</div>
          </div>
          <div style="flex:1;min-width:220px">
            <strong>GSM</strong><div style="margin-top:6px">${escapeHtml(d.gsm)}</div>
            <strong style="margin-top:8px">BF</strong><div style="margin-top:6px">${escapeHtml(d.bf)}</div>
            <strong style="margin-top:8px">Qty</strong><div style="margin-top:6px">${d.qty} ${escapeHtml(d.unit || '')}</div>
            <strong style="margin-top:8px">Price</strong><div style="margin-top:6px">₹${escapeHtml(String(d.price || 0))}</div>
            <strong style="margin-top:8px">Category</strong><div style="margin-top:6px">${escapeHtml(d.category)}</div>
            <strong style="margin-top:8px">Date</strong><div style="margin-top:6px">${escapeHtml(d.date)}</div>
          </div>
        </div>
      `;

      viewModal.style.display='block';
      showOverlay();
    };

    // ---------- EDIT ITEM ----------
    window.openEdit = async function(id){
      const snap = await getDoc(doc(db,'inventory',id));
      if(!snap.exists()) return alert('Item not found for edit');
      const d = snap.data();
      currentEditId = id;

      editForm.innerHTML = `
        <div class="row">
          <div class="input-box"><label>Name</label><input id="edit_name" value="${escapeHtmlAttr(d.name)}"></div>
          <div class="input-box"><label>Invoice</label><input id="edit_invoice" value="${escapeHtmlAttr(d.invoice)}"></div>
        </div>
        <div class="row">
          <div class="input-box"><label>Reel</label><input id="edit_reel" value="${escapeHtmlAttr(d.reel)}"></div>
          <div class="input-box"><label>Supplier</label><input id="edit_supplier" value="${escapeHtmlAttr(d.supplier)}"></div>
        </div>
        <div class="row">
          <div class="input-box"><label>GSM</label><input id="edit_gsm" value="${escapeHtmlAttr(d.gsm)}"></div>
          <div class="input-box"><label>BF</label><input id="edit_bf" value="${escapeHtmlAttr(d.bf)}"></div>
        </div>
        <div class="row">
          <div class="input-box"><label>Qty</label><input id="edit_qty" type="number" value="${escapeHtmlAttr(String(d.qty || 0))}"></div>
          <div class="input-box"><label>Unit</label>
            <select id="edit_unit">
              <option ${d.unit==='PCS'?'selected':''}>PCS</option>
              <option ${d.unit==='KGS'?'selected':''}>KGS</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div class="input-box"><label>Price</label><input id="edit_price" type="number" value="${escapeHtmlAttr(String(d.price || 0))}"></div>
          <div class="input-box"><label>Category</label>
            <select id="edit_category"></select>
          </div>
        </div>
        <div class="row">
          <div class="input-box"><label>Date</label><input id="edit_date" type="date" value="${escapeHtmlAttr(d.date || '')}"></div>
        </div>
      `;
      // populate categories in edit form
      const catSel = document.getElementById('edit_category');
      const catsSnap = await getDocs(collection(db,'inventoryCategories'));
      catsSnap.forEach(c => {
        const n = c.data().name;
        const opt = document.createElement('option');
        opt.value = n;
        opt.textContent = n;
        if(n === d.category) opt.selected = true;
        catSel.appendChild(opt);
      });

      editModal.style.display='block';
      showOverlay();
    };

    saveEditBtn.onclick = async () => {
      if(!currentEditId) return;
      const updated = {
        name: document.getElementById('edit_name').value.trim(),
        invoice: document.getElementById('edit_invoice').value.trim(),
        reel: document.getElementById('edit_reel').value.trim(),
        supplier: document.getElementById('edit_supplier').value.trim(),
        gsm: document.getElementById('edit_gsm').value.trim(),
        bf: document.getElementById('edit_bf').value.trim(),
        qty: Number(document.getElementById('edit_qty').value) || 0,
        unit: document.getElementById('edit_unit').value,
        price: Number(document.getElementById('edit_price').value) || 0,
        category: document.getElementById('edit_category').value,
        date: document.getElementById('edit_date').value || new Date().toISOString().slice(0,10)
      };
      await updateDoc(doc(db,'inventory',currentEditId), updated);
      currentEditId = null;
      closeModal('editModal');
      loadInventory();
    };

    // ---------- USED ITEM ----------
    window.openUsed = async function(id){
      // Directly open used modal (no confirm)
      const snap = await getDoc(doc(db,'inventory',id));
      if(!snap.exists()) return alert('Item not found');
      const d = snap.data();
      currentUsedId = id;
      usedItemName.textContent = d.name;
      usedQty.value = '';
      usedUnit.value = d.unit || 'PCS';
      usedFor.value = '';
      // default usedAt now
      usedAt.value = new Date().toISOString().slice(0,16);
      usedModal.style.display='block';
      showOverlay();
    };

    saveUsedBtn.onclick = async () => {
      if(!currentUsedId) return;
      const usedQuantity = Number(usedQty.value) || 0;
      // No blocking if usedQuantity > available — user said "don't stop"
      const usedDataSnap = await getDoc(doc(db,'inventory',currentUsedId));
      if(!usedDataSnap.exists()) return alert('Item not found');

      const original = usedDataSnap.data();

      // create used record
      const usedRecord = {
        inventoryId: currentUsedId,
        name: original.name,
        usedQty: usedQuantity,
        unit: usedUnit.value,
        usedFor: usedFor.value || '',
        usedAt: usedAt.value || new Date().toISOString(),
        originalQty: original.qty || 0,
        originalDate: original.date || '',
        category: original.category || '',
        invoice: original.invoice || '',
        reel: original.reel || '',
        supplier: original.supplier || '',
        gsm: original.gsm || '',
        bf: original.bf || '',
        price: original.price || 0
      };

      // save used record
      await addDoc(collection(db,'inventoryUsed'), usedRecord);

      // remove original inventory doc (user wanted item removed from inventory when used)
      await deleteDoc(doc(db,'inventory',currentUsedId));

      currentUsedId = null;
      closeModal('usedModal');
      loadInventory();
      // Optional: you may want to refresh used list if you have used inventory page
    };

    // ---------- DELETE WITH CONFIRM ----------
    window.confirmDeleteItem = async (id,name) => {
      if(!confirm(\`Delete "\${name}" permanently?\`)) return;
      await deleteDoc(doc(db,'inventory',id));
      loadInventory();
    };

    // ---------- FILTERS ----------
    clearFilters.onclick = () => {
      filterCategory.value = 'all';
      filterItemName.value = 'all';
      filterDate.value = '';
      loadInventory();
    };

    filterCategory.onchange = loadInventory;
    filterItemName.onchange = loadInventory;
    filterDate.onchange = loadInventory;

    // ---------- UTIL ESCAPE (prevent breaking HTML) ----------
    function escapeHtml(s){
      if(s === undefined || s === null) return '';
      return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;');
    }
    function escapeHtmlAttr(s){ return escapeHtml(s).replaceAll("'",'&#39;'); }
    function escapeJs(s){ return String(s).replaceAll("'", "\\'"); }

    // ---------- INITIAL LOAD ----------
    await loadCategories();
    await loadInventory();

    // overlay click closes modals
    overlay.onclick = () => {
      // close any open modals
      if(viewModal.style.display==='block') closeModal('viewModal');
      if(editModal.style.display==='block') closeModal('editModal');
      if(usedModal.style.display==='block') closeModal('usedModal');
    };

    // expose closeModal to global scope for inline close buttons
    window.closeModal = (id) => {
      const el = document.getElementById(id);
      if(el) el.style.display='none';
      hideOverlay();
    };

  </script>
</body>
</html>
