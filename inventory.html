<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Inventory | MG</title>
<style>
  :root{
    --bg:#0b111b;--panel:#0e1724;--accent:#00b4ff;--danger:#ef4444;--muted:#9aa9b6;color: #e2e8f0;
  }
  body{background:var(--bg);color:var(--muted);font-family:Poppins, sans-serif;padding:20px;margin:0;}
  h1{color:var(--accent);text-align:center;margin-bottom:18px;font-size:2rem}
  .top-actions{display:flex;gap:10px;justify-content:center;margin-bottom:14px}
  .small-btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
  .view-used{background:#0ea5a0;color:#041014}
  .back-btn{background:#0ea5a0;color:#041014}
  .container{max-width:1100px;margin:0 auto;padding:18px;background:rgba(255,255,255,0.02);border-radius:12px}
  /* grid form */
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:12px}
  .full-row{grid-column:1/-1}
  input,select{width:100%;padding:10px;border-radius:8px;background:#10151a;border:1px solid rgba(255,255,255,0.06);color:var(--muted);outline:none}
  select option{background:#10151a;color:var(--muted)}
  .add-btn{background:var(--accent);color:#021022;padding:10px;border-radius:8px;border:none;font-weight:700;cursor:pointer;width:100%}
  .section-title{color:var(--accent);font-size:1.2rem;margin-top:12px;margin-bottom:8px}
  .filters{display:flex;gap:12px;align-items:center;margin-top:12px;margin-bottom:12px}
  .item-list{margin-top:14px}
  .item-card{background:#0f1417;padding:14px;border-radius:8px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center;border:1px solid rgba(255,255,255,0.03);color:#cfe7ff}
  .item-left{line-height:1.4}
  .item-actions{display:flex;gap:8px;align-items:center}
  .btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
  .btn-view{background:#60a5fa;color:#041014}
  .btn-used{background:#3b82f6;color:#fff}
  .btn-edit{background:#ffd400;color:#041014}
  .btn-delete{background:var(--danger);color:#fff}
  /* modal */
  .modal-back{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:9999}
  .modal{background:#0f1720;padding:18px;border-radius:10px;width:420px;color:var(--muted);box-shadow:0 10px 40px rgba(0,0,0,0.6)}
  .modal h3{color:var(--accent);margin:0 0 12px}
  .modal .field{margin-bottom:8px}
  .modal input, .modal select{width:100%;padding:8px;border-radius:6px;background:#0b1115;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
  .modal .row{display:flex;gap:8px}
  .modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
  .muted-small{color:#9aa9b6;font-size:0.9rem}
  @media (max-width:860px){
    .grid{grid-template-columns:repeat(2,1fr)}
    .container{padding:12px}
    .modal{width:90%}
  }
  @media (max-width:520px){
    .grid{grid-template-columns:1fr}
  }
</style>
</head>
<body>

<h1>Inventory Management</h1>
<div class="top-actions">
  <a href="inventory-used.html"><button class="small-btn view-used">Used Inventory</button></a>
  <a href="dashboard.html"><button class="small-btn back-btn">Back</button></a>
</div>

<div class="container">
  <!-- ADD ITEM FORM (3-column compact) -->
  <div class="grid">
    <input id="itemName" placeholder="Item Name" />
    <input id="invoice" placeholder="Invoice Number" />
    <input id="reel" placeholder="Reel Number" />

    <input id="supplier" placeholder="Supplier" />
    <input id="gsm" type="number" placeholder="GSM" />
    <input id="bf" type="number" placeholder="BF" />

    <input id="qty" type="number" placeholder="Quantity" />
    <select id="unit">
      <option value="PCS">PCS</option>
      <option value="KGS">KGS</option>
    </select>
    <input id="price" type="number" placeholder="Purchase Price (₹)" />

    <input id="date" type="date" />
    <select id="category" class="full-row"></select>
  </div>

  <button id="addItem" class="add-btn">Add Item</button>

  <!-- categories -->
  <div class="section-title">Manage Categories</div>
  <div style="display:flex;gap:8px;margin-bottom:10px">
    <input id="newCat" placeholder="New Category name" />
    <button id="addCat" class="add-btn" style="width:160px">Add Category</button>
  </div>
  <div id="categoryList" style="margin-bottom:12px"></div>

  <!-- filters -->
  <div class="section-title">Filter Inventory</div>
  <div class="filters">
    <select id="filterCat" style="width:220px">
      <option value="all">All Categories</option>
    </select>
    <input id="filterDate" type="month" />
  </div>

  <!-- inventory list -->
  <div class="item-list" id="inventoryList"></div>
</div>

<!-- MODAL (view/edit) -->
<div class="modal-back" id="modalBack">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <h3 id="modalTitle">Item Details</h3>

    <div class="field"><label class="muted-small">Item Name</label><input id="m_itemName" /></div>
    <div class="field"><label class="muted-small">Invoice Number</label><input id="m_invoice" /></div>
    <div class="field"><label class="muted-small">Reel Number</label><input id="m_reel" /></div>
    <div class="field"><label class="muted-small">Supplier</label><input id="m_supplier" /></div>
    <div class="field"><label class="muted-small">GSM</label><input id="m_gsm" type="number" /></div>
    <div class="field"><label class="muted-small">BF</label><input id="m_bf" type="number" /></div>
    <div class="field"><label class="muted-small">Quantity</label><input id="m_qty" type="number" /></div>
    <div class="field"><label class="muted-small">Unit</label>
      <select id="m_unit"><option>PCS</option><option>KGS</option></select>
    </div>
    <div class="field"><label class="muted-small">Purchase Price (₹)</label><input id="m_price" type="number" /></div>
    <div class="field"><label class="muted-small">Category</label><select id="m_category"></select></div>
    <div class="field"><label class="muted-small">Date</label><input id="m_date" type="date" /></div>

    <div class="actions">
      <button id="modalClose" class="btn" style="background:#333;color:#fff">Close</button>
      <button id="modalSave" class="btn" style="background:var(--accent);color:#021022">Save Changes</button>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
  import {
    getFirestore, collection, addDoc, getDocs,
    deleteDoc, doc, updateDoc, query, where, orderBy
  } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC6BmLTjzOHwTa2VEYa9eYkClDtS__zvTM",
    authDomain: "mg-manager-3ab66.firebaseapp.com",
    projectId: "mg-manager-3ab66",
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // Elements
  const itemName = document.getElementById('itemName');
  const invoice = document.getElementById('invoice');
  const reel = document.getElementById('reel');
  const supplier = document.getElementById('supplier');
  const gsm = document.getElementById('gsm');
  const bf = document.getElementById('bf');
  const qty = document.getElementById('qty');
  const unit = document.getElementById('unit');
  const price = document.getElementById('price');
  const dateEl = document.getElementById('date');
  const category = document.getElementById('category');

  const newCat = document.getElementById('newCat');
  const categoryList = document.getElementById('categoryList');

  const filterCat = document.getElementById('filterCat');
  const filterDate = document.getElementById('filterDate');
  const inventoryList = document.getElementById('inventoryList');

  const modalBack = document.getElementById('modalBack');
  const modalSave = document.getElementById('modalSave');
  const modalClose = document.getElementById('modalClose');

  // modal fields
  const m_itemName = document.getElementById('m_itemName');
  const m_invoice = document.getElementById('m_invoice');
  const m_reel = document.getElementById('m_reel');
  const m_supplier = document.getElementById('m_supplier');
  const m_gsm = document.getElementById('m_gsm');
  const m_bf = document.getElementById('m_bf');
  const m_qty = document.getElementById('m_qty');
  const m_unit = document.getElementById('m_unit');
  const m_price = document.getElementById('m_price');
  const m_category = document.getElementById('m_category');
  const m_date = document.getElementById('m_date');

  let currentModalId = null;

  // Load categories
  async function loadCategories(){
    category.innerHTML = '<option value="">Select Category</option>';
    filterCat.innerHTML = '<option value="all">All Categories</option>';
    m_category.innerHTML = '';
    categoryList.innerHTML = '';

    const snap = await getDocs(collection(db, "inventoryCategories"));
    snap.forEach(d=>{
      const n = d.data().name;
      category.innerHTML += `<option value="${n}">${n}</option>`;
      filterCat.innerHTML += `<option value="${n}">${n}</option>`;
      m_category.innerHTML += `<option value="${n}">${n}</option>`;

      const row = document.createElement('div');
      row.className = 'item-card';
      row.innerHTML = `${n} <button class="btn btn-delete" onclick="confirmDeleteCategory('${d.id}')">Delete</button>`;
      categoryList.appendChild(row);
    });
  }

  // Add category
  document.getElementById('addCat').onclick = async ()=>{
    const val = newCat.value.trim();
    if(!val) return alert('Enter category name');
    await addDoc(collection(db,'inventoryCategories'),{name:val});
    newCat.value = '';
    loadCategories();
  };

  window.confirmDeleteCategory = async (id)=>{
    if(!confirm('Delete this category?')) return;
    await deleteDoc(doc(db,'inventoryCategories',id));
    loadCategories();
  };

  // Add item
  document.getElementById('addItem').onclick = async ()=>{
    const data = {
      name:itemName.value.trim(),
      invoice:invoice.value.trim(),
      reel:reel.value.trim(),
      supplier:supplier.value.trim(),
      gsm: gsm.value ? Number(gsm.value) : null,
      bf: bf.value ? Number(bf.value) : null,
      qty: qty.value ? Number(qty.value) : 0,
      unit: unit.value,
      price: price.value ? Number(price.value) : 0,
      date: dateEl.value,
      category: category.value
    };

    if(!data.name) return alert('Enter item name');
    if(!data.qty || !data.price || !data.date || !data.category) return alert('Fill required fields (qty, price, date, category)');

    await addDoc(collection(db,'inventory'), data);

    // reset
    itemName.value=''; invoice.value=''; reel.value=''; supplier.value=''; gsm.value=''; bf.value=''; qty.value=''; price.value=''; dateEl.value=''; category.value='';

    loadItems();
  };

  // Load items (only show minimal fields in list)
  async function loadItems(){
    inventoryList.innerHTML = '';
    const catFilter = filterCat.value;
    const monthFilter = filterDate.value; // YYYY-MM

    const snap = await getDocs(collection(db, 'inventory'));
    // we will show items whose qty > 0
    snap.forEach(d=>{
      const it = d.data();
      if(!it) return;
      if(typeof it.qty === 'undefined') return;
      if(Number(it.qty) <= 0) return;

      // filter
      if(catFilter && catFilter !== 'all' && it.category !== catFilter) return;
      if(monthFilter && (!it.date || !it.date.startsWith(monthFilter))) return;

      // build minimal card
      const card = document.createElement('div');
      card.className = 'item-card';

      const left = document.createElement('div');
      left.className = 'item-left';
      left.innerHTML = `<strong style="color:#fff">${it.name}</strong><br>
                        Qty: ${it.qty} ${it.unit || 'PCS'}<br>
                        Date: ${it.date || '-'}<br>
                        Category: ${it.category || '-'}`;

      const actions = document.createElement('div');
      actions.className = 'item-actions';

      const viewBtn = document.createElement('button');
      viewBtn.className = 'btn btn-view';
      viewBtn.innerText = 'View';
      viewBtn.onclick = ()=> openModal(d.id);

      const usedBtn = document.createElement('button');
      usedBtn.className = 'btn btn-used';
      usedBtn.innerText = 'Used';
      usedBtn.onclick = ()=> useItemPrompt(d.id, it.qty, it.unit || 'PCS', it.name);

      const editBtn = document.createElement('button');
      editBtn.className = 'btn btn-edit';
      editBtn.innerText = 'Edit';
      editBtn.onclick = ()=> openModal(d.id); // same modal used for edit

      const delBtn = document.createElement('button');
      delBtn.className = 'btn btn-delete';
      delBtn.innerText = 'Delete';
      delBtn.onclick = ()=> confirmDeleteItem(d.id);

      actions.appendChild(viewBtn);
      actions.appendChild(usedBtn);
      actions.appendChild(editBtn);
      actions.appendChild(delBtn);

      card.appendChild(left);
      card.appendChild(actions);
      inventoryList.appendChild(card);
    });
  }

  // Open modal (view/edit)
  async function openModal(id){
    currentModalId = id;
    // load item
    const snap = await getDocs(collection(db,'inventory'));
    let found = null;
    snap.forEach(d=>{ if(d.id === id) found = { id:d.id, data:d.data() };});
    if(!found) return alert('Item not found');

    const it = found.data;

    // fill modal fields
    m_itemName.value = it.name || '';
    m_invoice.value = it.invoice || '';
    m_reel.value = it.reel || '';
    m_supplier.value = it.supplier || '';
    m_gsm.value = it.gsm || '';
    m_bf.value = it.bf || '';
    m_qty.value = it.qty || 0;
    m_unit.value = it.unit || 'PCS';
    m_price.value = it.price || 0;
    // ensure modal categories loaded
    await loadModalCategories();
    m_category.value = it.category || '';
    m_date.value = it.date || '';

    // show modal
    modalBack.style.display = 'flex';
  }

  async function loadModalCategories(){
    // ensure modal category dropdown has same options as main
    m_category.innerHTML = '';
    const snap = await getDocs(collection(db,'inventoryCategories'));
    snap.forEach(d=>{
      const n = d.data().name;
      const option = document.createElement('option');
      option.value = n;
      option.innerText = n;
      m_category.appendChild(option);
    });
  }

  modalClose.onclick = ()=> {
    modalBack.style.display = 'none';
    currentModalId = null;
  };

  // Save modal changes
  modalSave.onclick = async ()=>{
    if(!currentModalId) return alert('No item loaded');
    const updated = {
      name: m_itemName.value.trim(),
      invoice: m_invoice.value.trim(),
      reel: m_reel.value.trim(),
      supplier: m_supplier.value.trim(),
      gsm: m_gsm.value ? Number(m_gsm.value) : null,
      bf: m_bf.value ? Number(m_bf.value) : null,
      qty: m_qty.value ? Number(m_qty.value) : 0,
      unit: m_unit.value,
      price: m_price.value ? Number(m_price.value) : 0,
      category: m_category.value,
      date: m_date.value
    };

    if(!updated.name) return alert('Item name required');
    if(!updated.qty || !updated.price || !updated.date || !updated.category) return alert('Fill required fields');

    await updateDoc(doc(db,'inventory', currentModalId), updated);

    modalBack.style.display = 'none';
    currentModalId = null;
    loadItems();
  };

  // Confirm delete item
  window.confirmDeleteItem = async (id) => {
    if(!confirm('Delete this item? This is permanent.')) return;
    await deleteDoc(doc(db,'inventory', id));
    loadItems();
  };

  // Used prompt
  async function useItemPrompt(id, currentQty, unit, safeName){
    const amtRaw = prompt(`Enter amount used (available: ${currentQty} ${unit})`);
    if(amtRaw === null) return;
    const amt = Number(amtRaw);
    if(isNaN(amt) || amt <= 0) return alert('Enter valid amount');
    if(amt > Number(currentQty)) return alert('Amount exceeds available');

    const reason = prompt('Used for (enter purpose):');
    if(reason === null || reason.trim() === '') return alert('Reason required');

    const newQty = Number(currentQty) - amt;

    // update or delete inventory doc
    if(newQty <= 0){
      await deleteDoc(doc(db,'inventory', id));
    } else {
      await updateDoc(doc(db,'inventory', id), { qty: newQty });
    }

    // create used record
    await addDoc(collection(db,'inventoryUsed'), {
      itemId: id,
      name: safeName,
      usedAmount: amt,
      unit,
      usedFor: reason,
      usedAt: new Date().toISOString()
    });

    alert('Used recorded.');
    loadItems();
  }

  // init / delete category helper already defined

  // filters
  filterCat.onchange = loadItems;
  filterDate.onchange = loadItems;

  // initial loads
  await loadCategories();
  await loadItems();

  // expose functions for inline buttons (delete category)
  window.loadCategories = loadCategories;
  window.loadItems = loadItems;

</script>
</body>
</html>
