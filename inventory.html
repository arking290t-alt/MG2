<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MG Inventory</title>

  <style>
    :root{
      --bg:#0b111b; --panel:rgba(255,255,255,0.04);
      --accent:#00b4ff; --muted:#9fb6d4; --card:rgba(255,255,255,0.06);
      --danger:#ef4444; --ok:#22c55e;
    }
    *{box-sizing:border-box;font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
    body{margin:0;min-height:100vh;background:radial-gradient(circle at 20% 30%, #101821,#070c12);color:#e6eef6;}
    .container{max-width:1100px;margin:20px auto;padding:22px;background:var(--panel);border-radius:14px;border:1px solid rgba(255,255,255,0.03);}
    h1{color:var(--accent);text-align:center;margin:6px 0 18px;font-size:28px}
    .section-title{color:var(--accent);font-weight:700;margin:18px 0 10px;font-size:20px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .input{flex:1;min-width:160px;display:flex;flex-direction:column}
    .input label{font-size:13px;color:var(--muted);margin-bottom:6px}
    .input input,.input select{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(0,0,0,0.3);color:#eef;outline:none}
    .btn{background:var(--accent);border:none;color:#001;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
    .small-btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
    .btn-view{background:#3b82f6;color:white}
    .btn-edit{background:#facc15;color:#111}
    .btn-used{background:#10b981;color:white}
    .btn-delete{background:var(--danger);color:white}
    .cat-box{background:rgba(255,255,255,0.02);padding:14px;border-radius:10px;margin-top:10px}
    .cat-item{display:flex;justify-content:space-between;align-items:center;padding:10px;background:rgba(255,255,255,0.03);border-radius:8px;margin-top:8px}
    .filters{display:flex;gap:12px;flex-wrap:wrap;margin-top:18px;align-items:center}
    .filters select,.filters input{padding:10px;border-radius:8px;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.06);color:#fff;min-width:160px}
    .filters button{padding:8px 12px;border-radius:8px;background:var(--danger);border:none;color:white}
    .inventory-item{background:var(--card);padding:18px;border-radius:12px;margin-top:12px;display:flex;justify-content:space-between;align-items:center}
    .meta{color:var(--muted);margin-top:6px}
  </style>
</head>

<body>

  <div class="container">
    <h1>MG Inventory</h1>

    <!-- FORM -->
    <div class="section-title">Inventory Management</div>

    <div class="row">
      <div class="input"><label>Item Name</label><input id="itemName"></div>
      <div class="input"><label>Qty</label><input id="quantity" type="number"></div>
      <div class="input"><label>Unit</label><select id="unit"><option>PCS</option><option>KGS</option></select></div>
    </div>

    <div class="row" style="margin-top:10px">
      <div class="input"><label>Purchase Price (₹)</label><input id="price" type="number"></div>
      <div class="input"><label>Invoice Number</label><input id="invoice"></div>
      <div class="input"><label>Reel Number</label><input id="reel"></div>
    </div>

    <div class="row" style="margin-top:10px">
      <div class="input"><label>Supplier</label><input id="supplier"></div>
      <div class="input"><label>GSM</label><input id="gsm" type="number"></div>
      <div class="input"><label>BF</label><input id="bf" type="number"></div>
    </div>

    <div class="row" style="margin-top:10px">
      <div class="input"><label>Date</label><input id="date" type="date"></div>
      <div class="input"><label>Category</label><select id="categorySelect"><option value="">Select Category</option></select></div>
    </div>

    <button id="addItemBtn" class="btn" style="margin-top:12px">Add Item</button>

    <!-- CATEGORIES -->
    <div class="section-title">Manage Categories</div>
    <div class="cat-box">
      <div class="row">
        <div class="input"><label>New Category</label><input id="newCategoryName"></div>
        <button id="addCategoryBtn" class="btn" style="align-self:flex-end">Add Category</button>
      </div>
      <div id="categoryList" style="margin-top:12px"></div>
    </div>

    <!-- FILTERS -->
    <div class="section-title">Filter Inventory</div>
    <div class="filters">
      <select id="filterCategory"><option value="all">All Categories</option></select>
      <select id="filterItemName"><option value="all">All Items</option></select>
      <input id="filterDate" type="date">
      <button id="clearFilters">Clear</button>
    </div>

    <!-- LIST -->
    <div id="inventoryList" style="margin-top:18px"></div>

    <!-- TOTAL AMOUNT -->
    <div id="totalAmountBox"
         style="margin-top:20px;font-size:22px;font-weight:800;text-align:right;color:var(--accent);">
    </div>

  </div>

<script type="module">

/* FIREBASE IMPORTS */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc, getDoc
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

/* FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyC6BmLTjzOHwTa2VEYa9eYkClDtS__zvTM",
  authDomain: "mg-manager-3ab66.firebaseapp.com",
  projectId: "mg-manager-3ab66",
  storageBucket: "mg-manager-3ab66.firebasestorage.app",
  messagingSenderId: "330667005987",
  appId: "1:330667005987:web:95de27b6259ace9fc6b996",
  measurementId: "G-05HW0KSN38"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* DOM */
const itemName = document.getElementById("itemName");
const quantity = document.getElementById("quantity");
const unit = document.getElementById("unit");
const price = document.getElementById("price");
const invoice = document.getElementById("invoice");
const reel = document.getElementById("reel");
const supplier = document.getElementById("supplier");
const gsm = document.getElementById("gsm");
const bf = document.getElementById("bf");
const dateInput = document.getElementById("date");
const categorySelect = document.getElementById("categorySelect");

const newCategoryName = document.getElementById("newCategoryName");
const addCategoryBtn = document.getElementById("addCategoryBtn");
const categoryList = document.getElementById("categoryList");

const filterCategory = document.getElementById("filterCategory");
const filterItemName = document.getElementById("filterItemName");
const filterDate = document.getElementById("filterDate");
const clearFilters = document.getElementById("clearFilters");

const inventoryList = document.getElementById("inventoryList");
const totalAmountBox = document.getElementById("totalAmountBox");

/* Escape HTML */
function escapeHtml(s){
  if (!s) return "";
  return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}

/* Load categories */
async function loadCategories(){
  categorySelect.innerHTML = `<option value="">Select Category</option>`;
  filterCategory.innerHTML = `<option value="all">All Categories</option>`;
  categoryList.innerHTML = "";

  const snap = await getDocs(collection(db, "inventoryCategories"));
  snap.forEach(d => {
    const name = d.data().name;
    const id = d.id;

    categorySelect.innerHTML += `<option value="${name}">${name}</option>`;
    filterCategory.innerHTML += `<option value="${name}">${name}</option>`;

    const div = document.createElement("div");
    div.className = "cat-item";
    div.innerHTML = `<span>${escapeHtml(name)}</span> <button data-id="${id}" class="btn-delete small-btn">Delete</button>`;
    categoryList.appendChild(div);

    div.querySelector("button").onclick = async () => {
      if (!confirm("Delete category?")) return;
      await deleteDoc(doc(db, "inventoryCategories", id));
      loadCategories();
      loadInventory();
    };
  });
}

/* Add category */
addCategoryBtn.onclick = async () => {
  const name = newCategoryName.value.trim();
  if (!name) return alert("Enter category");
  await addDoc(collection(db, "inventoryCategories"), { name });
  newCategoryName.value = "";
  loadCategories();
};

/* Add item */
document.getElementById("addItemBtn").onclick = async () => {
  const payload = {
    name: itemName.value.trim(),
    qty: Number(quantity.value),
    unit: unit.value,
    price: Number(price.value),
    invoice: invoice.value.trim(),
    reel: reel.value.trim(),
    supplier: supplier.value.trim(),
    gsm: gsm.value.trim(),
    bf: bf.value.trim(),
    date: dateInput.value,
    category: categorySelect.value,
    amount: Number(quantity.value) * Number(price.value),
    createdAt: new Date().toISOString()
  };

  if (!payload.name) return alert("Enter item name");
  if (!payload.category) return alert("Select category");

  await addDoc(collection(db, "inventory"), payload);

  itemName.value = quantity.value = price.value = invoice.value =
  reel.value = supplier.value = gsm.value = bf.value = dateInput.value = "";

  loadInventory();
};

/* Load inventory */
async function loadInventory(){
  inventoryList.innerHTML = "";
  totalAmountBox.innerHTML = "";

  filterItemName.innerHTML = `<option value="all">All Items</option>`;

  const snap = await getDocs(collection(db, "inventory"));
  let items = snap.docs.map(d => ({ id: d.id, ...d.data() }));

  const selectedCategory = filterCategory.value;
  let dropdownItems = items;

  if (selectedCategory !== "all"){
    dropdownItems = items.filter(i => i.category === selectedCategory);
  }

  const names = [...new Set(dropdownItems.map(i => i.name))];
  names.forEach(n => {
    filterItemName.innerHTML += `<option value="${n}">${n}</option>`;
  });

  /* Apply filters */
  if (filterCategory.value !== "all"){
    items = items.filter(i => i.category === filterCategory.value);
  }

  if (filterItemName.value !== "all"){
    items = items.filter(i => i.name === filterItemName.value);
  }

  if (filterDate.value){
    items = items.filter(i => i.date === filterDate.value);
  }

  if (!items.length){
    inventoryList.innerHTML = `<p style="text-align:center;color:var(--muted)">No items found.</p>`;
    totalAmountBox.innerHTML = "";
    return;
  }

  let total = 0;

  items.forEach(it => {
    const amount = it.amount || (it.qty * it.price);
    total += amount;

    const card = document.createElement("div");
    card.className = "inventory-item";

    card.innerHTML = `
      <div style="max-width:70%">
        <h3>${escapeHtml(it.name)}</h3>
        <div class="meta">Qty: ${it.qty} ${it.unit}</div>
        <div class="meta">Date: ${it.date}</div>
        <div class="meta">Category: ${escapeHtml(it.category)}</div>
      </div>
      <div style="text-align:right;color:var(--accent);font-size:18px;font-weight:700">
        ₹${amount.toFixed(2)}
      </div>
    `;
    inventoryList.appendChild(card);
  });

  totalAmountBox.innerHTML = `Total Amount: ₹${total.toFixed(2)}`;
}

/* Filter events (fixed) */
filterCategory.onchange = () => {
  filterItemName.value = "all";
  loadInventory();
};
filterItemName.onchange = () => loadInventory();
filterDate.onchange = () => {
  filterItemName.value = "all";
  loadInventory();
};
clearFilters.onclick = () => {
  filterCategory.value = "all";
  filterItemName.value = "all";
  filterDate.value = "";
  loadInventory();
};

/* Init */
(async () => {
  await loadCategories();
  await loadInventory();
})();
</script>

</body>
</html>
