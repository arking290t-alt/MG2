<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Job Update | MG</title>

<style>
body{background:#0b111b;color:#e2e8f0;font-family:Poppins;margin:0;}
header{display:flex;justify-content:space-between;align-items:center;padding:15px 25px;background:rgba(255,255,255,0.05);}
.logo{color:#00b4ff;font-size:22px;font-weight:700;}
.top-actions{display:flex;gap:10px;}
.btn-top{background:#00b4ff;border:none;padding:8px 14px;border-radius:8px;color:white;font-weight:600;cursor:pointer;}
.btn-finished{background:#22c55e;}
.logout-btn{background:#ef4444;}

.container{max-width:960px;margin:25px auto;background:rgba(255,255,255,0.05);padding:25px;border-radius:16px;}

h1{text-align:center;color:#00b4ff;}

input,button{padding:10px 14px;border-radius:10px;border:none;}
input{background:#0e1724;color:white;border:1px solid rgba(255,255,255,0.08);}
button{background:#00b4ff;color:white;font-weight:600;cursor:pointer;}

.form-row{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin-bottom:20px;}

.checkbox-group{display:flex;flex-wrap:wrap;gap:12px;justify-content:center;}
.checkbox-chip{background:rgba(255,255,255,0.06);padding:10px 14px;border-radius:12px;cursor:pointer;}
.checkbox-chip.active{background:#00b4ff;color:black;}

.job-item{background:rgba(255,255,255,0.04);margin:10px 0;padding:14px;border-radius:12px;display:flex;justify-content:space-between;align-items:center;}
.job-left{display:flex;flex-direction:column;}
.job-name{color:#00b4ff;font-weight:700;cursor:pointer;}

.job-meta{text-align:right;font-size:0.85rem;color:#9bbcd7;}

.btn-small{padding:6px 10px;border-radius:6px;border:none;font-size:12px;margin-left:5px;}
.btn-delete{background:#ef4444;}
.btn-finish{background:#22c55e;}
.btn-view{background:#3b82f6;}

/* CATEGORY LIST */
.cat-item{
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:rgba(255,255,255,0.06);
  padding:10px 14px;
  border-radius:10px;
  margin-top:8px;
}
.cat-item button{
  background:#ef4444;
  padding:6px 10px;
  border:none;
  border-radius:6px;
  color:white;
  cursor:pointer;
}
</style>
</head>

<body>

<header>
  <div class="logo">MG</div>
  <div class="top-actions">
    <button class="btn-top btn-finished" id="showFinished">Finished</button>
    <button class="btn-top logout-btn" id="logout">Logout</button>
  </div>
</header>

<div class="container">

<h1>Job Update</h1>

<!-- FORM -->
<div class="form-row">
  <input id="jobName" placeholder="Job Name" />
  <input id="jobType" placeholder="Job Type (optional)" />
  <input id="jobDate" type="date" />
</div>

<h3 style="text-align:center;color:#8ab9ff;">Select Categories (order = click order)</h3>
<div id="categoryGrid" class="checkbox-group"></div>

<div style="text-align:center;margin:10px;">
  <button id="addJob">Add Job</button>
</div>

<hr>

<h3 style="text-align:center;color:#8ab9ff;">Filter</h3>
<div style="display:flex;justify-content:center;gap:10px;">
  <input type="month" id="monthFilter">
  <input type="date" id="dateFilter">
</div>

<h2 style="text-align:center;margin-top:20px;" id="listTitle">All Jobs</h2>
<div id="jobList"></div>

<hr>

<h3 style="text-align:center;color:#8ab9ff;">Add New Category</h3>
<div class="form-row">
  <input id="newCategory" placeholder="New Category">
  <button id="addCategory">Add</button>
</div>

<!-- ðŸ”¥ CATEGORY MANAGEMENT LIST -->
<h3 style="text-align:center;color:#facc15;margin-top:25px;">Manage Categories</h3>
<div id="categoryList"></div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC6BmLTjzOHwTa2VEYa9eYkClDtS__zvTM",
  authDomain: "mg-manager-3ab66.firebaseapp.com",
  projectId: "mg-manager-3ab66",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ðŸ”¥ DATA */
let categories=[];
let selectedCats=[];
let allJobs=[];
let showFinishedMode=false;

const categoryGrid=document.getElementById("categoryGrid");
const categoryList=document.getElementById("categoryList");
const jobList=document.getElementById("jobList");
const listTitle=document.getElementById("listTitle");

/* ---------------- LOAD CATEGORIES ---------------- */
async function loadCategories(){
  const snap=await getDocs(collection(db,"jobCategories"));
  categories=snap.docs.map(d=>({id:d.id,...d.data()}));
  renderCategoryGrid();
  renderCategoryList();
}

/* ---------------- RENDER CATEGORY GRID ---------------- */
function renderCategoryGrid(){
  categoryGrid.innerHTML=categories.map(c=>`
    <div class="checkbox-chip" data-id="${c.id}">${c.name}</div>
  `).join("");

  document.querySelectorAll(".checkbox-chip").forEach(ch=>{
    ch.onclick=()=>{
      let id=ch.dataset.id;

      if(selectedCats.includes(id)){
        selectedCats=selectedCats.filter(x=>x!==id);
        ch.classList.remove("active");
      } else {
        selectedCats.push(id);      // ORDER PRESERVED
        ch.classList.add("active");
      }
    };
  });
}

/* ---------------- CATEGORY LIST WITH DELETE ---------------- */
function renderCategoryList(){
  categoryList.innerHTML = categories.length
    ? categories.map(c=>`
        <div class="cat-item">
          <span>${c.name}</span>
          <button onclick="deleteCategory('${c.id}')">Delete</button>
        </div>
      `).join("")
    : "<p style='text-align:center;color:#999;'>No categories yet</p>";
}

window.deleteCategory = async (id)=>{
  if(!confirm("Delete this category?")) return;
  await deleteDoc(doc(db,"jobCategories",id));
  selectedCats = selectedCats.filter(x=>x!==id);
  loadCategories();
};

/* ---------------- ADD CATEGORY ---------------- */
addCategory.onclick = async ()=>{
  let name=newCategory.value.trim();
  if(!name) return alert("Enter category name");

  await addDoc(collection(db,"jobCategories"),{
    name,
    created:new Date().toISOString()
  });

  newCategory.value="";
  loadCategories();
};

/* ---------------- ADD JOB ---------------- */
addJob.onclick = async ()=>{
  let name=jobName.value.trim();
  let type=jobType.value.trim();
  let date=jobDate.value;

  if(!name||!date) return alert("Job name and date required");
  if(selectedCats.length===0) return alert("Select categories");

  let ordered = selectedCats.map(id=>{
    let c=categories.find(x=>x.id===id);
    return { name:c.name, status:"pending" };
  });

  await addDoc(collection(db,"jobs"),{
    name,type,date,
    categories:ordered,
    finished:false,
    created:new Date().toISOString()
  });

  selectedCats=[];
  jobName.value="";jobType.value="";jobDate.value="";
  renderCategoryGrid();
  loadJobs();
};

/* ---------------- LOAD JOBS ---------------- */
async function loadJobs(){
  const snap=await getDocs(collection(db,"jobs"));
  allJobs=snap.docs.map(d=>({id:d.id,...d.data()}));
  renderJobs();
}

/* ---------------- RENDER JOBS ---------------- */
function renderJobs(){
  let month=monthFilter.value;
  let date=dateFilter.value;

  let jobs=allJobs.filter(j=>showFinishedMode ? j.finished===true : j.finished!==true);

  if(month) jobs=jobs.filter(j=>j.date.startsWith(month));
  if(date) jobs=jobs.filter(j=>j.date===date);

  listTitle.textContent = showFinishedMode ? "Finished Jobs" : "All Jobs";

  jobList.innerHTML=jobs.map(j=>`
    <div class="job-item">
      <div class="job-left">
        <div class="job-name" onclick="openJob('${j.id}')">${j.name}</div>
        <div style="font-size:.9rem;color:#9bbcd7;">${j.type||""}</div>
      </div>

      <div class="job-meta">
        <div>${j.date}</div>
        <div>${j.categories.map(c=>c.name).join(" â†’ ")}</div>
      </div>

      <div>
        ${j.finished
          ? `<button class="btn-small btn-view" onclick="openJob('${j.id}')">View</button>`
          : `<button class="btn-small btn-finish" onclick="finishJob('${j.id}')">Finished</button>`
        }
        <button class="btn-small btn-delete" onclick="deleteJob('${j.id}')">Delete</button>
      </div>
    </div>
  `).join("");
}

/* ---------------- FINISH JOB ---------------- */
window.finishJob=async(id)=>{
  if(!confirm("Mark job as finished?")) return;
  await updateDoc(doc(db,"jobs",id),{finished:true});
  loadJobs();
};

/* ---------------- DELETE JOB ---------------- */
window.deleteJob=async(id)=>{
  if(!confirm("Delete job?")) return;
  await deleteDoc(doc(db,"jobs",id));
  loadJobs();
};

window.openJob=(id)=>{
  localStorage.setItem("selectedJob",id);
  location.href="job-detail.html";
};

/* ---------------- TOGGLE FINISHED ---------------- */
showFinished.onclick=()=>{
  showFinishedMode=!showFinishedMode;
  renderJobs();
};

monthFilter.onchange=renderJobs;
dateFilter.onchange=renderJobs;

logout.onclick=()=>{
  localStorage.clear();
  location.href="login.html";
};

loadCategories();
loadJobs();
</script>

</body>
</html>
