<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Jobs | MG</title>
<link rel="stylesheet" href="style.css" />

<style>
  /* FIX dropdown visibility */
  select option {
    color: #000;
    background: #fff;
  }

  .job-form {
    display:flex;
    flex-wrap:wrap;
    gap:12px;
    margin-bottom:20px;
  }

  .job-form input,
  .job-form select {
    padding:10px;
    border-radius:8px;
    border:1px solid rgba(255,255,255,0.15);
    background:rgba(255,255,255,0.05);
    color:white;
    min-width:180px;
  }

  .job-item {
    background:rgba(255,255,255,0.05);
    padding:14px;
    border-radius:12px;
    margin-bottom:12px;
    display:flex;
    justify-content:space-between;
    align-items:center;
  }

  .job-meta small {
    color:#9fb6d4;
  }

  .complete-btn {
    background:#22c55e;
    border:none;
    padding:6px 10px;
    border-radius:6px;
    color:#000;
    font-weight:600;
    cursor:pointer;
  }

  .completed-badge {
    color:#22c55e;
    font-weight:700;
  }
</style>
</head>

<body class="dashboard-body">

<header class="top-bar">
  <h1 class="logo">MG</h1>
  <div>
    <a href="dashboard.html" class="btn-back">← Back</a>
    <button class="btn-logout" onclick="logoutUser()">Logout</button>
  </div>
</header>

<main class="dashboard-center">
<div class="dashboard-box" style="max-width:1000px;width:100%;">

<h2 class="welcome">Jobs</h2>
<p class="subtitle">Add and manage customer jobs</p>

<!-- ADD CATEGORY -->
<div style="margin-bottom:15px;">
  <input id="newCategory" placeholder="New Job Category">
  <button class="add-btn" id="addCategoryBtn">Add Category</button>
</div>

<!-- JOB FORM -->
<div class="job-form">
  <select id="categorySelect">
    <option value="">Select Category</option>
  </select>

  <input id="jobName" placeholder="Job Name">
  <input id="customerName" placeholder="Customer Name">
  <input id="customerPhone" placeholder="Customer Phone">
  <input id="amount" type="number" placeholder="Amount ₹">

  <button class="add-btn" id="addJobBtn">Add Job</button>
</div>

<!-- JOB LIST -->
<div id="jobList"></div>

</div>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs, updateDoc, doc
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC6BmLTjzOHwTa2VEYa9eYkClDtS__zvTM",
  authDomain: "mg-manager-3ab66.firebaseapp.com",
  projectId: "mg-manager-3ab66"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const categorySelect = document.getElementById("categorySelect");
const jobList = document.getElementById("jobList");

// LOAD CATEGORIES
async function loadCategories(){
  categorySelect.innerHTML = `<option value="">Select Category</option>`;
  const snap = await getDocs(collection(db,"simpleJobCategories"));
  snap.forEach(d=>{
    const opt = document.createElement("option");
    opt.value = d.data().name;
    opt.textContent = d.data().name;
    categorySelect.appendChild(opt);
  });
}

// ADD CATEGORY
document.getElementById("addCategoryBtn").onclick = async ()=>{
  const name = newCategory.value.trim();
  if(!name) return alert("Enter category");
  await addDoc(collection(db,"simpleJobCategories"),{ name });
  newCategory.value="";
  loadCategories();
};

// ADD JOB
document.getElementById("addJobBtn").onclick = async ()=>{
  const job = {
    category: categorySelect.value,
    jobName: jobName.value.trim(),
    customerName: customerName.value.trim(),
    phone: customerPhone.value.trim(),
    amount: Number(amount.value) || 0,
    status: "pending",
    createdAt: new Date().toISOString()
  };

  if(!job.category || !job.jobName || !job.customerName || !job.phone){
    return alert("Fill all details");
  }

  await addDoc(collection(db,"simpleJobs"), job);

  jobName.value="";
  customerName.value="";
  customerPhone.value="";
  amount.value="";

  loadJobs();
};

// MARK COMPLETED
async function completeJob(id){
  const by = prompt("Completed By?");
  if(!by) return;

  const money = prompt("Money Received ₹?");
  if(money === null || isNaN(money)) return;

  await updateDoc(doc(db,"simpleJobs",id),{
    status:"completed",
    completedBy: by,
    moneyReceived: Number(money),
    completedAt: new Date().toISOString()
  });

  loadJobs();
}

// LOAD JOBS
async function loadJobs(){
  jobList.innerHTML="";
  const snap = await getDocs(collection(db,"simpleJobs"));

  snap.forEach(d=>{
    const j = d.data();
    const div = document.createElement("div");
    div.className="job-item";

    div.innerHTML = `
      <div class="job-meta">
        <strong>${j.jobName}</strong><br>
        <small>
          ${j.category} | ${j.customerName} | ${j.phone} | ₹${j.amount}
        </small><br>
        ${j.status === "completed" ? `
          <span class="completed-badge">
            ✔ Completed by ${j.completedBy} | ₹${j.moneyReceived}
          </span>` : ""}
      </div>

      <div>
        ${j.status === "pending"
          ? `<button class="complete-btn">Complete</button>`
          : `<small>${j.completedAt?.slice(0,10)}</small>`
        }
      </div>
    `;

    if(j.status === "pending"){
      div.querySelector(".complete-btn").onclick = ()=>completeJob(d.id);
    }

    jobList.appendChild(div);
  });
}

loadCategories();
loadJobs();
</script>

<script type="module" src="auth-protect.js"></script>

</body>
</html>
