<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Jobs | MG</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  background:#0b111b;
  font-family:Poppins,sans-serif;
  color:#e5eaf0;
  margin:0;
}
header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:16px 24px;
  background:rgba(255,255,255,0.05);
}
.logo{color:#00b4ff;font-size:1.6rem;font-weight:700;}
.btn{
  background:#00b4ff;
  border:none;
  color:#000;
  padding:8px 14px;
  border-radius:8px;
  font-weight:600;
  cursor:pointer;
}
.container{
  max-width:900px;
  margin:40px auto;
  background:rgba(255,255,255,0.06);
  padding:30px;
  border-radius:18px;
}
h1{text-align:center;color:#00b4ff;}
.subtitle{text-align:center;color:#9fb6d4;margin-bottom:24px}

/* form */
.form-row{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:12px;
  margin-bottom:14px;
}
input,select{
  padding:10px;
  border-radius:8px;
  border:1px solid rgba(255,255,255,0.15);
  background:#1c232b;
  color:#fff;
}
select option{
  background:#1c232b;
  color:#fff;
}
.add-btn{
  background:#00b4ff;
  border:none;
  padding:10px 18px;
  border-radius:10px;
  font-weight:700;
  cursor:pointer;
  margin-bottom:20px;
}

/* job card */
.job-item{
  background:rgba(255,255,255,0.05);
  border-radius:14px;
  padding:16px 18px;
  margin-top:14px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.job-meta small{color:#9fb6d4;display:block}
.pending{color:#ffd400;font-weight:700}
.completed{color:#22c55e;font-weight:700}

.complete-btn{
  background:#22c55e;
  border:none;
  padding:8px 14px;
  border-radius:8px;
  cursor:pointer;
  font-weight:700;
}
</style>
</head>

<body>

<header>
  <div class="logo">MG</div>
  <button class="btn" onclick="location.href='dashboard.html'">← Back</button>
</header>

<div class="container">
  <h1>Jobs</h1>
  <div class="subtitle">Add and manage customer jobs</div>

  <!-- CATEGORY -->
  <div class="form-row">
    <input id="newCategory" placeholder="New Job Category">
    <button class="btn" onclick="addCategory()">Add Category</button>
  </div>

  <!-- JOB FORM -->
  <div class="form-row">
    <select id="categorySelect">
      <option value="">Select Category</option>
    </select>
    <input id="jobName" placeholder="Job Name">
    <input id="customerName" placeholder="Customer Name">
    <input id="customerPhone" placeholder="Customer Phone">
    <input id="amount" type="number" placeholder="Amount ₹">
  </div>

  <button class="add-btn" onclick="addJob()">Add Job</button>

  <!-- JOB LIST -->
  <div id="jobList"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs, updateDoc, doc
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC6BmLTjzOHwTa2VEYa9eYkClDtS__zvTM",
  authDomain: "mg-manager-3ab66.firebaseapp.com",
  projectId: "mg-manager-3ab66"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const catSelect = document.getElementById("categorySelect");
const jobList = document.getElementById("jobList");

/* ---------- CATEGORIES ---------- */
async function loadCategories(){
  catSelect.innerHTML = `<option value="">Select Category</option>`;
  const snap = await getDocs(collection(db,"simpleJobCategories"));
  snap.forEach(d=>{
    const o=document.createElement("option");
    o.value=d.data().name;
    o.textContent=d.data().name;
    catSelect.appendChild(o);
  });
}

window.addCategory = async ()=>{
  const name=document.getElementById("newCategory").value.trim();
  if(!name) return alert("Enter category");
  await addDoc(collection(db,"simpleJobCategories"),{name});
  document.getElementById("newCategory").value="";
  loadCategories();
};

/* ---------- ADD JOB ---------- */
window.addJob = async ()=>{
  const job={
    category:catSelect.value,
    jobName:jobName.value.trim(),
    customerName:customerName.value.trim(),
    phone:customerPhone.value.trim(),
    amount:Number(amount.value)||0,
    status:"pending",
    jobDate:new Date().toISOString().slice(0,10)
  };

  if(!job.category||!job.jobName||!job.customerName||!job.phone){
    return alert("Fill all fields");
  }

  await addDoc(collection(db,"simpleJobs"),job);

  jobName.value="";
  customerName.value="";
  customerPhone.value="";
  amount.value="";

  loadJobs();
};

/* ---------- LOAD JOBS ---------- */
async function loadJobs(){
  jobList.innerHTML="";
  const snap=await getDocs(collection(db,"simpleJobs"));

  snap.forEach(d=>{
    const j=d.data();
    const div=document.createElement("div");
    div.className="job-item";

    div.innerHTML=`
      <div class="job-meta">
        <strong>${j.jobName}</strong>
        <small>${j.category} | ${j.customerName} | ${j.phone}</small>
        <small>Amount: ₹${j.amount}</small>
        <small>Date: ${j.jobDate}</small>
        ${
          j.status==="completed"
          ? `<div class="completed">✔ Completed<br>
             By: ${j.completedBy}<br>
             Received: ₹${j.moneyReceived}<br>
             Date: ${j.completedDate}
            </div>`
          : `<div class="pending">Pending</div>`
        }
      </div>
      ${
        j.status==="pending"
        ? `<button class="complete-btn">Complete</button>`
        : ``
      }
    `;

    if(j.status==="pending"){
      div.querySelector(".complete-btn").onclick=async()=>{
        const by=prompt("Completed By?");
        const money=prompt("Money Received ₹?");
        if(!by||isNaN(money)) return;

        await updateDoc(doc(db,"simpleJobs",d.id),{
          status:"completed",
          completedBy:by,
          moneyReceived:Number(money),
          completedDate:new Date().toISOString().slice(0,10)
        });
        loadJobs();
      };
    }

    jobList.appendChild(div);
  });
}

loadCategories();
loadJobs();
</script>

</body>
</html>
