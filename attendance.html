<script>
const staffSelect = document.getElementById("staffSelect");
const calendar = document.getElementById("calendar");
const modal = document.getElementById("attendanceModal");
const closeModal = document.getElementById("closeModal");
const actions = document.getElementById("actions");
const modalTitle = document.getElementById("modalTitle");
const salarySummary = document.getElementById("salarySummary");
const addPaymentBtn = document.getElementById("addPaymentBtn");

const STAFF_KEY = "staffList";
const ATTEND_KEY = "attendanceData";
const PAY_KEY = "paymentData";
const EXP_KEY = "expenses";
const staffList = JSON.parse(localStorage.getItem(STAFF_KEY)) || [];
const attendanceData = JSON.parse(localStorage.getItem(ATTEND_KEY)) || {};
const paymentData = JSON.parse(localStorage.getItem(PAY_KEY)) || {};
let expenses = JSON.parse(localStorage.getItem(EXP_KEY)) || [];

let currentMonth = new Date().getMonth();
let currentYear = new Date().getFullYear();
let currentDay = null;

function updateMonthYear() {
  const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];
  document.getElementById("monthYear").textContent = `${months[currentMonth]} ${currentYear}`;
}

function loadStaffList() {
  if (!staffList.length) {
    staffSelect.innerHTML = "<option>No staff added</option>";
    return;
  }
  staffSelect.innerHTML = `<option value="">Select Staff</option>` + staffList.map(s => `<option value="${s.name}">${s.name}</option>`).join("");
}

function renderCalendar() {
  calendar.innerHTML = "";
  updateMonthYear();

  const staffName = staffSelect.value;
  if (!staffName) return;

  const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

  for (let i = 1; i <= daysInMonth; i++) {
    const div = document.createElement("div");
    div.className = "day";
    div.textContent = i;

    const key = `${staffName}_${currentYear}_${currentMonth}_${i}`;
    const rec = attendanceData[key];
    if (rec) {
      const dot = document.createElement("div");
      dot.className = "dot";
      dot.style.background =
        rec.status === "Present" ? "var(--present)" :
        rec.status === "Half" ? "var(--half)" :
        rec.status === "Absent" ? "var(--absent)" :
        rec.status === "Leave" ? "var(--leave)" :
        rec.status === "OT" ? "var(--ot)" : "#888";
      div.appendChild(dot);
    }

    div.onclick = () => openAttendanceModal(i);
    calendar.appendChild(div);
  }

  updateSalarySummary();
}

function openAttendanceModal(day) {
  const staffName = staffSelect.value;
  if (!staffName) return alert("Select a staff first!");

  modal.style.display = "flex";
  modalTitle.textContent = `${staffName} - ${day}/${currentMonth + 1}/${currentYear}`;
  currentDay = day;

  actions.innerHTML = `
    <button class="present" onclick="mark('Present')">Present</button>
    <button class="half" onclick="mark('Half')">Half</button>
    <button class="absent" onclick="mark('Absent')">Absent</button>
    <button class="leave" onclick="mark('Leave')">Leave</button>
    <button class="ot" onclick="markOT()">OT</button>
    <button class="clear" onclick="clearStatus()">Clear</button>
  `;
}

function mark(status) {
  const staffName = staffSelect.value;
  const key = `${staffName}_${currentYear}_${currentMonth}_${currentDay}`;
  attendanceData[key] = { status, ot: 0 };
  localStorage.setItem(ATTEND_KEY, JSON.stringify(attendanceData));
  renderCalendar();
  updateSalarySummary();
  modal.style.display = "none";
}

function markOT() {
  const staffName = staffSelect.value;
  const rate = prompt("Enter OT amount:");
  if (!rate || isNaN(rate)) return;
  const key = `${staffName}_${currentYear}_${currentMonth}_${currentDay}`;
  attendanceData[key] = { status: "OT", ot: parseFloat(rate) };
  localStorage.setItem(ATTEND_KEY, JSON.stringify(attendanceData));
  renderCalendar();
  updateSalarySummary();
  modal.style.display = "none";
}

function clearStatus() {
  const staffName = staffSelect.value;
  const key = `${staffName}_${currentYear}_${currentMonth}_${currentDay}`;
  delete attendanceData[key];
  localStorage.setItem(ATTEND_KEY, JSON.stringify(attendanceData));
  renderCalendar();
  updateSalarySummary();
  modal.style.display = "none";
}

function addPayment() {
  const staffName = staffSelect.value;
  if (!staffName) return alert("Select a staff first!");

  const amount = prompt("Enter payment amount:");
  if (!amount || isNaN(amount)) return;

  const note = prompt("Enter note (optional):") || "Salary Payment";
  const payAmount = parseFloat(amount);
  const payDate = new Date().toISOString().slice(0, 10);

  // Store in payment data
  const payKey = `${staffName}_${currentYear}_${currentMonth}`;
  if (!paymentData[payKey]) paymentData[payKey] = [];
  paymentData[payKey].push({ amount: payAmount, note, date: payDate });
  localStorage.setItem(PAY_KEY, JSON.stringify(paymentData));

  // Add to Expenses
  expenses.push({
    name: `${staffName} - ${note}`,
    category: "Salary",
    amount: payAmount,
    date: payDate
  });
  localStorage.setItem(EXP_KEY, JSON.stringify(expenses));

  updateSalarySummary();
  alert(`₹${payAmount} added for ${staffName} and logged under Salary in Expenses.`);
}

function deletePayment(staffName, index) {
  const payKey = `${staffName}_${currentYear}_${currentMonth}`;
  if (!paymentData[payKey]) return;

  const payment = paymentData[payKey][index];
  if (!confirm(`Delete payment of ₹${payment.amount}?`)) return;

  // Remove payment
  paymentData[payKey].splice(index, 1);
  localStorage.setItem(PAY_KEY, JSON.stringify(paymentData));

  // Remove from expenses (matching same date & amount under Salary)
  expenses = expenses.filter(
    e =>
      !(
        e.category === "Salary" &&
        e.name.startsWith(staffName) &&
        e.amount === payment.amount &&
        e.date === payment.date
      )
  );
  localStorage.setItem(EXP_KEY, JSON.stringify(expenses));

  updateSalarySummary();
  alert(`₹${payment.amount} deleted and restored to remaining salary.`);
}

function updateSalarySummary() {
  const staffName = staffSelect.value;
  const staff = staffList.find(s => s.name === staffName);
  if (!staff) return;

  const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
  const perDay = staff.salary / daysInMonth;
  let full = 0,
    half = 0,
    totalOT = 0;

  for (let i = 1; i <= daysInMonth; i++) {
    const key = `${staffName}_${currentYear}_${currentMonth}_${i}`;
    const rec = attendanceData[key];
    if (!rec) continue;
    if (rec.status === "Present") full++;
    if (rec.status === "Half") half += 0.5;
    if (rec.status === "OT") totalOT += rec.ot;
  }

  const total = (full + half) * perDay + totalOT;
  const payKey = `${staffName}_${currentYear}_${currentMonth}`;
  const payments = paymentData[payKey] || [];
  const paid = payments.reduce((sum, p) => sum + p.amount, 0);
  const remaining = total - paid;

  salarySummary.innerHTML = `
    Per Day: ₹${perDay.toFixed(2)} |
    Earnings: ₹${total.toFixed(2)} |
    Paid: ₹${paid.toFixed(2)} |
    Remaining: ₹${remaining.toFixed(2)}
    <br><br><strong>Payments:</strong><br>
    ${
      payments.length
        ? payments
            .map(
              (p, i) =>
                `${p.date}: ₹${p.amount} (${p.note}) <button onclick="deletePayment('${staffName}', ${i})" style="background:#ef4444;border:none;color:white;padding:2px 6px;border-radius:4px;cursor:pointer;">Delete</button>`
            )
            .join("<br>")
        : "<em>No payments yet.</em>"
    }
  `;
}

document.getElementById("prevMonth").onclick = () => {
  currentMonth--;
  if (currentMonth < 0) {
    currentMonth = 11;
    currentYear--;
  }
  renderCalendar();
};

document.getElementById("nextMonth").onclick = () => {
  currentMonth++;
  if (currentMonth > 11) {
    currentMonth = 0;
    currentYear++;
  }
  renderCalendar();
};

closeModal.onclick = () => (modal.style.display = "none");
window.onclick = e => {
  if (e.target === modal) modal.style.display = "none";
};

document.getElementById("logoutBtn").onclick = () => {
  localStorage.removeItem("loggedInUser");
  location.href = "login.html";
};

staffSelect.onchange = renderCalendar;
addPaymentBtn.onclick = addPayment;

loadStaffList();
</script>

