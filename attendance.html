<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Attendance | MG</title>
<style>
:root{
  --bg:#0b111b; --card:rgba(255,255,255,0.04);
  --accent:#00b4ff; --muted:#9aa9b7; --text:#d4e1f0;
  --present:#22c55e; --half:#3b82f6; --absent:#ef4444; --leave:#f59e0b; --ot:#8b5cf6;
}
*{box-sizing:border-box;font-family:Inter, system-ui, -apple-system, "Poppins", sans-serif}
body{margin:0;background:var(--bg);color:var(--text)}
header{display:flex;justify-content:space-between;align-items:center;padding:12px 20px;background:rgba(255,255,255,0.03);border-bottom:1px solid rgba(255,255,255,0.04)}
.logo{color:var(--accent);font-weight:800;font-size:20px}
.btn{background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
.container{max-width:1100px;margin:28px auto;padding:26px;background:var(--card);border-radius:14px;position:relative;box-shadow:0 12px 40px rgba(0,180,255,0.06)}
h1{text-align:center;color:var(--accent);margin:0 0 14px}
.controls{display:flex;gap:12px;justify-content:center;align-items:center;margin-bottom:18px;flex-wrap:wrap}
#staffSelect{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:var(--text)}
.month-nav{display:flex;align-items:center;gap:10px}
.month-btn{background:none;border:0;color:var(--accent);font-size:20px;cursor:pointer}
.calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:12px}
.day{background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);border-radius:10px;padding:10px;height:96px;position:relative;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:flex-start}
.day:hover{transform:translateY(-3px);transition:all .12s ease}
.day-number{font-size:14px;color:var(--muted);margin-bottom:auto}
.dot{width:12px;height:12px;border-radius:999px;position:absolute;bottom:10px;left:50%;transform:translateX(-50%)}
.summary{margin-top:18px;text-align:center;color:var(--accent);font-weight:700;padding:10px}
.payment-section{margin-top:14px;padding:12px;background:rgba(255,255,255,0.02);border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
.payment-item{display:flex;justify-content:space-between;padding:6px 4px;border-bottom:1px solid rgba(255,255,255,0.02);align-items:center}
.small{font-size:13px;color:var(--muted)}
.add-pay{position:absolute;right:22px;bottom:22px;background:var(--accent);border:0;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer}

/* modal */
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;z-index:999}
.modal .card{width:460px;background:var(--card);padding:18px;border-radius:12px;box-shadow:0 16px 40px rgba(0,0,0,0.6);max-height:86vh;overflow:auto}
.modal h2{text-align:center;color:var(--accent);margin:4px 0 12px}
.close{position:absolute;right:22px;top:18px;cursor:pointer;color:#fff;font-weight:700}
.staff-row{display:flex;justify-content:space-between;align-items:center;padding:8px 6px;border-radius:8px;margin-bottom:8px;background:rgba(255,255,255,0.015)}
.buttons button{margin-left:6px;padding:6px 8px;border-radius:8px;border:0;color:#fff;cursor:pointer;font-weight:700}
.present{background:var(--present)} .half{background:var(--half)} .absent{background:var(--absent)} .leave{background:var(--leave)} .ot{background:var(--ot)} .clear{background:#546275}
.ot-input{width:86px;padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:var(--text);margin-left:8px}

/* responsive */
@media (max-width:700px){
 .container{margin:12px}
 .modal .card{width:92%}
 .calendar{grid-template-columns:repeat(4,1fr)}
}
</style>
</head>
<body>

<header>
  <div class="logo">MG</div>
  <div>
    <a href="dashboard.html" class="btn">← Dashboard</a>
    <button id="logoutBtn" class="btn">Logout</button>
  </div>
</header>

<div class="container">
  <h1>Attendance Calendar</h1>

  <div class="controls">
    <select id="staffSelect"><option value="">Select Staff</option></select>

    <div class="month-nav">
      <button id="prevMonth" class="month-btn">⟨</button>
      <div id="monthYear" style="color:var(--text);font-weight:700"></div>
      <button id="nextMonth" class="month-btn">⟩</button>
    </div>
  </div>

  <div id="calendar" class="calendar"></div>

  <div id="salarySummary" class="summary">Select a staff to view per-day, earnings, paid and remaining</div>

  <div id="paymentSection" class="payment-section" style="display:none">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div style="color:var(--accent);font-weight:700">Payment History (this month)</div>
      <div class="small">Delete to remove incorrect entries</div>
    </div>
    <div id="paymentList"></div>
  </div>

  <button id="addPaymentBtn" class="add-pay">Add Payment</button>
</div>

<!-- attendance modal -->
<div id="attendanceModal" class="modal">
  <div class="card" role="dialog" aria-modal="true">
    <div style="position:relative">
      <span class="close" id="closeModal">✕</span>
      <h2 id="modalTitle">Mark Attendance</h2>
    </div>

    <div id="staffListArea"></div>
  </div>
</div>

<!-- payment modal -->
<div id="paymentModal" class="modal">
  <div class="card">
    <div style="position:relative">
      <span class="close" id="closePayModal">✕</span>
      <h2>Add Payment</h2>
    </div>

    <div style="margin-top:8px">
      <label class="small">Amount</label><br>
      <input id="payAmount" type="number" step="0.01" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:var(--text)"><br><br>
      <label class="small">Note (optional)</label><br>
      <input id="payNote" type="text" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:var(--text)"><br><br>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button id="cancelPay" class="btn" style="background:#3a4650">Cancel</button>
        <button id="savePay" class="btn">Save Payment</button>
      </div>
    </div>
  </div>
</div>

<script>
/* Storage keys */
const STAFF_KEY = "staffList";            // expected structure: [{name:"vikas", phone:"...", salary:20000}, ...]
const ATTEND_KEY = "attendanceData";      // map keys like "name_year_month_day" -> {status:'Present'|'Half'|'Absent'|'Leave'|'OT', ot: number}
const PAY_KEY = "paymentData";            // map keys like "name_year_month" -> [{amount:1000,note:"advance",date:"DD/MM/YYYY"}, ...]

/* load saved */
let staffList = JSON.parse(localStorage.getItem(STAFF_KEY)) || [];
let attendanceData = JSON.parse(localStorage.getItem(ATTEND_KEY)) || {};
let paymentData = JSON.parse(localStorage.getItem(PAY_KEY)) || {};

/* UI refs */
const staffSelect = document.getElementById("staffSelect");
const calendar = document.getElementById("calendar");
const monthYear = document.getElementById("monthYear");
const salarySummary = document.getElementById("salarySummary");
const paymentList = document.getElementById("paymentList");
const paymentSection = document.getElementById("paymentSection");

const attendanceModal = document.getElementById("attendanceModal");
const staffListArea = document.getElementById("staffListArea");
const closeModal = document.getElementById("closeModal");

const paymentModal = document.getElementById("paymentModal");
const addPaymentBtn = document.getElementById("addPaymentBtn");
const closePayModal = document.getElementById("closePayModal");
const savePay = document.getElementById("savePay");
const cancelPay = document.getElementById("cancelPay");
const payAmount = document.getElementById("payAmount");
const payNote = document.getElementById("payNote");

let curMonth = new Date().getMonth();
let curYear = new Date().getFullYear();
let selectedDay = null;

/* populate staff dropdown */
function loadStaffListUI(){
  staffList = JSON.parse(localStorage.getItem(STAFF_KEY)) || [];
  if(!staffList.length){
    staffSelect.innerHTML = `<option value="">No staff added</option>`;
    return;
  }
  staffSelect.innerHTML = `<option value="">Select Staff</option>` + staffList.map(s => `<option value="${s.name}">${s.name}</option>`).join("");
}

/* month UI */
function updateMonthUI(){
  const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];
  monthYear.textContent = `${months[curMonth]} ${curYear}`;
}

/* render calendar days */
function renderCalendar(){
  calendar.innerHTML = "";
  updateMonthUI();
  const name = staffSelect.value;
  if(!name) return; // prompt user to select staff
  const days = new Date(curYear, curMonth + 1, 0).getDate();
  for(let d=1; d<=days; d++){
    const k = `${name}_${curYear}_${curMonth}_${d}`;
    const rec = attendanceData[k];
    const div = document.createElement("div");
    div.className = "day";
    div.innerHTML = `<div class="day-number">${d}</div>`;
    if(rec){
      const dot = document.createElement("div");
      dot.className = "dot";
      if(rec.status === "Present") dot.style.background = "var(--present)";
      else if(rec.status === "Half") dot.style.background = "var(--half)";
      else if(rec.status === "Absent") dot.style.background = "var(--absent)";
      else if(rec.status === "Leave") dot.style.background = "var(--leave)";
      else if(rec.status === "OT") dot.style.background = "var(--ot)";
      else dot.style.background = "#888";
      div.appendChild(dot);
    }
    div.onclick = ()=> openAttendanceModal(d);
    calendar.appendChild(div);
  }
  updateSummary();
}

/* open modal listing staff with marking options for selected day */
function openAttendanceModal(day){
  const name = staffSelect.value;
  if(!name) return alert("Select staff first");
  selectedDay = day;
  attendanceModal.style.display = "flex";
  document.getElementById("modalTitle").textContent = `Mark: ${day}/${curMonth+1}/${curYear}`;

  // Build staff rows (list all staff so you can mark others too)
  staffList = JSON.parse(localStorage.getItem(STAFF_KEY)) || [];
  staffListArea.innerHTML = "";
  staffList.forEach(st => {
    const k = `${st.name}_${curYear}_${curMonth}_${day}`;
    const rec = attendanceData[k] || {status:"No", ot:0};

    const row = document.createElement("div");
    row.className = "staff-row";
    row.innerHTML = `
      <div>
        <div style="font-weight:700">${st.name}</div>
        <div class="small">${rec.status}${rec.ot ? ' (₹'+rec.ot+')':''}</div>
      </div>
      <div class="buttons">
        <button class="present">P</button>
        <button class="half">½</button>
        <button class="absent">A</button>
        <button class="leave">L</button>
        <button class="ot">OT</button>
        <button class="clear">CLR</button>
      </div>
    `;

    // buttons
    const btns = row.querySelectorAll(".buttons button");
    btns[0].addEventListener("click", ()=> setStatus(st.name, day, "Present"));
    btns[1].addEventListener("click", ()=> setStatus(st.name, day, "Half"));
    btns[2].addEventListener("click", ()=> setStatus(st.name, day, "Absent"));
    btns[3].addEventListener("click", ()=> setStatus(st.name, day, "Leave"));
    btns[4].addEventListener("click", ()=> { showOTInput(st.name, day, row, rec.ot); });
    btns[5].addEventListener("click", ()=> { clearStatus(st.name, day); });

    staffListArea.appendChild(row);
  });
}

/* set status helper */
function setStatus(name, day, status){
  const key = `${name}_${curYear}_${curMonth}_${day}`;
  attendanceData = JSON.parse(localStorage.getItem(ATTEND_KEY)) || attendanceData;
  attendanceData[key] = { status, ot: 0 };
  localStorage.setItem(ATTEND_KEY, JSON.stringify(attendanceData));
  renderCalendar();
  // keep modal open and refresh staff rows
  openAttendanceModal(selectedDay);
}

/* clear */
function clearStatus(name, day){
  const key = `${name}_${curYear}_${curMonth}_${day}`;
  attendanceData = JSON.parse(localStorage.getItem(ATTEND_KEY)) || attendanceData;
  delete attendanceData[key];
  localStorage.setItem(ATTEND_KEY, JSON.stringify(attendanceData));
  renderCalendar();
  openAttendanceModal(selectedDay);
}

/* show OT input inline (not prompt) */
function showOTInput(name, day, rowElem, currentOt){
  // remove any existing ot input
  const existing = rowElem.querySelector(".ot-input-wrap");
  if(existing) existing.remove();

  const wrap = document.createElement("div");
  wrap.className = "ot-input-wrap";
  wrap.style.display = "flex";
  wrap.style.alignItems = "center";
  wrap.style.marginTop = "8px";

  const inp = document.createElement("input");
  inp.type = "number";
  inp.placeholder = "OT ₹";
  inp.value = currentOt || "";
  inp.className = "ot-input";

  const save = document.createElement("button");
  save.textContent = "Save";
  save.className = "btn";
  save.style.marginLeft = "8px";
  save.addEventListener("click", ()=> {
    const v = parseFloat(inp.value);
    if(isNaN(v)){ alert("Enter valid amount"); return; }
    const key = `${name}_${curYear}_${curMonth}_${day}`;
    attendanceData = JSON.parse(localStorage.getItem(ATTEND_KEY)) || attendanceData;
    attendanceData[key] = { status: "OT", ot: v };
    localStorage.setItem(ATTEND_KEY, JSON.stringify(attendanceData));
    renderCalendar();
    openAttendanceModal(selectedDay);
  });

  wrap.appendChild(inp);
  wrap.appendChild(save);
  rowElem.appendChild(wrap);
}

/* payments */
function openPaymentModal(){
  const staffName = staffSelect.value;
  if(!staffName) return alert("Select staff first");
  payAmount.value = "";
  payNote.value = "";
  paymentModal.style.display = "flex";
}
function savePayment(){
  const staffName = staffSelect.value;
  if(!staffName) return;
  const amt = parseFloat(payAmount.value);
  if(isNaN(amt) || amt <= 0){ alert("Enter valid amount"); return; }
  const note = (payNote.value || "Payment").trim();
  const key = `${staffName}_${curYear}_${curMonth}`;
  if(!paymentData[key]) paymentData[key] = [];
  paymentData[key].push({ amount: amt, note, date: new Date().toLocaleDateString() });
  localStorage.setItem(PAY_KEY, JSON.stringify(paymentData));
  paymentModal.style.display = "none";
  updateSummaryAndPayments();
}

/* delete payment */
function deletePayment(index){
  const staffName = staffSelect.value;
  const key = `${staffName}_${curYear}_${curMonth}`;
  if(!paymentData[key]) return;
  paymentData[key].splice(index,1);
  localStorage.setItem(PAY_KEY, JSON.stringify(paymentData));
  updateSummaryAndPayments();
}

/* summary calculator + payment list render */
function updateSummaryAndPayments(){
  const name = staffSelect.value;
  if(!name){
    salarySummary.textContent = "Select a staff to view per-day, earnings, paid and remaining";
    paymentSection.style.display = "none";
    return;
  }
  // find staff info
  staffList = JSON.parse(localStorage.getItem(STAFF_KEY)) || staffList;
  const st = staffList.find(s=>s.name===name);
  if(!st){ salarySummary.textContent = "Select a staff to view per-day, earnings, paid and remaining"; paymentSection.style.display="none"; return; }
  const daysInMonth = new Date(curYear, curMonth+1, 0).getDate();
  const perDay = (parseFloat(st.salary) || 0) / daysInMonth;

  // count attendance
  let full=0, half=0, totalOT=0;
  for(let d=1; d<=daysInMonth; d++){
    const k = `${name}_${curYear}_${curMonth}_${d}`;
    const r = attendanceData[k];
    if(!r) continue;
    if(r.status==="Present") full++;
    if(r.status==="Half") half += 0.5;
    if(r.status==="OT") totalOT += (parseFloat(r.ot) || 0);
  }
  const earned = (full + half) * perDay + totalOT;
  const payKey = `${name}_${curYear}_${curMonth}`;
  const pays = paymentData[payKey] || [];
  const paidTotal = pays.reduce((s,p)=>s + (parseFloat(p.amount)||0), 0);
  const remaining = earned - paidTotal;
  salarySummary.innerHTML = `Per day: <strong>₹${perDay.toFixed(2)}</strong> &nbsp; | &nbsp; Earned: <strong>₹${earned.toFixed(2)}</strong> &nbsp; | &nbsp; Paid: <strong>₹${paidTotal.toFixed(2)}</strong> &nbsp; | &nbsp; Remaining: <strong>₹${remaining.toFixed(2)}</strong>`;

  // render payments list monthly (with delete)
  paymentList.innerHTML = "";
  if(pays.length === 0){
    paymentList.innerHTML = `<div style="text-align:center;color:var(--muted)">No payments yet for this month</div>`;
  } else {
    pays.forEach((p, idx) => {
      const row = document.createElement("div");
      row.className = "payment-item";
      row.innerHTML = `<div>${p.date} • ${p.note}</div><div><strong>₹${parseFloat(p.amount).toFixed(2)}</strong> &nbsp; <button style="background:#ef4444;border:0;color:#fff;padding:6px 8px;border-radius:6px;cursor:pointer" data-idx="${idx}">Delete</button></div>`;
      paymentList.appendChild(row);
      row.querySelector("button").addEventListener("click", ()=> {
        if(confirm("Delete this payment?")) deletePayment(idx);
      });
    });
  }
  paymentSection.style.display = "block";
}

/* events */
document.getElementById("prevMonth").addEventListener("click", ()=>{ curMonth--; if(curMonth<0){curMonth=11;curYear--} renderCalendar(); });
document.getElementById("nextMonth").addEventListener("click", ()=>{ curMonth++; if(curMonth>11){curMonth=0;curYear++} renderCalendar(); });

staffSelect.addEventListener("change", ()=>{
  renderCalendar();
  updateSummaryAndPayments();
});

closeModal.addEventListener("click", ()=> attendanceModal.style.display = "none");
window.addEventListener("click", (e)=> { if(e.target === attendanceModal) attendanceModal.style.display = "none"; });

addPaymentBtn.addEventListener("click", openPaymentModal);
closePayModal.addEventListener("click", ()=> paymentModal.style.display = "none");
cancelPay.addEventListener("click", ()=> paymentModal.style.display = "none");
savePay.addEventListener("click", savePayment);

document.getElementById("logoutBtn").addEventListener("click", ()=>{
  localStorage.removeItem("loggedInUser");
  location.href = "login.html";
});

/* initial load */
loadStaffListUI();
updateMonthUI();
renderCalendar();
updateSummaryAndPayments();

/* expose functions for inline use from modal rows (if needed) */
window.setStatus = setStatus;
window.clearStatus = clearStatus;

</script>
</body>
</html>
