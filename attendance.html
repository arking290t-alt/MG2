<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Attendance Calendar | MG</title>
  <style>
    :root {
      --bg: #0b111b;
      --card: rgba(255, 255, 255, 0.05);
      --accent: #00b4ff;
      --text: #e2e8f0;
      --present: #22c55e;
      --absent: #ef4444;
      --half: #f59e0b;
      --leave: #3b82f6;
      --ot: #a855f7;
    }
    * { box-sizing: border-box; font-family: 'Poppins', sans-serif; }
    body { background: var(--bg); color: var(--text); margin: 0; }
    header { display: flex; justify-content: space-between; align-items: center; padding: 15px 25px; background: rgba(255,255,255,0.05); border-bottom: 1px solid rgba(255,255,255,0.1); }
    .logo { color: var(--accent); font-size: 1.5rem; font-weight: 700; }
    .btn { background: var(--accent); border: none; color: white; padding: 8px 14px; border-radius: 8px; text-decoration: none; font-weight: 600; cursor: pointer; }
    .container { max-width: 1000px; margin: 30px auto; background: var(--card); padding: 25px; border-radius: 14px; box-shadow: 0 8px 30px rgba(0, 180, 255, 0.1); }
    h1 { text-align: center; color: var(--accent); margin-bottom: 20px; }
    .controls { display: flex; justify-content: space-between; align-items: center; margin: 15px 0; }
    select, button { padding: 8px 12px; border-radius: 8px; border: none; font-weight: 500; }
    .month-nav button { background: var(--accent); color: #fff; margin: 0 5px; cursor: pointer; }
    .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; margin-top: 10px; }
    .day-header { text-align: center; font-weight: 600; opacity: 0.8; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 6px; }
    .day { background: rgba(255,255,255,0.07); border-radius: 10px; padding: 15px; text-align: center; min-height: 70px; cursor: pointer; transition: 0.2s; display: flex; justify-content: center; align-items: center; font-size: 1.1rem; }
    .day:hover { background: rgba(255,255,255,0.12); }
    .present { background: var(--present) !important; color: #fff; }
    .absent { background: var(--absent) !important; color: #fff; }
    .half { background: var(--half) !important; color: #fff; }
    .leave { background: var(--leave) !important; color: #fff; }
    .ot { background: var(--ot) !important; color: #fff; }
    .stats { margin-top: 15px; text-align: center; font-weight: 500; color: var(--accent); }
    .payments { margin-top: 25px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); }
    .payments h3 { color: var(--accent); margin-bottom: 10px; }
    .payments button { margin-right: 10px; }
    .payment-entry { background: rgba(255,255,255,0.08); padding: 8px 10px; border-radius: 8px; margin: 5px 0; display: flex; justify-content: space-between; align-items: center; }
    .delete-btn { background: #ef4444; border: none; color: white; padding: 4px 8px; border-radius: 5px; cursor: pointer; }
  </style>
</head>
<body>
  <header>
    <div class="logo">MG</div>
    <a href="dashboard.html" class="btn">← Dashboard</a>
  </header>

  <div class="container">
    <h1>Attendance Calendar</h1>

    <div class="controls">
      <div class="month-nav">
        <button id="prevMonth">◀</button>
        <span id="monthLabel"></span>
        <button id="nextMonth">▶</button>
      </div>
      <select id="staffSelect">
        <option value="">Select Staff</option>
      </select>
    </div>

    <!-- Weekdays -->
    <div class="calendar" id="weekdays"></div>
    <!-- Calendar grid -->
    <div class="calendar" id="calendarGrid"></div>

    <!-- Stats -->
    <div class="stats" id="stats">Select a staff to view attendance</div>

    <!-- Payments -->
    <div class="payments">
      <h3>Payments</h3>
      <button class="btn" id="addPayment">+ Add Payment</button>
      <button class="btn" style="background:#ef4444;" id="deductPayment">− Deduct</button>
      <div id="paymentList"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC6BmLTjzOHwTa2VEYa9eYkClDtS__zvTM",
      authDomain: "mg-manager-3ab66.firebaseapp.com",
      projectId: "mg-manager-3ab66",
      storageBucket: "mg-manager-3ab66.appspot.com",
      messagingSenderId: "330667005987",
      appId: "1:330667005987:web:95de27b6259ace9fc6b996",
      measurementId: "G-05HW0KSN38"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const weekdays = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
    const weekdaysEl = document.getElementById("weekdays");
    weekdaysEl.innerHTML = weekdays.map(day => `<div class='day-header'>${day}</div>`).join("");

    const calendarGrid = document.getElementById("calendarGrid");
    const monthLabel = document.getElementById("monthLabel");
    const statsEl = document.getElementById("stats");
    const paymentList = document.getElementById("paymentList");
    let currentDate = new Date();
    let currentStaff = "";

    function renderCalendar() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const firstDayIndex = (firstDay.getDay() + 6) % 7;
      monthLabel.textContent = currentDate.toLocaleString("default", { month: "long", year: "numeric" });
      calendarGrid.innerHTML = "";
      for (let i = 0; i < firstDayIndex; i++) calendarGrid.innerHTML += `<div></div>`;
      for (let d = 1; d <= lastDay.getDate(); d++) {
        const dayDiv = document.createElement("div");
        dayDiv.className = "day";
        dayDiv.textContent = d;
        dayDiv.onclick = () => markAttendance(d);
        calendarGrid.appendChild(dayDiv);
      }
    }

    document.getElementById("prevMonth").onclick = () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); };
    document.getElementById("nextMonth").onclick = () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); };

    renderCalendar();

    async function loadStaff() {
      const staffSelect = document.getElementById("staffSelect");
      const snap = await getDocs(collection(db, "staff"));
      snap.forEach(docSnap => {
        const data = docSnap.data();
        const option = document.createElement("option");
        option.value = data.name;
        option.textContent = data.name;
        staffSelect.appendChild(option);
      });
    }

    function markAttendance(day) {
      if (!currentStaff) return alert("Select a staff first!");
      const markBox = document.createElement("div");
      markBox.innerHTML = `
        <div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:9999;">
          <div style="background:#1e293b;padding:20px;border-radius:12px;text-align:center;width:300px;">
            <h3 style="margin-bottom:10px;">Mark ${day} ${monthLabel.textContent}</h3>
            <button id="p" style="background:#22c55e;padding:8px 14px;border:none;border-radius:6px;color:white;margin:4px;">Present</button>
            <button id="h" style="background:#f59e0b;padding:8px 14px;border:none;border-radius:6px;color:white;margin:4px;">Half</button>
            <button id="a" style="background:#ef4444;padding:8px 14px;border:none;border-radius:6px;color:white;margin:4px;">Absent</button>
            <button id="l" style="background:#3b82f6;padding:8px 14px;border:none;border-radius:6px;color:white;margin:4px;">Leave</button>
            <button id="o" style="background:#a855f7;padding:8px 14px;border:none;border-radius:6px;color:white;margin:4px;">OT</button>
            <br><button id="c" style="margin-top:10px;padding:6px 10px;">Cancel</button>
          </div>
        </div>
      `;
      document.body.appendChild(markBox);
      markBox.querySelector("#c").onclick = () => markBox.remove();
    }

    // Payment actions
    document.getElementById("addPayment").onclick = async () => {
      if (!currentStaff) return alert("Select a staff first!");
      const amt = prompt("Enter payment amount:");
      if (!amt || isNaN(amt)) return;
      await addDoc(collection(db, "payments"), { staff: currentStaff, amount: parseFloat(amt), type: "add", date: new Date().toISOString() });
      loadPayments();
    };

    document.getElementById("deductPayment").onclick = async () => {
      if (!currentStaff) return alert("Select a staff first!");
      const amt = prompt("Enter deduction amount:");
      if (!amt || isNaN(amt)) return;
      await addDoc(collection(db, "payments"), { staff: currentStaff, amount: parseFloat(amt), type: "deduct", date: new Date().toISOString() });
      loadPayments();
    };

    async function loadPayments() {
      paymentList.innerHTML = "";
      const snap = await getDocs(collection(db, "payments"));
      snap.forEach(d => {
        const p = d.data();
        if (p.staff === currentStaff) {
          const div = document.createElement("div");
          div.className = "payment-entry";
          div.innerHTML = `
            <span>${p.type === "add" ? "+" : "-"} ₹${p.amount} (${new Date(p.date).toLocaleDateString()})</span>
            <button class="delete-btn">X</button>`;
          div.querySelector(".delete-btn").onclick = async () => { await deleteDoc(doc(db, "payments", d.id)); loadPayments(); };
          paymentList.appendChild(div);
        }
      });
    }

    document.getElementById("staffSelect").onchange = (e) => {
      currentStaff = e.target.value;
      statsEl.textContent = currentStaff ? `Showing stats for ${currentStaff}` : "Select a staff to view attendance";
      if (currentStaff) loadPayments();
    };

    loadStaff();
  </script>
</body>
</html>
