<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Attendance | MG</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body {
      overflow-x: hidden;
      background: #0b111b;
      color: #fff;
      font-family: 'Poppins', sans-serif;
    }

    .attendance-wrap {
      display: flex;
      gap: 28px;
      align-items: flex-start;
      width: 100%;
      max-width: 1100px;
      margin: 0 auto;
    }

    .staff-list-col {
      width: 220px;
    }

    .staff-list-col h4 {
      color: #00b4ff;
      margin-bottom: 10px;
      text-align: left;
    }

    .staff-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .staff-quick {
      padding: 12px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.05);
      cursor: pointer;
      border: 1px solid rgba(255, 255, 255, 0.04);
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.2s;
    }

    .staff-quick:hover {
      background: rgba(0, 180, 255, 0.08);
    }

    .staff-quick.active {
      background: rgba(0, 180, 255, 0.15);
      box-shadow: 0 0 10px rgba(0, 180, 255, 0.25);
    }

    .calendar-col {
      flex: 1;
      position: relative;
    }

    .cal-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .cal-nav {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .cal-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 10px;
      margin-top: 15px;
    }

    .cal-day {
      position: relative;
      padding: 10px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.08);
      min-height: 100px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .cal-day:hover {
      background: rgba(0, 180, 255, 0.12);
      transform: scale(1.03);
      box-shadow: 0 0 12px rgba(0, 180, 255, 0.25);
    }

    .date-num {
      position: absolute;
      top: 8px;
      left: 10px;
      font-size: 0.9rem;
      font-weight: 600;
      color: #aaa;
    }

    .status {
      margin-top: 35px;
      display: flex;
      justify-content: center;
    }

    .badge-sm {
      padding: 5px 10px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.8rem;
      color: #fff;
    }

    .present {
      background: #16a34a;
    }

    .halfday {
      background: #22d3ee;
      color: #000;
    }

    .absent {
      background: #ef4444;
    }

    .leave {
      background: #f59e0b;
      color: #000;
    }

    .ot {
      background: #8b5cf6;
    }

    .notmarked {
      background: rgba(255, 255, 255, 0.05);
      border: 1px dashed rgba(255, 255, 255, 0.1);
      color: #888;
    }

    .weekday {
      text-align: center;
      font-weight: 700;
      color: #aaa;
      padding: 6px 0;
    }

    .month-title {
      font-weight: 700;
      font-size: 1.1rem;
      color: #00b4ff;
    }

    .salary-bar {
      margin-top: 25px;
      text-align: center;
      font-weight: 600;
      color: #00b4ff;
      font-size: 1rem;
    }

    .paid-box {
      margin-top: 20px;
      text-align: right;
      color: #ccc;
      font-size: 0.9rem;
      background: rgba(255, 255, 255, 0.03);
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .paid-box strong {
      color: #00b4ff;
    }

    .paid-input {
      margin-top: 10px;
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 8px;
    }

    .paid-btn {
      background: #00b4ff;
      border: none;
      color: #fff;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
    }

    #paidInput {
      width: 160px;
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid rgba(255, 255, 255, 0.15);
      background: #0d141e;
      color: #fff;
    }

    .popup {
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      background: #1a2433;
      border: 1px solid #00b4ff40;
      padding: 16px;
      border-radius: 12px;
      z-index: 1000;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7);
    }

    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.45);
      z-index: 900;
    }

    #otRow {
      display: none;
      margin-top: 10px;
      gap: 8px;
    }

    #otAmountInput {
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid rgba(255, 255, 255, 0.15);
      width: 120px;
      background: #0d141e;
      color: #fff;
    }

    button:hover {
      opacity: 0.8;
    }
  </style>
</head>

<body class="staff-body">
  <header class="top-bar">
    <div class="top-left"><h1 class="logo">MG</h1></div>
    <div class="top-right">
      <a href="staff.html" class="btn-back">← Staff Management</a>
      <button id="logoutBtn" class="btn-logout">Logout</button>
    </div>
  </header>

  <main class="center-stage" style="padding-top:30px;padding-bottom:60px;">
    <section class="staff-card-panel" style="width:100%;max-width:1200px;">
      <h2 class="panel-title">Attendance & Salary Calendar</h2>
      <p class="panel-sub">Mark Present, Half Day, Absent, Leave or OT (manual entry).</p>

      <div class="attendance-wrap">
        <div class="staff-list-col">
          <h4>Staff</h4>
          <div id="staffList" class="staff-list"></div>
        </div>

        <div class="calendar-col">
          <div class="cal-top">
            <div class="cal-nav">
              <button id="prevMonth">←</button>
              <div class="month-title" id="monthTitle"></div>
              <button id="nextMonth">→</button>
            </div>
            <button id="todayBtn" class="btn-back">Today</button>
          </div>

          <div class="cal-grid" id="weekdays">
            <div class="weekday">Sun</div><div class="weekday">Mon</div><div class="weekday">Tue</div>
            <div class="weekday">Wed</div><div class="weekday">Thu</div><div class="weekday">Fri</div><div class="weekday">Sat</div>
          </div>

          <div class="cal-grid" id="calendarGrid"></div>
          <div id="salarySummary" class="salary-bar">Earnings this month: ₹0</div>

          <!-- Paid Amount Section -->
          <div id="paidSection" class="paid-box">
            <div><strong>Paid Amounts:</strong> <span id="paidList">None</span></div>
            <div><strong>Total Paid:</strong> ₹<span id="paidTotal">0</span></div>
            <div><strong>Remaining:</strong> ₹<span id="remaining">0</span></div>
            <div class="paid-input">
              <input id="paidInput" type="number" placeholder="Enter paid amount (₹)" min="0" />
              <button id="addPaid" class="paid-btn">Add</button>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <div id="overlay" class="overlay" style="display:none;"></div>
  <div id="popup" class="popup" style="display:none;min-width:350px;">
    <div id="popupTitle" style="font-weight:700;"></div>
    <div id="popupBtns" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;">
      <button data-status="Present" style="background:#16a34a">Present</button>
      <button data-status="Half Day" style="background:#22d3ee;color:#000;">Half Day</button>
      <button data-status="Absent" style="background:#ef4444">Absent</button>
      <button data-status="Leave" style="background:#f59e0b;color:#000">Leave</button>
      <button data-status="OT" style="background:#8b5cf6">OT</button>
      <button data-status="Clear" style="background:#374151;">Clear</button>
    </div>
    <div id="otRow">
      <label>OT amount (₹):</label>
      <input id="otAmountInput" type="number" min="0" step="1" />
      <button id="otSaveBtn">Save</button>
    </div>
  </div>

  <script>
    const STAFF_KEY = "staff", ATT_KEY = "attendance_by_staff", PAY_KEY = "payments_by_staff";
    let selectedStaff = localStorage.getItem("selected_staff") || null;
    let viewDate = new Date();
    let attendanceData = JSON.parse(localStorage.getItem(ATT_KEY)) || {};
    let paymentData = JSON.parse(localStorage.getItem(PAY_KEY)) || {};

    const staffList = document.getElementById("staffList");
    const calendar = document.getElementById("calendarGrid");
    const overlay = document.getElementById("overlay"), popup = document.getElementById("popup");
    const popupTitle = document.getElementById("popupTitle"), popupBtns = document.getElementById("popupBtns");
    const otRow = document.getElementById("otRow"), otAmountInput = document.getElementById("otAmountInput"), otSaveBtn = document.getElementById("otSaveBtn");

    const paidList = document.getElementById("paidList"), paidTotalEl = document.getElementById("paidTotal"), remainingEl = document.getElementById("remaining");

    function getStaff() { return JSON.parse(localStorage.getItem(STAFF_KEY)) || []; }
    function saveAttendance() { localStorage.setItem(ATT_KEY, JSON.stringify(attendanceData)); }
    function savePayments() { localStorage.setItem(PAY_KEY, JSON.stringify(paymentData)); }
    function localISO(d) { d = new Date(d); d.setMinutes(d.getMinutes() - d.getTimezoneOffset()); return d.toISOString().split("T")[0]; }

    function renderStaff() {
      const list = getStaff();
      staffList.innerHTML = "";
      if (!list.length) { staffList.innerHTML = "<p style='color:#999;text-align:center;'>No staff yet</p>"; return; }
      list.forEach(s => {
        const div = document.createElement("div");
        div.className = "staff-quick" + (s.name === selectedStaff ? " active" : "");
        div.textContent = s.name;
        div.onclick = () => { selectedStaff = s.name; localStorage.setItem("selected_staff", s.name); renderStaff(); renderCalendar(); };
        staffList.appendChild(div);
      });
    }

    function renderCalendar() {
      calendar.innerHTML = "";
      const year = viewDate.getFullYear(), month = viewDate.getMonth();
      const first = new Date(year, month, 1), daysInMonth = new Date(year, month + 1, 0).getDate();
      document.getElementById("monthTitle").textContent = first.toLocaleString("en-US", { month: "long", year: "numeric" });
      const start = first.getDay();
      for (let i = 0; i < start; i++) { const blank = document.createElement("div"); blank.className = "cal-day"; blank.style.visibility = "hidden"; calendar.appendChild(blank); }
      for (let d = 1; d <= daysInMonth; d++) {
        const iso = localISO(new Date(year, month, d));
        const div = document.createElement("div"); div.className = "cal-day";
        div.innerHTML = `<div class='date-num'>${d}</div>`;
        if (selectedStaff) {
          const rec = attendanceData[selectedStaff]?.[iso];
          let text = "No", cls = "notmarked";
          if (typeof rec === "string") { text = rec; cls = rec.toLowerCase().replace(" ", ""); }
          if (typeof rec === "object" && rec.status === "OT") { text = `OT ₹${rec.amount}`; cls = "ot"; }
          const badge = document.createElement("div");
          badge.className = `badge-sm ${cls}`; badge.textContent = text;
          const st = document.createElement("div"); st.className = "status"; st.appendChild(badge);
          div.appendChild(st);
          div.onclick = () => openPopup(selectedStaff, iso, new Date(year, month, d));
        }
        calendar.appendChild(div);
      }
      updateSalary();
    }

    function openPopup(staff, iso, date) {
      popupTitle.textContent = `${staff} — ${date.toDateString()}`;
      overlay.style.display = "block"; popup.style.display = "block"; otRow.style.display = "none";
      popupBtns.onclick = e => {
        const btn = e.target.closest("button"); if (!btn) return;
        const s = btn.dataset.status;
        if (!attendanceData[staff]) attendanceData[staff] = {};
        if (s === "Clear") { delete attendanceData[staff][iso]; saveAttendance(); closePopup(); renderCalendar(); return; }
        if (s === "OT") {
          otRow.style.display = "flex";
          const prev = attendanceData[staff][iso];
          otAmountInput.value = (prev && typeof prev === "object" && prev.status === "OT") ? prev.amount : "";
          otSaveBtn.onclick = () => {
            const amt = parseFloat(otAmountInput.value);
            if (!isNaN(amt)) { attendanceData[staff][iso] = { status: "OT", amount: amt }; saveAttendance(); closePopup(); renderCalendar(); }
          }; return;
        }
        attendanceData[staff][iso] = s; saveAttendance(); closePopup(); renderCalendar();
      };
    }

    function closePopup() { overlay.style.display = "none"; popup.style.display = "none"; otRow.style.display = "none"; }

    function updateSalary() {
      const el = document.getElementById("salarySummary");
      if (!selectedStaff) { el.textContent = "Earnings this month: ₹0"; return; }
      const st = getStaff().find(s => s.name === selectedStaff);
      if (!st || !st.salary) { el.textContent = "Earnings this month: ₹0"; return; }
      const salary = parseFloat(st.salary) || 0;
      const y = viewDate.getFullYear(), m = viewDate.getMonth();
      const daysInMonth = new Date(y, m + 1, 0).getDate(), perDay = salary / daysInMonth;
      const recs = attendanceData[selectedStaff] || {};
      let p = 0, h = 0, ot = 0;
      Object.keys(recs).forEach(k => {
        const [yy, mm] = k.split("-").map(Number);
        if (yy === y && mm === m + 1) {
          const r = recs[k];
          if (r === "Present") p++;
          if (r === "Half Day") h++;
          if (typeof r === "object" && r.status === "OT") ot += r.amount;
        }
      });
      const total = Math.round(p * perDay + h * (perDay / 2) + ot);
      el.textContent = `Earnings this month: ₹${total} (Full: ${p}, Half: ${h}, OT: ₹${ot}, ₹${perDay.toFixed(2)}/day)`;
      updatePaidSection(total);
    }

    // ===== Paid Amount System =====
    function updatePaidSection(total) {
      if (!selectedStaff) return;
      const y = viewDate.getFullYear(), m = viewDate.getMonth() + 1;
      const monthKey = `${y}-${m}`;
      const list = (paymentData[selectedStaff]?.[monthKey]) || [];
      const totalPaid = list.reduce((a, b) => a + b, 0);
      paidList.textContent = list.length ? list.map(x => "₹" + x).join(" | ") : "None";
      paidTotalEl.textContent = totalPaid;
      remainingEl.textContent = Math.max(0, total - totalPaid);
    }

    document.getElementById("addPaid").onclick = () => {
      if (!selectedStaff) return alert("Select a staff first!");
      const val = parseFloat(document.getElementById("paidInput").value);
      if (isNaN(val) || val <= 0) return alert("Enter a valid amount");
      const y = viewDate.getFullYear(), m = viewDate.getMonth() + 1;
      const monthKey = `${y}-${m}`;
      if (!paymentData[selectedStaff]) paymentData[selectedStaff] = {};
      if (!paymentData[selectedStaff][monthKey]) paymentData[selectedStaff][monthKey] = [];
      paymentData[selectedStaff][monthKey].push(val);
      savePayments();
      document.getElementById("paidInput").value = "";
      renderCalendar();
    };

    document.getElementById("logoutBtn").onclick = () => { localStorage.removeItem("loggedInUser"); location = "login.html"; };
    document.getElementById("prevMonth").onclick = () => { viewDate.setMonth(viewDate.getMonth() - 1); renderCalendar(); };
    document.getElementById("nextMonth").onclick = () => { viewDate.setMonth(viewDate.getMonth() + 1); renderCalendar(); };
    document.getElementById("todayBtn").onclick = () => { viewDate = new Date(); renderCalendar(); };
    overlay.onclick = closePopup;

    renderStaff();
    renderCalendar();
  </script>
</body>
</html>
