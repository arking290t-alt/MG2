<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Attendance | MG</title>
  <style>
    :root{
      --bg:#0b111b;--card:rgba(255,255,255,0.05);--accent:#00b4ff;--text:#d4e1f0;
      --present:#22c55e;--half:#3b82f6;--absent:#ef4444;--leave:#f59e0b;--ot:#8b5cf6;
    }
    *{box-sizing:border-box;font-family:'Poppins',sans-serif}
    body{background:var(--bg);color:var(--text);margin:0}
    header{display:flex;justify-content:space-between;align-items:center;padding:12px 22px;background:rgba(255,255,255,0.04);border-bottom:1px solid rgba(255,255,255,0.08)}
    .logo{color:var(--accent);font-weight:700;font-size:1.4rem}
    .btn{background:var(--accent);border:none;color:#fff;padding:8px 14px;border-radius:8px;cursor:pointer}
    .container{max-width:1100px;margin:28px auto;padding:22px;background:var(--card);border-radius:12px}
    h1{text-align:center;color:var(--accent);margin:6px 0 14px}
    #staffSelect{display:block;margin:0 auto 18px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.08);padding:10px;border-radius:8px;width:260px;color:#fff}
    .month-nav{display:flex;justify-content:center;align-items:center;gap:12px;margin-bottom:18px}
    .month-nav button{background:none;border:none;color:var(--accent);font-size:1.4rem;cursor:pointer}
    .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:10px}
    .day{background:rgba(255,255,255,0.03);padding:10px;border-radius:10px;height:92px;position:relative;cursor:pointer;display:flex;flex-direction:column;align-items:flex-start;justify-content:flex-start}
    .day .num{font-weight:700;color:#fff}
    .dot{width:12px;height:12px;border-radius:50%;position:absolute;bottom:10px;left:50%;transform:translateX(-50%)}
    .summary{margin-top:18px;text-align:center;color:var(--accent);font-weight:700}
    .payment-section{margin-top:18px;background:rgba(255,255,255,0.03);padding:12px;border-radius:10px}
    .payment-list{margin-top:10px;max-height:180px;overflow:auto}
    .payment-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);margin-bottom:8px}
    .pay-add{display:flex;gap:8px;align-items:center}
    .small-btn{background:#0b1720;border:1px solid rgba(255,255,255,0.06);color:var(--accent);padding:8px;border-radius:8px;cursor:pointer}
    .del-pay{background:#ef4444;border:none;color:#fff;padding:6px 8px;border-radius:6px;cursor:pointer}
    /* modal */
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);justify-content:center;align-items:center}
    .modal-content{background:var(--card);padding:16px;border-radius:10px;width:380px}
    .status-actions button{border:none;padding:8px 10px;border-radius:8px;margin:4px;cursor:pointer;color:#fff;font-weight:700}
    .present{background:var(--present)}.half{background:var(--half)}.absent{background:var(--absent)}.leave{background:var(--leave)}.ot{background:var(--ot)}.clear{background:#64748b}
  </style>
</head>
<body>
  <header>
    <div class="logo">MG</div>
    <div>
      <a href="dashboard.html" class="btn">← Dashboard</a>
      <button id="logoutBtn" class="btn">Logout</button>
    </div>
  </header>

  <div class="container">
    <h1>Attendance Calendar</h1>

    <select id="staffSelect"><option value="">Select Staff</option></select>

    <div class="month-nav">
      <button id="prevMonth">⟨</button>
      <h2 id="monthYear"></h2>
      <button id="nextMonth">⟩</button>
    </div>

    <div id="calendar" class="calendar"></div>

    <div class="summary" id="salarySummary">Select a staff to view attendance</div>

    <div class="payment-section">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong style="color:var(--accent)">Payments</strong>
        <div class="pay-add">
          <button id="addPaymentBtn" class="small-btn">+ Add Payment</button>
          <button id="deductPaymentBtn" class="small-btn" style="color:#fff;background:#ef4444">− Deduct</button>
        </div>
      </div>

      <div id="paymentList" class="payment-list"></div>
    </div>
  </div>

  <div id="attendanceModal" class="modal">
    <div class="modal-content">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong id="modalTitle">Date</strong>
        <button id="closeModal" class="small-btn" style="background:transparent;border:0;color:var(--muted)">✕</button>
      </div>
      <div id="actions" style="margin-top:12px" class="status-actions"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, setDoc, doc, deleteDoc, query, where, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC6BmLTjzOHwTa2VEYa9eYkClDtS__zvTM",
      authDomain: "mg-manager-3ab66.firebaseapp.com",
      projectId: "mg-manager-3ab66",
      storageBucket: "mg-manager-3ab66.firebasestorage.app",
      messagingSenderId: "330667005987",
      appId: "1:330667005987:web:95de27b6259ace9fc6b996",
      measurementId: "G-05HW0KSN38"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // require logged in
    const logged = JSON.parse(localStorage.getItem('loggedInUser'));
    if (!logged) location.href = 'login.html';

    const staffSelect = document.getElementById('staffSelect');
    const calendar = document.getElementById('calendar');
    const monthYear = document.getElementById('monthYear');
    const salarySummary = document.getElementById('salarySummary');
    const addPaymentBtn = document.getElementById('addPaymentBtn');
    const deductPaymentBtn = document.getElementById('deductPaymentBtn');
    const paymentListDiv = document.getElementById('paymentList');
    const modal = document.getElementById('attendanceModal');
    const closeModal = document.getElementById('closeModal');
    const actions = document.getElementById('actions');
    const modalTitle = document.getElementById('modalTitle');

    let now = new Date();
    let currentMonth = now.getMonth();
    let currentYear = now.getFullYear();
    let currentDay = null;

    async function loadStaff(){
      staffSelect.innerHTML = '<option value="">Select Staff</option>';
      const snap = await getDocs(collection(db,'staff'));
      const arr = [];
      snap.forEach(d=> arr.push(d.data()));
      arr.sort((a,b)=> (a.name||'').localeCompare(b.name||''));
      staffSelect.innerHTML = '<option value="">Select Staff</option>' + arr.map(s=>`<option value="${s.name}">${s.name}</option>`).join('');
    }

    function updateMonthYear(){
      const months=["January","February","March","April","May","June","July","August","September","October","November","December"];
      monthYear.textContent = `${months[currentMonth]} ${currentYear}`;
    }

    async function renderCalendar(){
      calendar.innerHTML = '';
      updateMonthYear();
      const days = new Date(currentYear, currentMonth+1, 0).getDate();
      const staffName = staffSelect.value;
      // prefetch attendance for selected staff+month
      let attMap = {};
      if (staffName){
        const q = query(collection(db,'attendance'), where('staff','==',staffName), where('year','==',currentYear), where('month','==',currentMonth));
        const snap = await getDocs(q);
        snap.forEach(d=>{
          const a = d.data();
          attMap[a.day] = a; // keyed by day
        });
      }
      for (let d=1; d<=days; d++){
        const div = document.createElement('div');
        div.className='day';
        div.innerHTML = `<div class="num">${d}</div>`;
        const rec = attMap[d];
        if (rec){
          const dot = document.createElement('div');
          dot.className = 'dot';
          dot.style.background = rec.status === 'Present' ? 'var(--present)' :
                                 rec.status === 'Half' ? 'var(--half)' :
                                 rec.status === 'Absent' ? 'var(--absent)' :
                                 rec.status === 'Leave' ? 'var(--leave)' :
                                 rec.status === 'OT' ? 'var(--ot)' : '#888';
          div.appendChild(dot);
        }
        div.onclick = () => {
          if (!staffName) return alert('Select a staff first');
          openModal(d);
        };
        calendar.appendChild(div);
      }
      await updateSummaryAndPayments();
    }

    function openModal(day){
      currentDay = day;
      modal.style.display = 'flex';
      modalTitle.textContent = `${staffSelect.value} — ${day}/${currentMonth+1}/${currentYear}`;
      actions.innerHTML = `
        <button class="present" data-action="Present">Present</button>
        <button class="half" data-action="Half">Half</button>
        <button class="absent" data-action="Absent">Absent</button>
        <button class="leave" data-action="Leave">Leave</button>
        <button class="ot" data-action="OT">OT</button>
        <button class="clear" data-action="Clear">Clear</button>
      `;
      // attach handlers
      actions.querySelectorAll('button').forEach(b=>{
        b.onclick = async () => {
          const action = b.getAttribute('data-action');
          if (action === 'Clear'){
            await deleteDoc(doc(db,'attendance', attendanceDocId()));
          } else if (action === 'OT'){
            const amt = prompt('Enter OT amount (₹):');
            if (!amt || isNaN(amt)) return;
            await setAttendance('OT', parseFloat(amt));
          } else {
            await setAttendance(action, 0);
          }
          modal.style.display = 'none';
          renderCalendar();
        };
      });
    }

    function attendanceDocId(){
      return `${staffSelect.value}_${currentYear}_${currentMonth}_${currentDay}`;
    }

    async function setAttendance(status, otAmount){
      const id = attendanceDocId();
      const ref = doc(db,'attendance',id);
      await setDoc(ref,{
        staff: staffSelect.value,
        year: currentYear,
        month: currentMonth,
        day: currentDay,
        status,
        ot: otAmount||0,
        ts: serverTimestamp()
      });
    }

    closeModal.onclick = ()=> modal.style.display = 'none';
    window.onclick = e => { if (e.target === modal) modal.style.display = 'none'; };

    // payments
    addPaymentBtn.onclick = async () => {
      if (!staffSelect.value) return alert('Select staff first');
      const amount = prompt('Enter payment amount (₹):');
      if (!amount || isNaN(amount)) return;
      await addDoc(collection(db,'payments'), {
        staff: staffSelect.value,
        year: currentYear,
        month: currentMonth,
        amount: parseFloat(amount),
        type: 'add',
        ts: serverTimestamp()
      });
      await updateSummaryAndPayments();
      renderCalendar();
    };

    deductPaymentBtn.onclick = async () => {
      if (!staffSelect.value) return alert('Select staff first');
      const amount = prompt('Enter deduction amount (₹):');
      if (!amount || isNaN(amount)) return;
      await addDoc(collection(db,'payments'), {
        staff: staffSelect.value,
        year: currentYear,
        month: currentMonth,
        amount: -Math.abs(parseFloat(amount)),
        type: 'deduct',
        ts: serverTimestamp()
      });
      await updateSummaryAndPayments();
      renderCalendar();
    };

    async function updateSummaryAndPayments(){
      const staffName = staffSelect.value;
      if (!staffName){
        salarySummary.textContent = 'Select a staff to view attendance';
        paymentListDiv.innerHTML = '';
        return;
      }

      // compute attendance totals (present/half/ot)
      const attQ = query(collection(db,'attendance'), where('staff','==',staffName), where('year','==',currentYear), where('month','==',currentMonth));
      const attSnap = await getDocs(attQ);
      let full=0, half=0, totOT=0;
      attSnap.forEach(d=>{
        const a = d.data();
        if (a.status === 'Present') full++;
        if (a.status === 'Half') half += 0.5;
        if (a.status === 'OT') totOT += (a.ot||0);
      });

      // read staff salary
      let salaryPerMonth = 0;
      const staffSnap = await getDocs(query(collection(db,'staff'), where('name','==',staffName)));
      staffSnap.forEach(d=> salaryPerMonth = d.data().salary || salaryPerMonth);
      const daysInMonth = new Date(currentYear,currentMonth+1,0).getDate();
      const perDay = salaryPerMonth / daysInMonth;
      const earnings = (full + half) * perDay + totOT;

      // payments
      const payQ = query(collection(db,'payments'), where('staff','==',staffName), where('year','==',currentYear), where('month','==',currentMonth), orderBy('ts','desc'));
      const paySnap = await getDocs(payQ);
      let totalPaid = 0;
      const pays = [];
      paySnap.forEach(d=>{
        const p = d.data();
        totalPaid += (p.amount||0);
        pays.push({ id: d.id, ...p, ts: p.ts });
      });

      const remaining = earnings - totalPaid;
      salarySummary.textContent = `Per Day: ₹${perDay.toFixed(2)} | Earnings: ₹${earnings.toFixed(2)} | Paid: ₹${totalPaid.toFixed(2)} | Remaining: ₹${remaining.toFixed(2)}`;

      // render payment list
      if (!pays.length) {
        paymentListDiv.innerHTML = `<p style="color:#9fb6d4">No payments this month.</p>`;
      } else {
        paymentListDiv.innerHTML = pays.map(p=>`
          <div class="payment-item">
            <div><strong>${p.amount < 0 ? '-₹'+Math.abs(p.amount).toFixed(2) : '₹'+p.amount.toFixed(2)}</strong><br><small style="color:#9fb6d4">${p.type} • ${p.ts?new Date(p.ts.seconds*1000).toLocaleString():''}</small></div>
            <div><button class="del-pay" data-id="${p.id}">Delete</button></div>
          </div>
        `).join('');
        // attach delete handlers
        paymentListDiv.querySelectorAll('.del-pay').forEach(btn=>{
          btn.onclick = async () => {
            const id = btn.getAttribute('data-id');
            if (!confirm('Delete this payment?')) return;
            await deleteDoc(doc(db,'payments',id));
            await updateSummaryAndPayments();
            renderCalendar();
          };
        });
      }
    }

    // nav & events
    document.getElementById('logoutBtn').onclick = ()=> { localStorage.removeItem('loggedInUser'); location.href='login.html'; };
    document.getElementById('prevMonth').onclick = ()=> { currentMonth--; if (currentMonth<0){currentMonth=11;currentYear--;} renderCalendar(); };
    document.getElementById('nextMonth').onclick = ()=> { currentMonth++; if (currentMonth>11){currentMonth=0;currentYear++} renderCalendar(); };
    staffSelect.onchange = ()=> { renderCalendar(); };

    // initial load
    (async function init(){
      await loadStaff();
      await renderCalendar();
    })();
  </script>
</body>
</html>
