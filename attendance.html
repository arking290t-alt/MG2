<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Attendance | MG</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header class="top-bar">
    <div class="logo">MG</div>
    <div>
      <a href="dashboard.html" class="btn-back">← Dashboard</a>
      <button id="logoutBtn" class="btn-logout">Logout</button>
    </div>
  </header>

  <div class="container">
    <h1>Attendance Calendar</h1>

    <select id="staffSelect"><option value="">Select Staff</option></select>

    <div class="month-nav">
      <button id="prevMonth">⟨</button>
      <h2 id="monthYear"></h2>
      <button id="nextMonth">⟩</button>
    </div>

    <div id="calendar" class="calendar"></div>
    <div class="summary" id="salarySummary">Select a staff to view attendance</div>

    <div class="payment-section">
      <div class="payment-header">
        <h3>Payments</h3>
        <div class="payment-actions">
          <button id="addPaymentBtn" class="add-btn">+ Add Payment</button>
          <button id="deductPaymentBtn" class="add-btn" style="background:#ef4444">− Deduct Payment</button>
        </div>
      </div>
      <div class="payment-list" id="paymentList"></div>
      <div class="paid-box">
        <strong>Total Paid:</strong> <span id="totalPaid">₹0</span>
        <button id="migrateLocalBtn" class="paid-btn" style="display:none">Migrate Local Data</button>
      </div>
    </div>
  </div>

  <!-- modal -->
  <div id="attendanceModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" id="closeModal">&times;</span>
      <h2 id="modalTitle">Date</h2>
      <div id="actions" class="status-actions"></div>
    </div>
  </div>

  <script type="module">
    // firebase init
    const firebaseConfig = {
      apiKey: "AIzaSyC6BmLTjzOHwTa2VEYa9eYkClDtS__zvTM",
      authDomain: "mg-manager-3ab66.firebaseapp.com",
      projectId: "mg-manager-3ab66",
      storageBucket: "mg-manager-3ab66.firebasestorage.app",
      messagingSenderId: "330667005987",
      appId: "1:330667005987:web:95de27b6259ace9fc6b996",
      measurementId: "G-05HW0KSN38"
    };
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, doc, setDoc, getDocs, query, where, deleteDoc, updateDoc, getDoc
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // DOM
    const staffSelect = document.getElementById("staffSelect");
    const calendar = document.getElementById("calendar");
    const salarySummary = document.getElementById("salarySummary");
    const addPaymentBtn = document.getElementById("addPaymentBtn");
    const deductPaymentBtn = document.getElementById("deductPaymentBtn");
    const paymentListDiv = document.getElementById("paymentList");
    const logoutBtn = document.getElementById("logoutBtn");
    const prevMonth = document.getElementById("prevMonth");
    const nextMonth = document.getElementById("nextMonth");
    const monthYear = document.getElementById("monthYear");
    const attendanceModal = document.getElementById("attendanceModal");
    const closeModal = document.getElementById("closeModal");
    const modalTitle = document.getElementById("modalTitle");
    const actions = document.getElementById("actions");
    const totalPaidEl = document.getElementById("totalPaid");
    const migrateLocalBtn = document.getElementById("migrateLocalBtn");

    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let currentDay = null;
    let currentUser = null;
    let currentUserRole = null;

    // Firestore collections
    const staffCol = collection(db, "staff");
    const attendanceCol = collection(db, "attendance");
    const paymentsCol = collection(db, "payments");

    // Auth guard
    onAuthStateChanged(auth, async (user) => {
      if (!user) return location.href = "login.html";
      currentUser = user;
      // read role
      const userDoc = await getDoc(doc(db, "users", user.uid));
      currentUserRole = userDoc.exists() && userDoc.data().role ? userDoc.data().role : "staff";
      if (currentUserRole === "owner") migrateLocalBtn.style.display = "inline-block";
      await loadStaffList();
      renderCalendar();
    });

    logoutBtn.onclick = async () => { await signOut(auth); location.href = "login.html"; };

    // Load staff list
    async function loadStaffList() {
      staffSelect.innerHTML = `<option value="">Select Staff</option>`;
      const snap = await getDocs(staffCol);
      const arr = [];
      snap.forEach(d => arr.push({ id: d.id, ...d.data() }));
      arr.sort((a,b)=> (a.name||"").localeCompare(b.name||""));
      arr.forEach(s => {
        const opt = document.createElement("option");
        opt.value = s.id;
        opt.textContent = s.name + (s.salary ? ` — ₹${s.salary}` : "");
        staffSelect.appendChild(opt);
      });
    }

    // Calendar
    async function renderCalendar() {
      calendar.innerHTML = "";
      monthYear.textContent = `${new Date(currentYear, currentMonth).toLocaleString('default',{month:'long'})} ${currentYear}`;
      const staffId = staffSelect.value;
      if (!staffId) return;
      const days = new Date(currentYear, currentMonth + 1, 0).getDate();
      for (let i=1;i<=days;i++){
        const div = document.createElement("div"); div.className="day"; div.textContent = i;
        // query attendance for that staff/day
        const q = query(attendanceCol, where("staffId","==",staffId), where("year","==",currentYear), where("month","==",currentMonth), where("day","==",i));
        const snaps = await getDocs(q);
        if (!snaps.empty) {
          const rec = snaps.docs[0].data();
          const dot = document.createElement("div"); dot.className="dot";
          dot.style.background = rec.status === "Present" ? "var(--present)" : rec.status === "Half" ? "var(--half)" : rec.status === "Absent" ? "var(--absent)" : rec.status === "Leave" ? "var(--leave)" : rec.status === "OT" ? "var(--ot)" : "#888";
          div.appendChild(dot);
        }
        div.onclick = ()=> openAttendanceModal(i);
        calendar.appendChild(div);
      }
      await updateSalarySummary();
      await renderPaymentList();
    }

    staffSelect.onchange = renderCalendar;

    // Modal actions
    function openAttendanceModal(day) {
      const staffId = staffSelect.value;
      if (!staffId) return alert("Select a staff first!");
      attendanceModal.style.display = "flex";
      modalTitle.textContent = `${day}/${currentMonth+1}/${currentYear}`;
      currentDay = day;
      actions.innerHTML = `
        <button class="present" onclick="window.mark('Present')">Present</button>
        <button class="half" onclick="window.mark('Half')">Half</button>
        <button class="absent" onclick="window.mark('Absent')">Absent</button>
        <button class="leave" onclick="window.mark('Leave')">Leave</button>
        <button class="ot" onclick="window.markOT()">OT</button>
        <button class="clear" onclick="window.clearStatus()">Clear</button>
      `;
    }
    closeModal.onclick = ()=> attendanceModal.style.display = "none";
    window.onclick = e => { if (e.target === attendanceModal) attendanceModal.style.display = "none"; };

    // attendance functions exposed globally for inline onclicks
    window.mark = async function(status) {
      const staffId = staffSelect.value; if (!staffId) return alert("Select a staff first!");
      const payload = { staffId, status, ot: 0, year: currentYear, month: currentMonth, day: currentDay, updatedAt: new Date().toISOString() };
      // check existing
      const q = query(attendanceCol, where("staffId","==",staffId), where("year","==",currentYear), where("month","==",currentMonth), where("day","==",currentDay));
      const snaps = await getDocs(q);
      if (!snaps.empty) await updateDoc(doc(db, "attendance", snaps.docs[0].id), payload);
      else await addDoc(attendanceCol, payload);
      attendanceModal.style.display = "none";
      renderCalendar();
    };

    window.markOT = async function() {
      const staffId = staffSelect.value; if (!staffId) return alert("Select a staff first!");
      const rate = prompt("Enter OT amount:"); if (!rate || isNaN(rate)) return;
      const payload = { staffId, status: "OT", ot: parseFloat(rate), year: currentYear, month: currentMonth, day: currentDay, updatedAt: new Date().toISOString() };
      const q = query(attendanceCol, where("staffId","==",staffId), where("year","==",currentYear), where("month","==",currentMonth), where("day","==",currentDay));
      const snaps = await getDocs(q);
      if (!snaps.empty) await updateDoc(doc(db, "attendance", snaps.docs[0].id), payload);
      else await addDoc(attendanceCol, payload);
      attendanceModal.style.display = "none";
      renderCalendar();
    };

    window.clearStatus = async function() {
      const staffId = staffSelect.value; if (!staffId) return alert("Select a staff first!");
      const q = query(attendanceCol, where("staffId","==",staffId), where("year","==",currentYear), where("month","==",currentMonth), where("day","==",currentDay));
      const snaps = await getDocs(q);
      if (!snaps.empty) await deleteDoc(doc(db, "attendance", snaps.docs[0].id));
      attendanceModal.style.display = "none";
      renderCalendar();
    };

    // Payments
    addPaymentBtn.onclick = () => openPaymentPrompt(false);
    deductPaymentBtn.onclick = () => openPaymentPrompt(true);

    async function openPaymentPrompt(isDeduct) {
      const staffId = staffSelect.value; if (!staffId) return alert("Select a staff first!");
      const amount = prompt(isDeduct ? "Enter deduction amount:" : "Enter payment amount:");
      if (!amount || isNaN(amount)) return;
      const payload = {
        staffId,
        amount: isDeduct ? -Math.abs(parseFloat(amount)) : Math.abs(parseFloat(amount)),
        type: isDeduct ? "deduct" : "add",
        date: new Date().toISOString(),
        createdBy: currentUser ? currentUser.uid : null
      };
      await addDoc(paymentsCol, payload);
      renderPaymentList();
      updateSalarySummary();
    }

    async function renderPaymentList() {
      const staffId = staffSelect.value; if (!staffId) { paymentListDiv.innerHTML = ""; return; }
      const q = query(paymentsCol, where("staffId","==",staffId), where("year","==",currentYear)); // note: payments may not have year/month; we use date instead
      // safer fetch all payments for staff and filter by month
      const snaps = await getDocs(query(paymentsCol, where("staffId","==",staffId)));
      const docs = [];
      snaps.forEach(d => docs.push({ id: d.id, ...d.data() }));
      // filter by month/year
      const list = docs.filter(p => {
        const dt = new Date(p.date || p.createdAt || Date.now());
        return dt.getFullYear() === currentYear && dt.getMonth() === currentMonth;
      }).sort((a,b)=> new Date(b.date) - new Date(a.date));
      paymentListDiv.innerHTML = list.length ? list.map(p=>`
        <div class="payment-item">
          <span style="color:${p.amount < 0 ? '#ef4444' : '#22c55e'};">
            ${p.amount < 0 ? '- ₹' + Math.abs(p.amount) : '₹' + p.amount}
            <small style="color:#aaa;"> (${new Date(p.date).toLocaleString()})</small>
          </span>
          <button class="delete-payment-btn" onclick="deletePayment('${p.id}', ${p.amount})">Delete</button>
        </div>
      `).join("") : `<p style="color:#aaa">No payments yet.</p>`;

      // total paid
      const total = list.reduce((s,p)=> s + (p.amount || 0), 0);
      totalPaidEl.textContent = `₹${total.toFixed(2)}`;
    }

    window.deletePayment = async function(id, amount) {
      if (!confirm("Delete this payment?")) return;
      await deleteDoc(doc(db, "payments", id));
      // deletion automatically reduces total because we recompute from docs
      await renderPaymentList();
      await updateSalarySummary();
    };

    // Salary summary: calculate earnings by reading attendance entries and OT
    async function updateSalarySummary() {
      const staffId = staffSelect.value; if (!staffId) return;
      // get staff doc
      const sdoc = await getDoc(doc(db, "staff", staffId));
      const staff = sdoc.exists() ? sdoc.data() : null;
      if (!staff) return;
      const days = new Date(currentYear, currentMonth + 1, 0).getDate();
      const perDay = (staff.salary || 0) / days;
      // fetch attendance for staff for month
      const snaps = await getDocs(query(attendanceCol, where("staffId","==",staffId)));
      let full = 0, half = 0, totalOT = 0;
      snaps.forEach(d => {
        const rec = d.data();
        if (rec.year === currentYear && rec.month === currentMonth) {
          if (rec.status === "Present") full++;
          else if (rec.status === "Half") half += 0.5;
          else if (rec.status === "OT") totalOT += (rec.ot || 0);
        }
      });
      const totalEarnings = (full + half) * perDay + totalOT;
      // compute paid
      const paymentSnaps = await getDocs(query(paymentsCol, where("staffId","==",staffId)));
      let paid = 0;
      paymentSnaps.forEach(d => {
        const p = d.data();
        const dt = new Date(p.date || p.createdAt || Date.now());
        if (dt.getFullYear() === currentYear && dt.getMonth() === currentMonth) paid += (p.amount || 0);
      });
      const remaining = totalEarnings - paid;
      salarySummary.textContent = `Per Day: ₹${perDay.toFixed(2)} | Earnings: ₹${totalEarnings.toFixed(2)} | Paid: ₹${paid.toFixed(2)} | Remaining: ₹${remaining.toFixed(2)}`;
    }

    // Prev/Next month
    prevMonth.onclick = () => { currentMonth--; if (currentMonth<0){ currentMonth=11; currentYear--; } renderCalendar(); };
    nextMonth.onclick = () => { currentMonth++; if (currentMonth>11){ currentMonth=0; currentYear++; } renderCalendar(); };

    // Migration helper (owner only)
    migrateLocalBtn.onclick = async () => {
      if (!confirm("Upload your local data (staff, attendance, payments) to Firestore? This runs once.")) return;
      migrateLocalBtn.textContent = "Migrating...";
      try {
        const staffList = JSON.parse(localStorage.getItem("staffList")) || [];
        const attendanceData = JSON.parse(localStorage.getItem("attendanceData")) || {};
        const paymentListData = JSON.parse(localStorage.getItem("paymentListData")) || {};
        // staff
        for (const s of staffList) await addDoc(staffCol, { name: s.name, salary: s.salary || 0, phone: s.phone || "" });
        // attendance
        for (const k in attendanceData) {
          const parts = k.split("_"); // staffName_year_month_day
          const staffName = parts[0];
          const year = parseInt(parts[1]); const month = parseInt(parts[2]); const day = parseInt(parts[3]);
          const rec = attendanceData[k];
          await addDoc(attendanceCol, { staffName, staffId: null, year, month, day, status: rec.status, ot: rec.ot || 0, migratedAt: new Date().toISOString() });
        }
        // payments
        for (const k in paymentListData) {
          const parts = k.split("_"); const staffName = parts[0]; const year = parseInt(parts[1]); const month = parseInt(parts[2]);
          for (const p of (paymentListData[k]||[])) {
            await addDoc(paymentsCol, { staffName, staffId: null, year, month, amount: p.amount, type: p.amount < 0 ? "deduct" : "add", date: p.date || new Date().toISOString(), migratedAt: new Date().toISOString() });
          }
        }
        alert("Migration done. You may clear localStorage after verifying data.");
      } catch (e) {
        console.error(e); alert("Migration failed: " + e.message);
      } finally { migrateLocalBtn.textContent = "Migrate Local Data"; }
    };

  </script>
</body>
</html>

