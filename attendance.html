<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Attendance Calendar | MG</title>
  <style>
    :root {
      --bg: #0b111b;
      --card: rgba(255, 255, 255, 0.05);
      --accent: #00b4ff;
      --text: #e2e8f0;
      --present: #22c55e;
      --absent: #ef4444;
      --half: #f59e0b;
      --leave: #3b82f6;
      --ot: #a855f7;
    }
    * { box-sizing: border-box; font-family: 'Poppins', sans-serif; }
    body { background: var(--bg); color: var(--text); margin: 0; }
    header { display: flex; justify-content: space-between; align-items: center; padding: 15px 25px; background: rgba(255,255,255,0.05); border-bottom: 1px solid rgba(255,255,255,0.1); }
    .logo { color: var(--accent); font-size: 1.5rem; font-weight: 700; }
    .btn { background: var(--accent); border: none; color: white; padding: 8px 14px; border-radius: 8px; text-decoration: none; font-weight: 600; cursor: pointer; }
    .container { max-width: 1000px; margin: 30px auto; background: var(--card); padding: 25px; border-radius: 14px; box-shadow: 0 8px 30px rgba(0,180,255,0.1); }
    h1 { text-align: center; color: var(--accent); margin-bottom: 20px; }
    .controls { display: flex; justify-content: space-between; align-items: center; margin: 15px 0; }
    select, button { padding: 8px 12px; border-radius: 8px; border: none; font-weight: 500; }
    .month-nav button { background: var(--accent); color: #fff; margin: 0 5px; cursor: pointer; }
    .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; margin-top: 10px; }
    .day-header { text-align: center; font-weight: 600; opacity: 0.8; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 6px; }
    .day { background: rgba(255,255,255,0.07); border-radius: 10px; padding: 15px; text-align: center; min-height: 70px; cursor: pointer; transition: 0.2s; display: flex; justify-content: center; align-items: center; font-size: 1.1rem; }
    .day:hover { background: rgba(255,255,255,0.12); }
    .present { background: var(--present) !important; color: #fff; }
    .absent { background: var(--absent) !important; color: #fff; }
    .half { background: var(--half) !important; color: #fff; }
    .leave { background: var(--leave) !important; color: #fff; }
    .ot { background: var(--ot) !important; color: #fff; }
    .stats { margin-top: 20px; text-align: center; font-weight: 500; color: var(--accent); }
    .payments { margin-top: 25px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); }
    .payments h3 { color: var(--accent); margin-bottom: 10px; text-align: center; }
    .payments button { margin: 5px; }
    .payment-entry { background: rgba(255,255,255,0.08); padding: 8px 10px; border-radius: 8px; margin: 5px 0; display: flex; justify-content: space-between; align-items: center; }
    .delete-btn { background: #ef4444; border: none; padding: 5px 10px; border-radius: 5px; color: white; cursor: pointer; }
  </style>
</head>
<body>
  <header>
    <div class="logo">MG</div>
    <a href="dashboard.html" class="btn">← Dashboard</a>
  </header>

  <div class="container">
    <h1>Attendance Calendar</h1>

    <div class="controls">
      <div class="month-nav">
        <button id="prevMonth">◀</button>
        <span id="monthLabel"></span>
        <button id="nextMonth">▶</button>
      </div>
      <select id="staffSelect">
        <option value="">Select Staff</option>
      </select>
    </div>

    <div class="calendar" id="weekdays"></div>
    <div class="calendar" id="calendarGrid"></div>

    <div class="stats" id="stats">Select a staff to view attendance</div>

    <div class="payments">
      <h3>Payments</h3>
      <div style="text-align:center;">
        <button class="btn" id="addPayment">+ Add Payment</button>
        <button class="btn" style="background:#f97316;" id="deductPayment">− Deduct</button>
      </div>
      <div id="paymentList"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import { getFirestore, collection, getDocs, setDoc, deleteDoc, doc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC6BmLTjzOHwTa2VEYa9eYkClDtS__zvTM",
      authDomain: "mg-manager-3ab66.firebaseapp.com",
      projectId: "mg-manager-3ab66",
      storageBucket: "mg-manager-3ab66.appspot.com",
      messagingSenderId: "330667005987",
      appId: "1:330667005987:web:95de27b6259ace9fc6b996",
      measurementId: "G-05HW0KSN38"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const weekdays = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
    document.getElementById("weekdays").innerHTML = weekdays.map(d => `<div class='day-header'>${d}</div>`).join("");

    const calendarGrid = document.getElementById("calendarGrid");
    const monthLabel = document.getElementById("monthLabel");
    const statsEl = document.getElementById("stats");
    const paymentList = document.getElementById("paymentList");

    let currentDate = new Date();
    let currentStaff = "";

    document.getElementById("prevMonth").onclick = () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); };
    document.getElementById("nextMonth").onclick = () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); };

    async function loadStaff() {
      const staffSelect = document.getElementById("staffSelect");
      const snap = await getDocs(collection(db, "staff"));
      snap.forEach(docSnap => {
        const d = docSnap.data();
        const opt = document.createElement("option");
        opt.value = d.name;
        opt.textContent = d.name;
        staffSelect.appendChild(opt);
      });
    }

    async function renderCalendar() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const firstDayIndex = (firstDay.getDay() + 6) % 7;
      monthLabel.textContent = currentDate.toLocaleString("default", { month: "long", year: "numeric" });

      calendarGrid.innerHTML = "";
      for (let i = 0; i < firstDayIndex; i++) calendarGrid.innerHTML += `<div></div>`;

      let attendanceData = {};
      if (currentStaff) {
        const snap = await getDocs(query(collection(db, "attendance"),
          where("staff", "==", currentStaff),
          where("month", "==", month),
          where("year", "==", year)
        ));
        snap.forEach(d => attendanceData[d.data().day] = d.data());
      }

      for (let d = 1; d <= lastDay.getDate(); d++) {
        const div = document.createElement("div");
        div.className = "day";
        div.textContent = d;
        if (attendanceData[d]) div.classList.add(attendanceData[d].status);
        div.onclick = () => markAttendance(d, attendanceData[d]);
        calendarGrid.appendChild(div);
      }

      if (currentStaff) updateStats();
    }

    async function markAttendance(day, existingData) {
      if (!currentStaff) return alert("Select a staff first!");

      const modal = document.createElement("div");
      modal.innerHTML = `
        <div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:9999;">
          <div style="background:#1e293b;padding:20px;border-radius:12px;text-align:center;width:300px;">
            <h3 style="margin-bottom:10px;">Mark ${day} ${monthLabel.textContent}</h3>
            <button id="p" style="background:#22c55e;padding:8px 14px;border:none;border-radius:6px;color:white;margin:4px;">Present</button>
            <button id="h" style="background:#f59e0b;padding:8px 14px;border:none;border-radius:6px;color:white;margin:4px;">Half</button>
            <button id="a" style="background:#ef4444;padding:8px 14px;border:none;border-radius:6px;color:white;margin:4px;">Absent</button>
            <button id="l" style="background:#3b82f6;padding:8px 14px;border:none;border-radius:6px;color:white;margin:4px;">Leave</button>
            <button id="o" style="background:#a855f7;padding:8px 14px;border:none;border-radius:6px;color:white;margin:4px;">OT</button>
            <br><button id="c" style="margin-top:10px;padding:6px 10px;">Cancel</button>
          </div>
        </div>`;
      document.body.appendChild(modal);

      const saveStatus = async (status, otAmount = 0) => {
        const data = {
          staff: currentStaff,
          day,
          month: currentDate.getMonth(),
          year: currentDate.getFullYear(),
          status,
          otAmount
        };
        await setDoc(doc(db, "attendance", `${currentStaff}_${day}_${currentDate.getMonth()}_${currentDate.getFullYear()}`), data);
        modal.remove();
        renderCalendar();
      };

      modal.querySelector("#p").onclick = () => saveStatus("present");
      modal.querySelector("#h").onclick = () => saveStatus("half");
      modal.querySelector("#a").onclick = () => saveStatus("absent");
      modal.querySelector("#l").onclick = () => saveStatus("leave");
      modal.querySelector("#o").onclick = () => {
        const amount = prompt("Enter OT amount (₹):");
        if (!amount || isNaN(amount)) return alert("Enter valid number!");
        saveStatus("ot", parseFloat(amount));
      };
      modal.querySelector("#c").onclick = () => modal.remove();
    }

    async function updateStats() {
      const month = currentDate.getMonth();
      const year = currentDate.getFullYear();

      const attendSnap = await getDocs(query(collection(db, "attendance"),
        where("staff", "==", currentStaff),
        where("month", "==", month),
        where("year", "==", year)
      ));
      const staffSnap = await getDocs(query(collection(db, "staff"), where("name", "==", currentStaff)));
      let salary = 0;
      staffSnap.forEach(d => salary = d.data().salary || 0);

      let present = 0, half = 0, otTotal = 0;
      attendSnap.forEach(d => {
        const a = d.data();
        if (a.status === "present") present++;
        else if (a.status === "half") half += 0.5;
        else if (a.status === "ot") otTotal += a.otAmount || 0;
      });

      const perDay = salary / 30;
      const earned = (present + half) * perDay + otTotal;

      const paySnap = await getDocs(query(collection(db, "payments"), where("staff", "==", currentStaff)));
      let paid = 0;
      paySnap.forEach(p => paid += p.data().amount);

      const remaining = earned - paid;

      statsEl.innerHTML = `
        Per Day: ₹${perDay.toFixed(2)} | Earned: ₹${earned.toFixed(2)} | OT: ₹${otTotal.toFixed(2)} | Paid: ₹${paid.toFixed(2)} | Remaining: ₹${remaining.toFixed(2)}
      `;
      loadPayments();
    }

    async function loadPayments() {
      paymentList.innerHTML = "";
      const paySnap = await getDocs(query(collection(db, "payments"), where("staff", "==", currentStaff), orderBy("date")));
      if (paySnap.empty) {
        paymentList.innerHTML = "<p style='text-align:center;color:#888;'>No payments yet.</p>";
        return;
      }
      paySnap.forEach(async (p) => {
        const d = p.data();
        const div = document.createElement("div");
        div.className = "payment-entry";
        div.innerHTML = `
          <span>${d.date} — ₹${d.amount}</span>
          <button class="delete-btn">Delete</button>
        `;
        div.querySelector(".delete-btn").onclick = async () => {
          if (confirm("Delete this payment?")) {
            await deleteDoc(doc(db, "payments", p.id));
            updateStats();
          }
        };
        paymentList.appendChild(div);
      });
    }

    document.getElementById("addPayment").onclick = async () => {
      if (!currentStaff) return alert("Select staff first!");
      const amount = prompt("Enter payment amount:");
      if (!amount || isNaN(amount)) return;
      await setDoc(doc(db, "payments", `${currentStaff}_${Date.now()}`), {
        staff: currentStaff,
        amount: parseFloat(amount),
        type: "add",
        date: new Date().toLocaleDateString()
      });
      updateStats();
    };

    document.getElementById("deductPayment").onclick = async () => {
      if (!currentStaff) return alert("Select staff first!");
      const amount = prompt("Enter deduction amount:");
      if (!amount || isNaN(amount)) return;
      await setDoc(doc(db, "payments", `${currentStaff}_${Date.now()}`), {
        staff: currentStaff,
        amount: -parseFloat(amount),
        type: "deduct",
        date: new Date().toLocaleDateString()
      });
      updateStats();
    };

    document.getElementById("staffSelect").onchange = e => {
      currentStaff = e.target.value;
      statsEl.textContent = currentStaff ? `Showing attendance for ${currentStaff}` : "Select a staff to view attendance";
      renderCalendar();
    };

    loadStaff();
    renderCalendar();
  </script>
</body>
</html>
