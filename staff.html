<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Staff | MG</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body class="staff-body">

  <!-- HEADER -->
  <header class="top-bar">
    <div class="top-left">
      <h1 class="logo">MG</h1>
    </div>
    <div class="top-right">
      <a href="dashboard.html" class="btn-back">‚Üê Dashboard</a>
      <button id="logoutBtn" class="btn-logout">Logout</button>
    </div>
  </header>

  <!-- MAIN CONTENT -->
  <main class="center-stage">
    <section class="staff-card-panel">
      <h2 class="panel-title">Staff Management</h2>
      <p class="panel-sub">Add, view, or delete staff members</p>

      <form id="staffForm" class="staff-form" autocomplete="off">
        <input id="staffName" type="text" placeholder="Staff name" required />
        <input id="staffPhone" type="tel" placeholder="Phone number (optional)" />
        <input id="staffSalary" type="number" placeholder="Salary / month (optional)" />
        <button class="btn-login add-btn" type="submit">Add Staff</button>
      </form>

      <div id="staffContainer" class="staff-list"></div>

      <h3 style="margin-top:2rem; text-align:center; color:var(--accent);">
        Attendance Summary (Last 7 days)
      </h3>
      <div id="attendanceStats" style="margin-top:1rem; text-align:center; color:#ccc;"></div>
    </section>
  </main>

  <script>
    // Logout
    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.removeItem("loggedInUser");
      window.location.href = "login.html";
    });

    // Helpers
    function getStaff() {
      return JSON.parse(localStorage.getItem("staff")) || [];
    }
    function saveStaff(list) {
      localStorage.setItem("staff", JSON.stringify(list));
      localStorage.setItem("staff_updated_at", Date.now());
    }

    const staffForm = document.getElementById("staffForm");
    const staffContainer = document.getElementById("staffContainer");
    const attendanceStatsEl = document.getElementById("attendanceStats");

    // Render staff
    function renderStaff() {
      const staff = getStaff();
      staffContainer.innerHTML = "";

      if (staff.length === 0) {
        staffContainer.innerHTML = "<p style='text-align:center;color:#888;'>No staff added yet.</p>";
        attendanceStatsEl.innerHTML = "";
        return;
      }

      staff.forEach((s, idx) => {
        const div = document.createElement("div");
        div.className = "staff-item";
        div.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div>
              <strong>${s.name}</strong><br>
              <small style="color:#aaa;">${s.phone || ""} ${
          s.salary ? "| ‚Çπ" + s.salary + "/month" : ""
        }</small>
            </div>
            <button class="btn-login" style="background:#ef4444;" onclick="deleteStaff(${idx})">Delete</button>
          </div>
        `;
        staffContainer.appendChild(div);
      });

      renderAttendanceStats();
    }

    // Add staff
    staffForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const name = document.getElementById("staffName").value.trim();
      const phone = document.getElementById("staffPhone").value.trim();
      const salary = document.getElementById("staffSalary").value.trim();

      if (!name) return alert("Please enter staff name.");
      const staff = getStaff();
      if (staff.some((x) => x.name.toLowerCase() === name.toLowerCase()))
        return alert("Staff already exists!");

      staff.push({ name, phone, salary });
      saveStaff(staff);
      staffForm.reset();
      renderStaff();
    });

    // Delete staff
    function deleteStaff(index) {
      const staff = getStaff();
      if (!confirm(`Delete ${staff[index].name}?`)) return;
      staff.splice(index, 1);
      saveStaff(staff);
      renderStaff();
    }

    // Attendance Summary
    function renderAttendanceStats() {
      const staff = getStaff();
      const attendance = JSON.parse(localStorage.getItem("attendance")) || {};
      const today = new Date();
      const cutoff = new Date(today);
      cutoff.setDate(today.getDate() - 6);

      // initialize counts
      const counts = {};
      staff.forEach((s) => (counts[s.name] = { Present: 0, Absent: 0, Leave: 0 }));

      // count attendance
      Object.keys(attendance).forEach((key) => {
        const [name, dateString] = key.split("_");
        const date = parseDate(dateString);
        if (!date || !counts[name]) return;
        if (date >= cutoff && date <= today) {
          const status = attendance[key];
          if (counts[name][status] !== undefined) {
            counts[name][status]++;
          }
        }
      });

      // build summary
      let html = "";
      staff.forEach((s) => {
        const c = counts[s.name] || { Present: 0, Absent: 0, Leave: 0 };
        html += `
          <div style="width:100%;max-width:520px;display:flex;justify-content:space-between;
          padding:8px 12px;margin:6px auto;border-radius:8px;background:rgba(255,255,255,0.04);">
            <div style="font-weight:600;">${s.name}</div>
            <div>
              <span style="color:#22c55e;">${c.Present} ‚úÖ</span>
              <span style="color:#ef4444;margin-left:8px;">${c.Absent} ‚ùå</span>
              <span style="color:#eab308;margin-left:8px;">${c.Leave} üïê</span>
            </div>
          </div>
        `;
      });

      attendanceStatsEl.innerHTML = html;
    }

    // Parse dates like "6/11/2025" or "06/11/2025"
    function parseDate(str) {
      const parts = str.split("/");
      if (parts.length < 3) return null;
      const day = parseInt(parts[0], 10);
      const month = parseInt(parts[1], 10) - 1;
      const year = parseInt(parts[2], 10);
      const d = new Date(year, month, day);
      return isNaN(d.getTime()) ? null : d;
    }

    // Listen for attendance updates
    window.addEventListener("storage", (e) => {
      if (e.key === "attendance" || e.key === "staff" || e.key === "staff_updated_at") {
        renderStaff();
      }
    });

    renderStaff();
  </script>

  <style>
    .staff-item {
      padding: 12px;
      border-radius: 10px;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.06);
    }
    .staff-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 1rem;
    }
  </style>
</body>
</html>
