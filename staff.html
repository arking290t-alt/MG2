<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Staff | MG</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .staff-list { display:flex; flex-direction:column; gap:12px; margin-top:1.2rem; }
    .staff-item { background:rgba(255,255,255,0.03); padding:14px 16px; border-radius:10px; border:1px solid rgba(255,255,255,0.05); display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px; }
    .staff-info { flex:1; }
    .staff-info strong { font-size:1.05rem; color:var(--text-main); }
    .staff-stats { font-size:0.9rem; color:var(--text-muted); margin-top:4px; }
    .staff-actions { display:flex; gap:8px; }
    .btn-small { padding:6px 10px; font-size:0.85rem; border-radius:6px; border:none; cursor:pointer; }
    .btn-del { background:#ef4444; color:#fff; }
    .btn-view { background:#0ea5e9; color:#fff; }
  </style>
</head>
<body class="staff-body">

  <header class="top-bar">
    <div class="top-left">
      <h1 class="logo">MG</h1>
    </div>
    <div class="top-right">
      <a href="dashboard.html" class="btn-back">‚Üê Dashboard</a>
      <button id="logoutBtn" class="btn-logout">Logout</button>
    </div>
  </header>

  <main class="center-stage">
    <section class="staff-card-panel">
      <h2 class="panel-title">Staff Management</h2>
      <p class="panel-sub">Add, view, or delete staff members</p>

      <!-- Add Staff Form -->
      <form id="staffForm" class="staff-form" autocomplete="off">
        <input id="staffName" type="text" placeholder="Staff name" required />
        <input id="staffPhone" type="tel" placeholder="Phone number (optional)" />
        <input id="staffSalary" type="number" placeholder="Salary / month (optional)" />
        <button class="btn-login add-btn" type="submit">Add Staff</button>
      </form>

      <!-- Staff List -->
      <div id="staffContainer" class="staff-list"></div>
    </section>
  </main>

  <script>
    const STAFF_KEY = "staff";
    const ATT_KEY = "attendance_by_staff";

    // Logout
    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.removeItem("loggedInUser");
      window.location.href = "login.html";
    });

    // Helpers
    function getStaff() {
      return JSON.parse(localStorage.getItem(STAFF_KEY)) || [];
    }

    function saveStaff(staff) {
      localStorage.setItem(STAFF_KEY, JSON.stringify(staff));
      localStorage.setItem("staff_updated_at", Date.now());
    }

    function getAttendance() {
      return JSON.parse(localStorage.getItem(ATT_KEY)) || {};
    }

    // Add Staff
    const staffForm = document.getElementById("staffForm");
    const staffContainer = document.getElementById("staffContainer");

    staffForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const name = document.getElementById("staffName").value.trim();
      const phone = document.getElementById("staffPhone").value.trim();
      const salary = document.getElementById("staffSalary").value.trim();

      if (!name) return alert("Enter staff name");
      const staff = getStaff();

      // Prevent duplicate names
      if (staff.some(s => s.name.toLowerCase() === name.toLowerCase())) {
        alert("Staff already exists!");
        return;
      }

      staff.push({ name, phone, salary });
      saveStaff(staff);

      // Reset attendance when new staff is added
      localStorage.setItem(ATT_KEY, JSON.stringify({}));
      localStorage.setItem("attendance_updated_at", Date.now());

      staffForm.reset();
      renderStaff();
    });

    // Delete Staff
    function deleteStaff(index) {
      const staff = getStaff();
      const name = staff[index].name;
      if (!confirm(`Delete ${name}?`)) return;
      staff.splice(index, 1);
      saveStaff(staff);

      // Remove their attendance record too
      const att = getAttendance();
      delete att[name];
      localStorage.setItem(ATT_KEY, JSON.stringify(att));
      localStorage.setItem("attendance_updated_at", Date.now());

      renderStaff();
    }

    // View Calendar
    function viewCalendar(name) {
      // Save selected staff in localStorage so attendance.html opens it
      localStorage.setItem("selected_staff", name);
      window.location.href = "attendance.html";
    }

    // Render Staff List with Stats
    function renderStaff() {
      const staff = getStaff();
      const attendance = getAttendance();
      staffContainer.innerHTML = "";

      if (staff.length === 0) {
        staffContainer.innerHTML = "<p style='text-align:center;color:#888;'>No staff added yet.</p>";
        return;
      }

      staff.forEach((s, i) => {
        const div = document.createElement("div");
        div.className = "staff-item";

        const attData = attendance[s.name] || {};
        let counts = { Present: 0, Absent: 0, Leave: 0 };

        Object.values(attData).forEach(status => {
          if (counts[status] !== undefined) counts[status]++;
        });

        div.innerHTML = `
          <div class="staff-info">
            <strong>${s.name}</strong>
            <div class="staff-stats">
              ‚úÖ ${counts.Present} &nbsp;&nbsp; ‚ùå ${counts.Absent} &nbsp;&nbsp; üïê ${counts.Leave}
            </div>
          </div>
          <div class="staff-actions">
            <button class="btn-small btn-view" onclick="viewCalendar('${s.name}')">View Calendar</button>
            <button class="btn-small btn-del" onclick="deleteStaff(${i})">Delete</button>
          </div>
        `;

        staffContainer.appendChild(div);
      });
    }

    // Sync updates when attendance changes
    window.addEventListener("storage", (e) => {
      if (e.key === ATT_KEY || e.key === "attendance_updated_at" || e.key === "staff_updated_at") {
        renderStaff();
      }
    });

    renderStaff();
  </script>
</body>
</html>
