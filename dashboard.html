<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard | MG</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body class="dashboard-body">
  <header class="top-bar">
    <h1 class="logo">MG</h1>
    <div>
      <button id="logoutBtn" class="btn-logout">Logout</button>
    </div>
  </header>

  <main class="dashboard-center">
    <div class="dashboard-box">
      <h2 class="welcome">Welcome</h2>
      <p class="subtitle">Manage staff, attendance, payments, and jobs</p>

      <div class="dashboard-grid">
        <a href="staff.html" class="dashboard-card">
          <h3>Staff</h3>
          <p>Manage & add staff</p>
        </a>

        <a href="attendance.html" class="dashboard-card">
          <h3>Attendance</h3>
          <p>Open attendance</p>
        </a>

        <a href="expenses.html" class="dashboard-card">
          <h3>Expenses</h3>
          <p>Track business expenses</p>
        </a>

        <a href="jobs.html" class="dashboard-card">
          <h3>Job Update</h3>
          <p>Add, manage & track job details</p>
        </a>
      </div>

      <div style="margin-top:18px;">
        <button id="migrateBtn" class="migrate-btn" style="display:none">
          Migrate Local Data → Firestore
        </button>
        <span id="migrateStatus" class="small"></span>
      </div>
    </div>
  </main>

  <script type="module">
    // Firebase initialization
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
    import { getFirestore, getDoc, doc, collection, addDoc } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC6BmLTjzOHwTa2VEYa9eYkClDtS__zvTM",
      authDomain: "mg-manager-3ab66.firebaseapp.com",
      projectId: "mg-manager-3ab66",
      storageBucket: "mg-manager-3ab66.firebasestorage.app",
      messagingSenderId: "330667005987",
      appId: "1:330667005987:web:95de27b6259ace9fc6b996",
      measurementId: "G-05HW0KSN38"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const logoutBtn = document.getElementById("logoutBtn");
    const migrateBtn = document.getElementById("migrateBtn");
    const migrateStatus = document.getElementById("migrateStatus");

    // Authentication check
    onAuthStateChanged(auth, async (user) => {
      if (!user) return (location.href = "login.html");
      const snap = await getDoc(doc(db, "users", user.uid));
      const role = snap.exists() && snap.data().role ? snap.data().role : "staff";
      if (role === "owner") migrateBtn.style.display = "inline-block";
    });

    logoutBtn.onclick = async () => {
      await signOut(auth);
      location.href = "login.html";
    };

    // Data migration (optional feature)
    migrateBtn.onclick = async () => {
      if (!confirm("This will upload your localStorage data to Firestore. Proceed?")) return;
      migrateStatus.textContent = "Migrating...";
      try {
        const staffList = JSON.parse(localStorage.getItem("staffList")) || [];
        const attendanceData = JSON.parse(localStorage.getItem("attendanceData")) || {};
        const paymentListData = JSON.parse(localStorage.getItem("paymentListData")) || {};
        const expenses = JSON.parse(localStorage.getItem("expenses")) || [];
        const categories = JSON.parse(localStorage.getItem("categories")) || [];

        // Upload staff
        for (const s of staffList) {
          await addDoc(collection(db, "staff"), {
            name: s.name,
            phone: s.phone || "",
            salary: s.salary || 0,
          });
        }

        // Upload attendance
        for (const key in attendanceData) {
          const parts = key.split("_");
          if (parts.length < 4) continue;
          const staffName = parts[0];
          const year = parseInt(parts[1]);
          const month = parseInt(parts[2]);
          const day = parseInt(parts[3]);
          const rec = attendanceData[key];
          await addDoc(collection(db, "attendance"), {
            staffName,
            year,
            month,
            day,
            status: rec.status,
            ot: rec.ot || 0,
            migratedAt: new Date().toISOString(),
          });
        }

        // Upload payments
        for (const key in paymentListData) {
          const arr = paymentListData[key] || [];
          const parts = key.split("_");
          const staffName = parts[0];
          const year = parseInt(parts[1]);
          const month = parseInt(parts[2]);
          for (const p of arr) {
            await addDoc(collection(db, "payments"), {
              staffName,
              year,
              month,
              amount: p.amount,
              date: p.date || new Date().toISOString(),
              migratedAt: new Date().toISOString(),
            });
          }
        }

        // Upload categories and expenses
        for (const c of categories) await addDoc(collection(db, "categories"), { name: c });
        for (const e of expenses) await addDoc(collection(db, "expenses"), e);

        migrateStatus.textContent = "✅ Migration complete!";
        alert("Migration successful!");
      } catch (err) {
        console.error(err);
        migrateStatus.textContent = "❌ Migration failed!";
        alert("Migration failed: " + err.message);
      }
    };
  </script>
</body>
</html>
