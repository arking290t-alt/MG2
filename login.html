<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Login | MG</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body class="login-body">
  <div class="login-container">
    <h1 class="logo">MG</h1>
    <div class="subtitle">Sign in to continue</div>

    <label>Email</label>
    <input id="email" type="email" placeholder="admin@mg.com" />

    <label>Password</label>
    <input id="password" type="password" placeholder="mg@1234" />

    <label>Role</label>
    <select id="role">
      <option value="owner">Owner</option>
      <option value="staff">Staff</option>
    </select>

    <button id="signInBtn" class="btn-login">Login</button>
    <div id="error" class="error"></div>
    <div class="small" style="margin-top:8px;color:#9fb6d4">Default admin: <strong>arking290t@gmail.com</strong> / <strong>mg@1234</strong></div>
  </div>

  <script type="module">
    // FIREBASE CONFIG (your project)
    const firebaseConfig = {
      apiKey: "AIzaSyC6BmLTjzOHwTa2VEYa9eYkClDtS__zvTM",
      authDomain: "mg-manager-3ab66.firebaseapp.com",
      projectId: "mg-manager-3ab66",
      storageBucket: "mg-manager-3ab66.firebasestorage.app",
      messagingSenderId: "330667005987",
      appId: "1:330667005987:web:95de27b6259ace9fc6b996",
      measurementId: "G-05HW0KSN38"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const signInBtn = document.getElementById("signInBtn");
    const errorEl = document.getElementById("error");

    // Attempt auto-create default admin if they try to login with default credentials
    async function tryAutoCreateAdmin(email, password) {
      try {
        await createUserWithEmailAndPassword(auth, email, password);
        const u = auth.currentUser;
        await setDoc(doc(db, "users", u.uid), {
          email,
          role: "owner",
          displayName: "admin",
          createdAt: new Date().toISOString()
        });
        return true;
      } catch (e) {
        console.warn("Auto-create admin failed:", e);
        return false;
      }
    }

    signInBtn.onclick = async () => {
      errorEl.textContent = "";
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value;
      const roleSelected = document.getElementById("role").value;
      if (!email || !password) { errorEl.textContent = "Enter email and password"; return; }

      try {
        await signInWithEmailAndPassword(auth, email, password);
        const u = auth.currentUser;
        const snapshot = await getDoc(doc(db, "users", u.uid));
        if (!snapshot.exists()) {
          // create user doc from selected role
          await setDoc(doc(db, "users", u.uid), {
            email,
            role: roleSelected,
            displayName: email.split("@")[0],
            createdAt: new Date().toISOString()
          });
        }
        // Redirect based on role stored in user doc
        const userDoc = await getDoc(doc(db, "users", u.uid));
        const role = userDoc.exists() && userDoc.data().role ? userDoc.data().role : roleSelected;
        if (role === "owner") location.href = "dashboard.html";
        else location.href = "attendance.html";
      } catch (err) {
        // If user tried default admin credentials, auto-create and login
        if (email === "arking290t@gmail.com" && password === "mg@1234") {
          const created = await tryAutoCreateAdmin(email, password);
          if (created) { location.href = "dashboard.html"; return; }
        }
        errorEl.textContent = "Login failed: " + (err.message || err);
      }
    };

    // If already logged in, route them
    onAuthStateChanged(auth, async (user) => {
      if (!user) return;
      try {
        const udoc = await getDoc(doc(db, "users", user.uid));
        const r = udoc.exists() && udoc.data().role ? udoc.data().role : "staff";
        if (r === "owner") location.href = "dashboard.html";
        else location.href = "attendance.html";
      } catch (e) { console.error(e); }
    });
  </script>
</body>
</html>
