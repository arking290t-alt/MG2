<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Used Inventory | MG</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root {
  --bg:#0b111b;
  --panel:#111822;
  --accent:#00b4ff;
  --text:#dce7f5;
  --muted:#9bb6d1;
}

body {
  background:var(--bg);
  color:var(--text);
  font-family:'Poppins',sans-serif;
  margin:0;
  padding:20px;
}

h1 {
  text-align:center;
  color:var(--accent);
  margin-bottom:20px;
}

/* FILTER BAR */
.filter-row {
  display:flex;
  gap:10px;
  justify-content:center;
  flex-wrap:wrap;
  margin-bottom:25px;
}

select, input[type="date"] {
  background:#0f1720;
  border:1px solid rgba(255,255,255,0.08);
  padding:10px 14px;
  color:var(--text);
  border-radius:8px;
}

button {
  cursor:pointer;
}

/* USED ITEM CARD */
.used-card {
  background:#0f1720;
  border:1px solid rgba(255,255,255,0.08);
  padding:16px;
  border-radius:12px;
  margin-bottom:16px;
}

.card-title {
  font-size:1.1rem;
  font-weight:600;
  color:var(--accent);
}

.btn-small {
  padding:6px 12px;
  border:none;
  border-radius:8px;
  color:white;
  font-weight:600;
}

.view-btn { background:#00a2ff; }
.delete-btn { background:#ef4444; }

/* MODAL */
.modal-back {
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.75);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
}

.modal {
  background:#111a24;
  width:90%;
  max-width:380px;
  max-height:90vh;
  overflow-y:auto;
  padding:20px;
  border-radius:14px;
  color:var(--text);
}

.modal h2 {
  color:var(--accent);
  margin-bottom:15px;
}

.modal input {
  width:100%;
  padding:10px;
  margin-bottom:12px;
  background:#0b1115;
  border:1px solid rgba(255,255,255,0.1);
  color:white;
  border-radius:8px;
}

.modal-footer {
  display:flex;
  justify-content:space-between;
  margin-top:14px;
}

.close-btn { background:#444; }
.modal-delete { background:#ef4444; }
</style>
</head>

<body>

<h1>Used Inventory History</h1>

<div class="filter-row">
  <select id="filterCategory">
    <option value="all">All Categories</option>
  </select>

  <input type="date" id="filterDate">
</div>

<div id="usedList"></div>

<!-- +++++++++++++++++ MODAL +++++++++++++++++ -->
<div class="modal-back" id="modalBack">
  <div class="modal">
    <h2>Item Details</h2>

    <input id="d_name" readonly>
    <input id="d_invoice" readonly>
    <input id="d_reel" readonly>
    <input id="d_supplier" readonly>
    <input id="d_gsm" readonly>
    <input id="d_bf" readonly>
    <input id="d_qty" readonly>
    <input id="d_unit" readonly>
    <input id="d_for" readonly>
    <input id="d_price" readonly>
    <input id="d_category" readonly>
    <input id="d_originalDate" readonly>
    <input id="d_usedDate" readonly>

    <div class="modal-footer">
      <button class="btn-small modal-delete" id="modalDelete">Delete</button>
      <button class="btn-small close-btn" id="modalClose">Close</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {
  getFirestore, collection, getDocs, deleteDoc, doc
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey:"AIzaSyC6BmLTjzOHwTa2VEYa9eYkClDtS__zvTM",
  authDomain:"mg-manager-3ab66.firebaseapp.com",
  projectId:"mg-manager-3ab66"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const usedListEl = document.getElementById("usedList");
const filterCategory = document.getElementById("filterCategory");
const filterDate = document.getElementById("filterDate");

let USED_DATA = [];
let CURRENT_ID = "";

/* ---------------- LOAD USED INVENTORY ---------------- */
async function loadUsed() {
  usedListEl.innerHTML = "<p style='text-align:center;color:#777;'>Loading...</p>";

  const snap = await getDocs(collection(db,"usedInventory"));
  USED_DATA = snap.docs.map(d => ({ id:d.id, ...d.data() }));

  populateFilterCategories();
  renderUsedList();
}

/* ---------------- CATEGORY FILTER SETUP ---------------- */
function populateFilterCategories() {
  const cats = [...new Set(USED_DATA.map(i => i.category))];

  filterCategory.innerHTML = `<option value="all">All Categories</option>`;
  cats.forEach(c=>{
    filterCategory.innerHTML += `<option value="${c}">${c}</option>`;
  });
}

/* ---------------- RENDER USED ITEMS ---------------- */
function renderUsedList() {
  usedListEl.innerHTML = "";

  const fCat = filterCategory.value;
  const fDate = filterDate.value;

  const filtered = USED_DATA.filter(i=>{
    let ok = true;

    if (fCat !== "all" && i.category !== fCat) ok = false;
    if (fDate && i.usedDate && !i.usedDate.startsWith(fDate)) ok = false;

    return ok;
  });

  if (filtered.length === 0) {
    usedListEl.innerHTML = "<p style='text-align:center;color:#666;'>No used items found.</p>";
    return;
  }

  filtered.forEach(item=>{
    const div = document.createElement("div");
    div.className = "used-card";

    div.innerHTML = `
      <div class="card-title">${item.name}</div>
      <div style="margin-top:4px;">
        Used: ${item.usedAmount} ${item.unit}<br>
        For: ${item.usedFor}<br>
        At: ${item.usedDate}
      </div>

      <div style="margin-top:12px; display:flex; gap:10px;">
        <button class="btn-small view-btn" onclick="viewDetails('${item.id}')">View Details</button>
        <button class="btn-small delete-btn" onclick="deleteUsed('${item.id}')">Delete</button>
      </div>
    `;

    usedListEl.appendChild(div);
  });
}

/* ---------------- VIEW DETAILS MODAL ---------------- */
window.viewDetails = function(id) {
  const item = USED_DATA.find(x => x.id === id);
  CURRENT_ID = id;

  document.getElementById("d_name").value = item.name;
  document.getElementById("d_invoice").value = item.invoice;
  document.getElementById("d_reel").value = item.reel;
  document.getElementById("d_supplier").value = item.supplier;
  document.getElementById("d_gsm").value = item.gsm;
  document.getElementById("d_bf").value = item.bf;
  document.getElementById("d_qty").value = item.usedAmount;
  document.getElementById("d_unit").value = item.unit;
  document.getElementById("d_for").value = item.usedFor;
  document.getElementById("d_price").value = item.price;
  document.getElementById("d_category").value = item.category;
  document.getElementById("d_originalDate").value = item.date;
  document.getElementById("d_usedDate").value = item.usedDate;

  document.getElementById("modalBack").style.display = "flex";
};

/* ---------------- DELETE FROM MODAL ---------------- */
document.getElementById("modalDelete").onclick = async ()=>{
  if (!confirm("Delete this used record?")) return;

  await deleteDoc(doc(db,"usedInventory",CURRENT_ID));
  document.getElementById("modalBack").style.display = "none";
  loadUsed();
};

/* CLOSE MODAL */
document.getElementById("modalClose").onclick = ()=>{
  document.getElementById("modalBack").style.display = "none";
};

/* DELETE BUTTON OUTSIDE MODAL */
window.deleteUsed = async function(id) {
  if (!confirm("Delete this used item?")) return;
  await deleteDoc(doc(db,"usedInventory",id));
  loadUsed();
};

filterCategory.onchange = renderUsedList;
filterDate.onchange = renderUsedList;

loadUsed();
</script>

</body>
</html>
