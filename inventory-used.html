<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Used Inventory | MG</title>

  <style>
    :root {
      --bg:#0b111b;
      --accent:#00b4ff;
      --panel:#0e1724;
      --muted:#9aa9b6;
      --card:#0f1417;
      --danger:#ef4444;
    }
    body { background:var(--bg); color:var(--muted); font-family:Poppins, sans-serif; margin:0; padding:28px; }
    h1 { text-align:center; color:var(--accent); margin:6px 0 22px; font-size:2rem; }
    .top { text-align:center; margin-bottom:16px; }
    .back-btn { background:#0ea5a0; color:#041014; padding:8px 12px; border-radius:8px; border:none; cursor:pointer; font-weight:700; }
    .filters { display:flex; gap:12px; justify-content:center; align-items:center; margin:14px 0; flex-wrap:wrap; }
    select, input[type="month"] {
      background:#10151a; color:var(--muted); border:1px solid rgba(255,255,255,0.06);
      padding:10px 12px; border-radius:8px; outline:none;
    }
    .container { max-width:1000px; margin:10px auto; }
    .used-card {
      background:var(--card); padding:14px; border-radius:10px; margin-bottom:12px;
      border:1px solid rgba(255,255,255,0.03); display:flex; justify-content:space-between; align-items:flex-start;
      color:#e6f2ff;
    }
    .used-left { line-height:1.45; max-width:75%; }
    .used-right { display:flex; gap:8px; align-items:center; }
    .small-btn { padding:8px 12px; border-radius:8px; border:none; cursor:pointer; font-weight:700; }
    .btn-view { background:#60a5fa; color:#021022; }
    .btn-delete { background:var(--danger); color:white; }
    /* modal */
    .modal-back { position:fixed; inset:0; background:rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center; z-index:9999; }
    .modal { background:#0f1720; width:420px; padding:18px; border-radius:10px; color:var(--muted); box-shadow:0 14px 40px rgba(0,0,0,0.6); }
    .modal h3 { color:var(--accent); margin:0 0 12px; }
    .field { margin-bottom:10px; }
    .field label { display:block; font-size:0.85rem; color:var(--muted); margin-bottom:6px; }
    .field input, .field select { width:100%; padding:10px; border-radius:8px; background:#0b1115; border:1px solid rgba(255,255,255,0.04); color:#dbeafc; }
    .modal .actions { display:flex; justify-content:space-between; gap:8px; margin-top:12px; }
    .modal .actions .left { display:flex; gap:8px; }
    .muted-small { color:#9aa9b6; font-size:0.9rem; }
    @media (max-width:520px){ .modal{width:92%} }
  </style>
</head>
<body>

  <h1>Used Inventory History</h1>

  <div class="top">
    <a href="inventory.html"><button class="back-btn">Back to Inventory</button></a>
  </div>

  <div class="container">
    <div class="filters">
      <select id="filterByCategory">
        <option value="all">All Categories</option>
      </select>

      <input id="filterByMonth" type="month" />
    </div>

    <div id="usedList"></div>
  </div>

  <!-- Modal: View Details (read-only) -->
  <div class="modal-back" id="modalBack">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <h3 id="modalTitle">Item Details</h3>

      <div class="field">
        <label>Item Name</label>
        <input id="v_name" readonly />
      </div>

      <div class="field">
        <label>Invoice Number</label>
        <input id="v_invoice" readonly />
      </div>

      <div class="field">
        <label>Reel Number</label>
        <input id="v_reel" readonly />
      </div>

      <div class="field">
        <label>Supplier</label>
        <input id="v_supplier" readonly />
      </div>

      <div class="field">
        <label>GSM</label>
        <input id="v_gsm" readonly />
      </div>

      <div class="field">
        <label>BF</label>
        <input id="v_bf" readonly />
      </div>

      <div class="field">
        <label>Used Quantity</label>
        <input id="v_usedAmount" readonly />
      </div>

      <div class="field">
        <label>Unit</label>
        <input id="v_unit" readonly />
      </div>

      <div class="field">
        <label>Used For</label>
        <input id="v_usedFor" readonly />
      </div>

      <div class="field">
        <label>Original Purchase Price (â‚¹)</label>
        <input id="v_price" readonly />
      </div>

      <div class="field">
        <label>Category</label>
        <input id="v_category" readonly />
      </div>

      <div class="field">
        <label>Original Date</label>
        <input id="v_date" readonly />
      </div>

      <div class="field">
        <label>Used At</label>
        <input id="v_usedAt" readonly />
      </div>

      <div class="actions">
        <div class="left">
          <button id="modalDelete" class="small-btn btn-delete">Delete</button>
        </div>
        <div class="right">
          <button id="modalClose" class="small-btn" style="background:#333;color:#fff">Close</button>
        </div>
      </div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
  import { getFirestore, collection, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC6BmLTjzOHwTa2VEYa9eYkClDtS__zvTM",
    authDomain: "mg-manager-3ab66.firebaseapp.com",
    projectId: "mg-manager-3ab66",
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const usedList = document.getElementById('usedList');
  const filterByCategory = document.getElementById('filterByCategory');
  const filterByMonth = document.getElementById('filterByMonth');

  const modalBack = document.getElementById('modalBack');
  const modalClose = document.getElementById('modalClose');
  const modalDelete = document.getElementById('modalDelete');

  // modal fields
  const v_name = document.getElementById('v_name');
  const v_invoice = document.getElementById('v_invoice');
  const v_reel = document.getElementById('v_reel');
  const v_supplier = document.getElementById('v_supplier');
  const v_gsm = document.getElementById('v_gsm');
  const v_bf = document.getElementById('v_bf');
  const v_usedAmount = document.getElementById('v_usedAmount');
  const v_unit = document.getElementById('v_unit');
  const v_usedFor = document.getElementById('v_usedFor');
  const v_price = document.getElementById('v_price');
  const v_category = document.getElementById('v_category');
  const v_date = document.getElementById('v_date');
  const v_usedAt = document.getElementById('v_usedAt');

  let currentUsedId = null;
  let currentUsedRecord = null;

  // load category filter options
  async function loadFilters(){
    filterByCategory.innerHTML = `<option value="all">All Categories</option>`;
    const catSnap = await getDocs(collection(db, "inventoryCategories"));
    catSnap.forEach(c => {
      const name = c.data().name;
      filterByCategory.innerHTML += `<option value="${name}">${name}</option>`;
    });
  }

  // load used records and render
  async function loadUsed(){
    usedList.innerHTML = '';
    const catFilter = filterByCategory.value;
    const monthFilter = filterByMonth.value; // YYYY-MM

    const snap = await getDocs(collection(db, 'inventoryUsed'));
    const arr = [];
    snap.forEach(d => arr.push({ id: d.id, ...d.data() }));

    // sort newest first by usedAt
    arr.sort((a,b) => (b.usedAt || '').localeCompare(a.usedAt || ''));

    arr.forEach(rec => {
      // filter by category if record has category property
      if (catFilter !== 'all' && rec.category && rec.category !== catFilter) return;

      // filter by month using usedAt (ISO) or usedAt fallback
      if (monthFilter) {
        const usedAt = rec.usedAt || '';
        if (!usedAt.startsWith(monthFilter)) return;
      }

      const card = document.createElement('div');
      card.className = 'used-card';

      const left = document.createElement('div');
      left.className = 'used-left';
      left.innerHTML = `<strong style="color:#fff">${rec.name || '-'}</strong><br>
                        Used: ${rec.usedAmount ?? '-'} ${rec.unit || ''}<br>
                        For: ${rec.usedFor || '-'}<br>
                        At: ${rec.usedAt ? new Date(rec.usedAt).toLocaleString() : '-'}`;

      const right = document.createElement('div');
      right.className = 'used-right';

      const viewBtn = document.createElement('button');
      viewBtn.className = 'small-btn btn-view';
      viewBtn.innerText = 'View Details';
      viewBtn.onclick = () => openModal(rec.id, rec);

      const delBtn = document.createElement('button');
      delBtn.className = 'small-btn btn-delete';
      delBtn.innerText = 'Delete';
      delBtn.onclick = () => confirmDeleteUsed(rec.id);

      right.appendChild(viewBtn);
      right.appendChild(delBtn);

      card.appendChild(left);
      card.appendChild(right);

      usedList.appendChild(card);
    });
  }

  function openModal(id, rec){
    // store current record
    currentUsedId = id;
    currentUsedRecord = rec || null;

    // show all details (if not present, show '-')
    v_name.value = rec?.name ?? '-';
    v_invoice.value = rec?.invoice ?? '-';
    v_reel.value = rec?.reel ?? '-';
    v_supplier.value = rec?.supplier ?? '-';
    v_gsm.value = (typeof rec?.gsm !== 'undefined' && rec?.gsm !== null) ? rec.gsm : '-';
    v_bf.value = (typeof rec?.bf !== 'undefined' && rec?.bf !== null) ? rec.bf : '-';
    v_usedAmount.value = (rec?.usedAmount ?? '-') + ' ' + (rec?.unit ?? '');
    v_unit.value = rec?.unit ?? '-';
    v_usedFor.value = rec?.usedFor ?? '-';
    v_price.value = rec?.price ?? '-';
    v_category.value = rec?.category ?? '-';
    v_date.value = rec?.date ?? '-';
    v_usedAt.value = rec?.usedAt ? new Date(rec.usedAt).toLocaleString() : '-';

    modalBack.style.display = 'flex';
  }

  modalClose.onclick = () => {
    modalBack.style.display = 'none';
    currentUsedId = null;
    currentUsedRecord = null;
  };

  // delete used record (confirm)
  async function confirmDeleteUsed(id){
    if(!confirm('Delete this used record? This will NOT restore inventory.')) return;
    await deleteDoc(doc(db, 'inventoryUsed', id));
    await loadUsed();
    if(modalBack.style.display === 'flex') modalBack.style.display = 'none';
  }

  modalDelete.onclick = async () => {
    if(!currentUsedId) return;
    if(!confirm('Delete this used record? This will NOT restore inventory.')) return;
    await deleteDoc(doc(db, 'inventoryUsed', currentUsedId));
    modalBack.style.display = 'none';
    currentUsedId = null;
    currentUsedRecord = null;
    await loadUsed();
  };

  filterByCategory.onchange = loadUsed;
  filterByMonth.onchange = loadUsed;

  // initialize
  await loadFilters();
  await loadUsed();
</script>
</body>
</html>
