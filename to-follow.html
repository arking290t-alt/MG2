<script>
const KEY="followClients";
let selectedId=null;

const get=()=>JSON.parse(localStorage.getItem(KEY))||[];
const set=v=>localStorage.setItem(KEY,JSON.stringify(v));

function addClient(){
  const c=company.value.trim();
  const n=client.value.trim();
  const j=job.value.trim();
  const d=date.value;

  if(!c||!n||!j||!d){
    alert("Fill required fields");
    return;
  }

  const data=get();

  data.push({
    id: Date.now(),          // âœ… UNIQUE ID
    company:c,
    name:n,
    phone:phone.value,
    job:j,
    date:d,
    status:"follow"
  });

  set(data);
  company.value=client.value=phone.value=job.value=date.value="";
  render();
}

function render(){
  const box=list;
  const data=get().filter(x=>x.status==="follow");
  box.innerHTML=data.length?"":"<p class='empty'>No clients</p>";

  data.forEach(x=>{
    box.innerHTML+=`
      <div class="row">
        <div>${x.company}</div>
        <div>${x.name}</div>
        <div>${x.phone||"-"}</div>
        <div>${x.job}</div>
        <div>${x.date}</div>
        <div>
          <button class="btn view" onclick='view(${JSON.stringify(x)})'>View</button>
          <button class="btn done" onclick="markDone(${x.id})">Completed</button>
          <button class="btn not" onclick="markNot(${x.id})">Not</button>
          <button class="btn del" onclick="del(${x.id})">Delete</button>
        </div>
      </div>`;
  });
}

function view(x){
  viewData.innerHTML=`
    <p><b>Company:</b> ${x.company}</p>
    <p><b>Name:</b> ${x.name}</p>
    <p><b>Phone:</b> ${x.phone||"-"}</p>
    <p><b>Job:</b> ${x.job}</p>
    <p><b>Date:</b> ${x.date}</p>
  `;
  viewModal.style.display="flex";
}

/* ---------- STATUS CHANGES ---------- */

function markDone(id){
  const data=get();
  const item=data.find(x=>x.id===id);
  if(!item) return;

  // ask questions
  const by=prompt("Completed by?");
  if(!by) return;

  const amt=prompt("Amount?");
  if(!amt) return;

  item.status="completed";
  item.completedBy=by;
  item.amount=amt;
  item.completedDate=new Date().toISOString().split("T")[0];

  set(data);
  render();
}

function markNot(id){
  selectedId=id;
  remarkModal.style.display="flex";
}

function saveNotCompleted(){
  const data=get();
  const item=data.find(x=>x.id===selectedId);
  if(!item) return;

  item.status="not";
  item.remark=remark.value;

  set(data);
  remark.value="";
  closeModal();
  render();
}

function del(id){
  if(!confirm("Delete client?"))return;
  let data=get();
  data=data.filter(x=>x.id!==id);
  set(data);
  render();
}

function closeModal(){
  viewModal.style.display="none";
  remarkModal.style.display="none";
}

render();
</script>
